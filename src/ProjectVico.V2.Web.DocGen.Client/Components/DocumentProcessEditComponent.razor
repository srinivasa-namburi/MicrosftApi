@using ProjectVico.V2.Shared.Enums
@inject IDocumentProcessApiClient DocumentProcessApiClient
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudTextField @bind-Value="_process.ShortName" Label="Short Name" Disabled="_isEditMode" OnBlur="ComputeIndexName" />
        <MudTextField @bind-Value="_process.Description" Label="Description" />
        <MudTextField @bind-Value="_process.BlobStorageContainerName" Label="Blob Storage Container Name" />
        <MudTextField @bind-Value="_process.BlobStorageAutoImportFolderName" Label="Auto Import Folder Name" />
        <MudTextField @bind-Value="_indexName" Label="Repository Index Name" Disabled="_isEditMode" OnBlur="UpdateRepositories" />
        <MudCheckBox T="bool" Label="Classify Documents" ValueChanged="@(e => OnClassifyDocumentsCheckboxChanged(e))" />

        @if (_process.ClassifyDocuments)
        {
            <MudTextField @bind-Value="_process.ClassificationModelName" Label="Classification Model Name" />
        }

        <MudDivider />

        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveProcess">Save</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>

        @if (_isEditMode && _process.Source == ProcessSource.Dynamic)
        {
            <MudDivider Class="my-4" />

            <MudExpansionPanels>
                <MudExpansionPanel Text="Prompts">
                    <PromptList Prompts="_prompts" OnPromptEdited="ReloadPrompts" ProcessId="@_process.Id" />
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public Guid? ProcessId { get; set; }
    [Parameter] public EventCallback OnProcessSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private DocumentProcessInfo? _process = new();
    private bool _isEditMode => ProcessId != null;
    private List<PromptInfo> _prompts = new();
    private string _indexName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (_isEditMode)
        {
            if (ProcessId != null)
            {
                _process = await DocumentProcessApiClient.GetDocumentProcessInfoByIdAsync(ProcessId);

                if (_process.Source == ProcessSource.Dynamic)
                {
                    _prompts = await DocumentProcessApiClient.GetPromptsByProcessIdAsync(_process.Id);
                }

                if (_process.Repositories.Any())
                {
                    _indexName = _process.Repositories.First();
                }
            }
        }
    }

    private async Task SaveProcess()
    {
        UpdateRepositories();
        if (_isEditMode)
        {
            await DocumentProcessApiClient.UpdateDynamicDocumentProcessDefinitionAsync(_process);
        }
        else
        {
            await DocumentProcessApiClient.CreateDynamicDocumentProcessDefinitionAsync(_process);
        }
        await OnProcessSaved.InvokeAsync();
    }

    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
    }

    private async Task ReloadPrompts()
    {
        if (_isEditMode && _process.Source == ProcessSource.Dynamic)
        {
            _prompts = await DocumentProcessApiClient.GetPromptsByProcessIdAsync(_process.Id);
            StateHasChanged();
        }
    }

    private void ComputeIndexName()
    {
        if (!_isEditMode && string.IsNullOrWhiteSpace(_indexName))
        {
            _indexName = "index-" + _process.ShortName.ToLower()
                                            .Replace(" ", "-")
                                            .Replace(".", "-");
        }
    }

    private void UpdateRepositories()
    {
        _process.Repositories.Clear();
        _process.Repositories.Add(_indexName);
    }

    private void OnClassifyDocumentsCheckboxChanged(bool value)
    {
        _process.ClassifyDocuments = value;
        if (!value)
        {
            _process.ClassificationModelName = string.Empty;
        }
    }

}
