@inject IDocumentProcessApiClient DocumentProcessApiClient
@inject IDialogService DialogService

<MudTable Items="Prompts" Hover="true" Striped="true">
    <HeaderContent>
        <MudTh>Short Code</MudTh>
        <MudTh>Description</MudTh>
        <MudTh>Text</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.ShortCode</MudTd>
        <MudTd>@context.Description</MudTd>
        <MudTd>@context.Text</MudTd>
        <MudTd>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="() => EditPrompt(context)">Edit</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="() => DeletePrompt(context)">Delete</MudButton>
        </MudTd>
    </RowTemplate>
</MudTable>

<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddPrompt">Add New Prompt</MudButton>

@code {
    [Parameter] public List<PromptInfo> Prompts { get; set; } = new();
    [Parameter] public EventCallback OnPromptEdited { get; set; }
    [Parameter] public Guid ProcessId { get; set; }

    private async Task AddPrompt()
    {
        var newPrompt = new PromptInfo { DocumentProcessId = ProcessId };
        await ShowEditPromptDialog(newPrompt, false);
    }

    private async Task EditPrompt(PromptInfo prompt)
    {
        var promptInfo = await DocumentProcessApiClient.GetPromptByIdAsync(prompt.Id);
        await ShowEditPromptDialog(promptInfo, true);
    }

    private async Task DeletePrompt(PromptInfo prompt)
    {
        await DocumentProcessApiClient.DeletePromptAsync(prompt.Id);
        await OnPromptEdited.InvokeAsync();
    }

    private async Task ShowEditPromptDialog(PromptInfo prompt, bool isEditMode)
    {
        var parameters = new DialogParameters
        {
            { nameof(EditPromptDialog.Prompt), prompt },
            { nameof(EditPromptDialog.IsEditMode), isEditMode },
            { nameof(EditPromptDialog.OnPromptSaved), EventCallback.Factory.Create(this, OnPromptEdited) }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };

        DialogService.Show<EditPromptDialog>(isEditMode ? "Edit Prompt" : "Add Prompt", parameters, options);
    }

    private async Task OnPromptSaved()
    {
        await OnPromptEdited.InvokeAsync();
    }
}
