@page "/mass-document-creation"
@using System.Text.Json;
@using ProjectVico.V2.Shared.Configuration;
@using ProjectVico.V2.Web.Shared.ServiceClients;
@using ProjectVico.V2.Shared.Contracts.DTO;
@using CsvHelper;
@using System.Globalization;
@using Microsoft.Extensions.Options;
@inject IDocumentGenerationApiClient DocumentGenerationApiClient;
@inject NavigationManager Navigation;
@inject IDialogService DialogService;
@inject IOptions<ServiceConfigurationOptions> ServiceConfigurationOptionsSelector;

<PageTitle>Mass Documents Creation</PageTitle>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h4">Upload CSV File</MudText>
    <InputFile OnChange="OnFileChange" />
</MudPaper>

@if (csvContent.Any())
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
        <MudTable Items="csvContent.Skip(1).Select((value, index) => new { value, index })" Hover="true" Bordered="true" Striped="true">
            <HeaderContent>
                <MudTh Class="my-header">Select</MudTh> <!-- Empty header for the select checkbox -->
                @foreach (var header in csvContent.First())
                {
                    <MudTh>@header</MudTh>
                }
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudCheckBox Value="@IsSelected(context.index)" ValueChanged="@((bool value) => ToggleSelection(context.index, value))" />
                </MudTd>
                @foreach (var cell in context.value)
                {
                    <MudTd>@cell</MudTd>
                }
            </RowTemplate>
        </MudTable>
        <MudButton OnClick="GenerateDocuments" Disabled="@(selectedRows.Count == 0)" Class="mt-4">Generate Documents</MudButton>
    </MudContainer>
}

@code {
    private List<string[]> csvContent = new List<string[]>();
    private HashSet<int> selectedRows = new HashSet<int>();

    private DocumentGenerationRequest documentGenerationRequest = new DocumentGenerationRequest
        {
            DocumentProcessName = null,
            DocumentTitle = null,
            AuthorOid = null,
            Id = null
        };

    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        if (e is null)
        {
            throw new ArgumentNullException(nameof(e));
        }

        var file = e.File;
        if (file != null)
        {
            try
            {
                using var stream = file.OpenReadStream();
                using var reader = new StreamReader(stream);
                var config = new CsvHelper.Configuration.CsvConfiguration(CultureInfo.InvariantCulture)
                    {
                        Delimiter = ",",
                        NewLine = Environment.NewLine,
                        BadDataFound = null // Ignore bad data
                    };
                using var csv = new CsvReader(reader, config);
                var records = new List<string[]>();

                // Read the header row
                if (await csv.ReadAsync())
                {
                    csv.ReadHeader();
                    var headerRow = csv.HeaderRecord;
                    if (headerRow != null)
                    {
                        records.Add(headerRow);
                    }
                }

                // Read the data rows
                while (await csv.ReadAsync())
                {
                    var record = csv.GetRecord<dynamic>();
                    var values = ((IDictionary<string, object>)record).Values.Select(v => v?.ToString() ?? string.Empty).ToArray();
                    records.Add(values);
                }
                csvContent = records;
            }
            catch (Exception ex)
            {
                // Handle the exception (e.g., show an error message)
                await DialogService.ShowMessageBox("Error", $"Failed to read CSV file: {ex.Message}");
            }
        }
    }

    private bool IsSelected(int index)
    {
        return selectedRows.Contains(index);
    }

    private void ToggleSelection(int index, bool isChecked)
    {
        if (isChecked)
        {
            selectedRows.Add(index);
        }
        else
        {
            selectedRows.Remove(index);
        }
    }
    private async Task GenerateDocuments()
    {
        bool allDocumentsGeneratedSuccessfully = true;

        foreach (var rowindex in selectedRows)
        {
            var row = csvContent[rowindex + 1]; // Adjust for the skipped header row

            var metadataDictionary = new Dictionary<string, string>();

            for (int i = 0; i < csvContent[0].Length; i++)

            {
                metadataDictionary.Add(csvContent[0][i], row[i]);
            }

            try
            {
                await DocumentGenerationApiClient.GenerateDocumentAsync(new GenerateDocumentDTO
                    {
                        DocumentProcessName = row[0],
                        Id = new Guid(row[1]),
                        DocumentTitle = row[2],
                        AuthorOid = null,
                        RequestAsJson = JsonSerializer.Serialize(metadataDictionary)
                    });
                // Optionally, show a success message or navigate to another page
                await DialogService.ShowMessageBox("Success", "Documents generated successfully.");
            }
            catch (Exception ex)
            {
                // Handle the exception (e.g., show an error message)
                allDocumentsGeneratedSuccessfully = false;
                await DialogService.ShowMessageBox("Error", $"Failed to generate documents: {ex.Message}");
            }
        }
    //     var generateDocumentDto = selectedRows.Select(index => csvContent[index + 1]).ToList();

        if (allDocumentsGeneratedSuccessfully)

        {
            await DialogService.ShowMessageBox("Success", "Documents generated successfully.");
        }
    }
}