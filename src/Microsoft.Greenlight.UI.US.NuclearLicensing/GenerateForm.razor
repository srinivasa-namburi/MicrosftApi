@attribute [Authorize]
@using System.Text.Json;
@using Microsoft.Greenlight.Shared.Contracts.DTO
@using Microsoft.Greenlight.Web.Shared.ServiceClients
@using Microsoft.Greenlight.Shared.Configuration

@inject NavigationManager Navigation
@inject IDocumentGenerationApiClient DocumentGenerationApiClient
@inject IOptions<ServiceConfigurationOptions> ServiceConfigurationOptionsSelector


@code {
    [Parameter]
    public string? DocumentProcessName { get; set; }

    private readonly DocumentGenerationRequestUSNuclearLicensing documentGenerationRequest = new DocumentGenerationRequestUSNuclearLicensing
    {
        Location = new LocationInformation
        {
            Latitude = 47.6740,
            Longitude = -122.1215,
        },
    };
    private bool showGeneratedDocument = false;
    private ServiceConfigurationOptions ServiceConfigurationOptions => ServiceConfigurationOptionsSelector.Value;

    private MudForm documentGenerationRequestForm;
    private DocumentGenerationRequestFluentValidator documentGenerationRequestValidator = new DocumentGenerationRequestFluentValidator();
}

<PageTitle>Generate New Environmental Report</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Generate New Environmental Report (US)</MudText>
<MudText Typo="Typo.body1" Class="mb-4" GutterBottom="true">To start the document generation process, please fill in as much detail as you can about your project in the following form.</MudText>
    <MudForm Model="@documentGenerationRequest" @ref="@documentGenerationRequestForm" Validation="@(documentGenerationRequestValidator.ValidateValue)" ValidationDelay="0">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Report Information</MudText>
                <MudTextField @bind-Value="documentGenerationRequest.DocumentTitle"
                              For="@(() => documentGenerationRequest.DocumentTitle)"
                              Immediate="true"
                              Label="Document title"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Enter a working title for your document." />
            </MudCardContent>
            <MudCardContent>
                <MudText Typo="Typo.h6">Plant Details</MudText>
                <MudTextField @bind-Value="documentGenerationRequest.PlantName"
                              For="@(() => documentGenerationRequest.PlantName)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Plant name"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Enter the full name of your plant (e.g., ABC Power Plant)." />

                <MapComponent @bind-DocumentGenerationRequestLocation="documentGenerationRequest.Location" />

                <MudSelect T="string" 
                    Label="Plant design" 
                    Variant="Variant.Filled" 
                    Margin="Margin.Normal" 
                    MultiSelection="true" 
                    @bind-SelectedValues="documentGenerationRequest.PlantDesign" 
                    AnchorOrigin="Origin.BottomCenter">
                    @foreach (var plantDesign in plantDesignTypes)
                    {
                        <MudSelectItem T="string" Value="@plantDesign">@plantDesign</MudSelectItem>
                    }
                </MudSelect>

                <MudTextField @bind-Value="documentGenerationRequest.OperatingHistory"
                              For="@(() => documentGenerationRequest.OperatingHistory)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Operating history"
                              Lines="4"
                              AutoGrow="true"
                              MaxLines="8"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Provide a brief history of your plantâ€™s operation, including operational dates, outages, and any significant performance data." />
            </MudCardContent>
            <MudCardContent>
                <MudText Typo="Typo.h6">Proposed Changes</MudText>
                <MudTextField @bind-Value="documentGenerationRequest.ReactorModel"
                              For="@(() => documentGenerationRequest.ReactorModel)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Reactor model"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"  />

                <MudStack Row="true">
                    <MudDatePicker 
                        Label="Projected project start date" 
                        Editable="true" @bind-Value="documentGenerationRequest.ProjectedProjectStartDate" 
                        Variant="Variant.Filled" 
                        Margin="Margin.Normal" />
                    <MudDatePicker 
                        Label="Projected project end date" 
                        Editable="true" @bind-Value="documentGenerationRequest.ProjectedProjectEndDate" 
                        Variant="Variant.Filled" 
                        Margin="Margin.Normal" />
                </MudStack>


                <MudTextField @bind-Value="documentGenerationRequest.ModificationDescription"
                              For="@(() => documentGenerationRequest.ModificationDescription)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Modification description"
                              Lines="4"
                              AutoGrow="true"
                              MaxLines="8"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Describe the proposed changes in detail. Include the purpose, scope, and impact on safety, security, and environmental aspects." />

            </MudCardContent>
            <MudCardContent>
                <MudText Typo="Typo.h6">Licensee Information</MudText>
                <MudTextField @bind-Value="documentGenerationRequest.Name"
                              For="@(() => documentGenerationRequest.Name)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Name"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal" />

                <MudStack Row="true">
                    <MudTextField @bind-Value="documentGenerationRequest.Email"
                                  For="@(() => documentGenerationRequest.Email)"
                                  Immediate="true"
                                  OnlyValidateIfDirty="true"
                                  Label="Email"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Normal" />

                    <MudTextField @bind-Value="documentGenerationRequest.PhoneNumber"
                                  For="@(() => documentGenerationRequest.PhoneNumber)"
                                  Immediate="true"
                                  OnlyValidateIfDirty="true"
                                  Label="Phone number"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Normal" />
                </MudStack>

                <MudTextField @bind-Value="documentGenerationRequest.OrganizationalStructure"
                              For="@(() => documentGenerationRequest.OrganizationalStructure)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Organizational structure"
                              Lines="4"
                              AutoGrow="true"
                              MaxLines="8"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Describe the organizational structure of your company or organization. Include roles and responsibilities related to nuclear operations." />

                <MudSelect T="string" 
                    Label="Financial assurance" 
                    Variant="Variant.Filled" 
                    Margin="Margin.Normal" 
                    MultiSelection="false" 
                    @bind-SelectedValues="documentGenerationRequest.FinancialAssurance"
                           AnchorOrigin="Origin.BottomCenter"
                           HelperText="Select the type of financial assurance you have in place.">
                    @foreach (var financialAssurance in financialAssuranceTypes)
                    {
                        <MudSelectItem T="string" Value="@financialAssurance">@financialAssurance</MudSelectItem>
                    }
                </MudSelect>

                <MudTextField @bind-Value="documentGenerationRequest.ExperienceAndQualifications"
                              For="@(() => documentGenerationRequest.ExperienceAndQualifications)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Experience and qualifications"
                              Lines="4"
                              AutoGrow="true"
                              MaxLines="8"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Describe the relevant expertise and qualifications of key personnel involved in nuclear operations." />
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick=ReportSubmitClick>Generate Report</MudButton>
            </MudCardActions>
        </MudCard>
    </MudForm>

@code {

    private readonly string[] financialAssuranceTypes =
    [
        "Self-assurance", "Third-party assurance"
    ];

    private readonly string[] plantDesignTypes =
    [
        "Light-water reactor", "Pressurized water reactor", "Boiling water reactor"
    ];

    // ---------------------- BUTTON CLICKS ------------------------------------------------------------------------

    private async Task ReportSubmitClick()
    {
        showGeneratedDocument = true;
        documentGenerationRequest.Id = Guid.NewGuid();

        // Set the projected start date from the date picker (convert DateTime to DateOnly)

        if (string.IsNullOrEmpty(documentGenerationRequest.DocumentTitle))
        {
            documentGenerationRequest.DocumentTitle = $@"Environmental Report + {documentGenerationRequest.Id.ToString()}";
        }

        if (string.IsNullOrEmpty(documentGenerationRequest.ReactorModel))
        {
            documentGenerationRequest.ReactorModel = "N/A";
        }

        var generateDocumentDto = new GenerateDocumentDTO
        {
            DocumentProcessName = documentGenerationRequest.DocumentProcessName,
            DocumentTitle = documentGenerationRequest.DocumentTitle,
            AuthorOid = documentGenerationRequest.AuthorOid,
            Id = documentGenerationRequest.Id,
            RequestAsJson = JsonSerializer.Serialize(documentGenerationRequest)
        };

        await DocumentGenerationApiClient.GenerateDocumentAsync(generateDocumentDto);
        await InvokeAsync(StateHasChanged);

        // animate button with spinner

        Navigation.NavigateTo($"/docs/{documentGenerationRequest.Id}");
    }



    // ---------------------- INPUT VALIDATION ------------------------------------------------------------------------

    /// <summary>
    /// A standard AbstractValidator which contains multiple rules and can be shared with the back end API
    /// </summary>
    /// <typeparam name="DocumentGenerationRequest"></typeparam>
    public class DocumentGenerationRequestFluentValidator : AbstractValidator<DocumentGenerationRequestUSNuclearLicensing>
    {
        public DocumentGenerationRequestFluentValidator()
        {
            // Report Information rules
            RuleFor(x => x.DocumentTitle)
                .NotEmpty()
                .Length(1, 100)
                .WithName("Document title");

            // Plant Details rules
            RuleFor(x => x.PlantName)
                .NotEmpty();

            RuleFor(x => x.Name)
                .NotEmpty()
                .Length(1, 100);

            RuleFor(x => x.Email)
                .Cascade(CascadeMode.Stop)
                .NotEmpty()
                .EmailAddress()
                .MustAsync(async (value, cancellationToken) => await IsUniqueAsync(value));

            //  RuleFor(x => x.CCNumber)
            //  .NotEmpty()
            // .Length(1, 100)
            // .CreditCard();
        }

        private async Task<bool> IsUniqueAsync(string email)
        {
            // Simulates a long running http call
            await Task.Delay(2000);
            return email.ToLower() != "test@test.com";
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<DocumentGenerationRequestUSNuclearLicensing>.CreateWithOptions((DocumentGenerationRequestUSNuclearLicensing)model, x => x.IncludeProperties(propertyName)));
            if (result.IsValid)
                return Array.Empty<string>();
            return result.Errors.Select(e => e.ErrorMessage);
        };
    }


}
