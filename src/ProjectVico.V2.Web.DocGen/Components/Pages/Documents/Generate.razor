@attribute [Authorize]
@page "/generate"
@page "/{DocumentProcessNameQueryParameter}/generate"
@using System.Text
@using Microsoft.Extensions.Options
@using ProjectVico.V2.Shared.Configuration
@using ProjectVico.V2.Web.Shared
@inject NavigationManager Navigation
@inject IOptions<ServiceConfigurationOptions> ServiceConfigurationOptionsSelector
@inject DynamicComponentResolver DynamicComponentResolver

<DynamicComponent Type=@GetComponentType() />

@code {
    [Parameter] 
    public string? DocumentProcessNameQueryParameter { get; set; }
    
    private readonly string ComponentName = "GenerateForm";
    private ServiceConfigurationOptions ServiceConfigurationOptions => ServiceConfigurationOptionsSelector.Value;

    protected override async Task OnInitializedAsync()
    {
        if (DocumentProcessNameQueryParameter is null)
        {
            Navigation.NavigateTo("/US.NuclearLicensing/generate", forceLoad: true);
        }
    }

    private Type? GetComponentType()
    {
        if (DocumentProcessNameQueryParameter is not null)
        {

            // The DocumentProcessNameDashed will be camelCase, so we need to convert it to PascalCase. Also change dashes to periods.
            var documentProcessName = ToPascalCase(DocumentProcessNameQueryParameter.Replace("-", "."));

            // Check if the document process exists
            var documentProcess = ServiceConfigurationOptions.ProjectVicoServices.DocumentProcesses.FirstOrDefault(x => x.Name == documentProcessName);
            
            var dynamicComponentType = DynamicComponentResolver
                .GetDynamicComponent($"ProjectVico.V2.UI.{documentProcessName}",
                    $"ProjectVico.V2.UI.{documentProcessName}", ComponentName);

            return dynamicComponentType;
        }
        else
        {
            return null;
        }
    }

    private string ToPascalCase(string inputString)
    {
        // You will receive a string that contains periods separating words. You need to convert each word to PascalCase from camelCase.

        // Split the string by periods
        var words = inputString.Split('.');
        var result = new StringBuilder();

        foreach (var word in words)
        {
            // Convert the first letter to uppercase
            result.Append(char.ToUpper(word[0]));
            // Append the rest of the word
            result.Append(word.Substring(1));
            // Append a period again
            result.Append('.');
        }

        // Remove the last period
        result.Remove(result.Length - 1, 1);

        return result.ToString();

    }
}
