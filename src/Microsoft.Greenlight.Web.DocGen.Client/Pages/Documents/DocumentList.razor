@page "/docs"
@using Microsoft.Greenlight.Web.DocGen.Client.Components.Authorization
@using Microsoft.Greenlight.Shared.Contracts.Authorization
@using Microsoft.Greenlight.Web.Shared.ServiceClients

@inject IDocumentGenerationApiClient DocumentGenerationApiClient
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Generated Documents List</PageTitle>

<MudPaper Class="pa-6">
    <MudText Typo="Typo.h5">Generated Documents List</MudText>
    <MudDivider Class="mt-2 mb-5" />

    @if (documents is null)
    {
        <MudSkeleton />
    }
    else if (documents.Count == 0)
    {
        <MudText>No documents found.</MudText>
    }
    else
    {
        <MudDataGrid Items="@documents.OrderByDescending(x => x.GeneratedDate)"
                     T="GeneratedDocumentListItem"
                     Hover="true"
                     Filterable="false"
                     SortMode="@SortMode.Single"
                     Groupable="false"
                     MultiSelection="true"
                     RowClick="@RowClicked"
                     SelectOnRowClick="false"
                     @bind-SelectedItems="selectedDocuments">
            <ToolBarContent>
                <MudSpacer />
                <PermissionView Permission="@PermissionKeys.GenerateDocument">
                    @if (selectedDocuments.Count > 0)
                    {
                        <MudButton OnClick="@DeleteSelectedDocuments" Variant="Variant.Filled" Color="Color.Error" Class="float-right">Delete Selected</MudButton>
                    }
                </PermissionView>
            </ToolBarContent>
        <Columns>
            <PermissionView Permission="@PermissionKeys.GenerateDocument">
                <SelectColumn T="GeneratedDocumentListItem" ShowInFooter="false" ShowInHeader="true" />
            </PermissionView>
            <PropertyColumn Property="x => x.GeneratedDate.ToShortDateString()" Title="Date Generated"  />
            <PropertyColumn Property="x => x.Title" />
            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudStack Row="true" Spacing="3">
                        <MudTooltip Delay="400" Text="View Document">
                            <MudIconButton OnClick="@(() => ViewDocument(context.Item))" Size="@Size.Small" Icon="@Icons.Material.Filled.StickyNote2"></MudIconButton>
                        </MudTooltip>
                        <PermissionView Permission="@PermissionKeys.GenerateDocument">
                            <MudTooltip Delay="400" Text="Delete (you will be asked to confirm)">
                                <MudIconButton OnClick="@(async () => await DeleteDocument(context.Item))" Size="@Size.Small" Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                            </MudTooltip>
                        </PermissionView>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
    }
</MudPaper>

@code {
    private List<GeneratedDocumentListItem> documents;
    private HashSet<GeneratedDocumentListItem> selectedDocuments = new HashSet<GeneratedDocumentListItem>();

    protected override async Task OnInitializedAsync()
    {
        documents = await DocumentGenerationApiClient.GetGeneratedDocumentsAsync();
        
    }

    private void ViewDocument(GeneratedDocumentListItem document)
    {
        Navigation.NavigateTo($"/docs/{document.Id}");
    }

    private void RowClicked(DataGridRowClickEventArgs<GeneratedDocumentListItem> obj)
    {
        var document = obj.Item;
        ViewDocument(document);
    }

    private async Task DeleteDocument(GeneratedDocumentListItem document)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to delete the document '{document.Title}'?" },
            { "ButtonText", "Delete" },
            { "DialogColor", Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete Document", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await DocumentGenerationApiClient.DeleteGeneratedDocumentAsync(document.Id.ToString());

            documents.Remove(document);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task DeleteSelectedDocuments()
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to delete {selectedDocuments.Count} documents?" },
            { "ButtonText", "Delete" },
            { "DialogColor", Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete Document", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            foreach (var document in selectedDocuments)
            {
                await DocumentGenerationApiClient.DeleteGeneratedDocumentAsync(document.Id.ToString());
                documents.Remove(document);
            }

            selectedDocuments.Clear();
            await InvokeAsync(StateHasChanged);
        }

    }
}
