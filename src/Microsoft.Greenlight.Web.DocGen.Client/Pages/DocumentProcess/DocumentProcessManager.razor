@page "/document-processes"
@using System.Text.Json
@using Microsoft.Greenlight.Web.DocGen.Client.Components.Authorization
@using Microsoft.Greenlight.Web.DocGen.Client.Services
@using Microsoft.Greenlight.Shared.Contracts.Authorization
@using Microsoft.Greenlight.Web.Shared.ServiceClients

@inject IDocumentProcessApiClient DocumentProcessApiClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject INavMenuStateService NavMenuStateService
@inject IPermissionService PermissionService

<MudPaper Class="pa-6">
    <MudText Typo="Typo.h5">Document Processes</MudText>
    <MudDivider Class="mt-2 mb-5" />
    
    <MudDataGrid Items="_documentProcesses"
                 T="DocumentProcessInfo"
                 Hover="true"
                 Filterable="false"
                 SortMode="SortMode.Single"
                 Groupable="false"
                 RowClick="@RowClicked"
                 Size="Size.Small">
        <ToolBarContent>
                <MudSpacer />
                <PermissionView Permission="@PermissionKeys.AlterDocumentProcessesAndLibraries">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="OpenImportDialog">Import</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddProcess">Add New Process</MudButton>
                </PermissionView>
            </ToolBarContent>
            <Columns>
                <PropertyColumn Property="x => x.ShortName" Title="Short Name" />
                <PropertyColumn Property="x => x.Description" Title="Description" />
                <PropertyColumn Property="x => x.LogicType.ToString()" Title="Logic Type" />
                <TemplateColumn Title="Actions" CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="3">
                            <PermissionView Permission="@PermissionKeys.AlterDocumentProcessesAndLibraries" Mode="PermissionMode.DisableControls">
                                <MudTooltip Delay="400" Text="Edit Document Process">
                                    <MudIconButton Disabled="@IsStaticProcess(context.Item)" OnClick="@(() => EditProcessAsync(context.Item.Id))" Size="@Size.Small" Icon="@Icons.Material.Filled.StickyNote2"></MudIconButton>
                                </MudTooltip>
                            </PermissionView>
                            
                            <PermissionView Permission="@PermissionKeys.AlterDocumentProcessesAndLibraries" Mode="PermissionMode.DisableControls">
                                <MudTooltip Delay="400" Text="Delete Document Process (you will be asked to confirm)">
                                    <MudIconButton Disabled="@IsStaticProcess(context.Item)" OnClick="@(() => ShowDeleteConfirmationAsync(context.Item))" Size="@Size.Small" Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                                </MudTooltip>
                            </PermissionView>
                            
                            <PermissionView Permission="@PermissionKeys.AlterDocumentProcessesAndLibraries" Mode="PermissionMode.DisableControls">
                                <MudTooltip Delay="400" Text="Export Document Process as Json (you will be asked to confirm)">
                                    <MudIconButton Disabled="@IsStaticProcess(context.Item)" OnClick="@(() => ExportProcessAsync(context.Item.Id))" Size="@Size.Small" Icon="@Icons.Material.Filled.ArrowDownward"></MudIconButton>
                                </MudTooltip>
                            </PermissionView>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
</MudPaper>

@code {
    private List<DocumentProcessInfo> _documentProcesses = new();
    private Guid? SelectedProcessId;

    protected override async Task OnInitializedAsync()
    {
        _documentProcesses = await DocumentProcessApiClient.GetAllDocumentProcessInfoAsync();
    }

    private async Task OpenImportDialog()
    {
        var parameters = new DialogParameters
        {
            ["IsProcessMode"] = true
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<Microsoft.Greenlight.Web.DocGen.Client.Components.Definitions.ImportDefinitionDialog>("Import Document Process", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            _documentProcesses = await DocumentProcessApiClient.GetAllDocumentProcessInfoAsync();
            // Notify NavMenu that document processes have changed
            await NavMenuStateService.NotifyDocumentProcessesChangedAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void AddProcess()
    {
        Navigation.NavigateTo("/document-processes/edit");
    }

    private async Task EditProcessAsync(Guid processId)
    {
        await Task.Yield(); // Ensure we're async
        Navigation.NavigateTo($"/document-processes/edit/{processId}");
    }

    private void EditProcess(Guid processId)
    {
        Navigation.NavigateTo($"/document-processes/edit/{processId}");
    }

    private async Task ExportProcessAsync(Guid processId)
    {
        try
        {
            var documentProcess = await DocumentProcessApiClient.ExportDocumentProcessByIdAsync(processId);
            var json = JsonSerializer.Serialize(documentProcess, new JsonSerializerOptions { WriteIndented = true });
            //var fileName = $"{documentProcess.ShortName}.json";
            //await JSRuntime.InvokeVoidAsync("downloadFile", fileName, json);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting process: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportProcess(Guid processId)
    {
        await ExportProcessAsync(processId);
    }

    private async Task ShowDeleteConfirmationAsync(DocumentProcessInfo process)
    {
        try
        {
            var parameters = new DialogParameters
            {
                { "ContentText", $"Are you sure you want to delete the document process '{process.ShortName}'? This deletes the vector index/collection (if SK), its blob container and all ingested document records." },
                { "ButtonText", "Delete" },
                { "DialogColor", Color.Error }
            };

            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
            var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete Document Process", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                await DeleteDocumentProcessAsync(process.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error showing delete confirmation: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowDeleteConfirmation(DocumentProcessInfo process)
    {
        await ShowDeleteConfirmationAsync(process);
    }

    private async Task DeleteDocumentProcessAsync(Guid processId)
    {
        try
        {
            if (processId != Guid.Empty)
            {
                var deleteResult = await DocumentProcessApiClient.DeleteDocumentProcessAsync(processId);
                if (deleteResult)
                {
                    _documentProcesses = await DocumentProcessApiClient.GetAllDocumentProcessInfoAsync();
                    // Notify NavMenu that document processes have changed
                    await NavMenuStateService.NotifyDocumentProcessesChangedAsync();
                    Snackbar.Add("Document process deleted successfully.", Severity.Success);
                    await InvokeAsync(StateHasChanged);
                }
                else
                {
                    Snackbar.Add("Document process NOT deleted due to an error", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting document process: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteDocumentProcess(Guid processId)
    {
        await DeleteDocumentProcessAsync(processId);
    }

    private async Task RowClicked(DataGridRowClickEventArgs<DocumentProcessInfo> args)
    {
        if (!IsStaticProcess(args.Item))
        {
            await EditProcessAsync(args.Item.Id);
        }
    }

    private bool IsStaticProcess(DocumentProcessInfo process)
    {
        return process.Source == ProcessSource.Static;
    }
}
