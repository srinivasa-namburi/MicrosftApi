@page "/configuration"
@using Microsoft.Greenlight.Shared.Configuration
@using Microsoft.Greenlight.Shared.Contracts.DTO.Configuration
@inject IConfigurationApiClient ConfigurationApiClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Configuration</PageTitle>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Configuration Management</MudText>
    <MudDivider Class="my-2" />

    <!-- Floating Save All button (visible when any section is dirty) -->
    <MudTooltip Text="Save all unsaved changes">
        <MudFab Icon="@Icons.Material.Filled.Save" Color="Color.Primary" OnClick="SaveAllAsync" Disabled="@(!AnyDirty)"
                Class="d-none d-md-flex" Style="position: fixed; right: 24px; bottom: 24px; z-index: 1300;"
                Extended="true" Label="Save All Changes" />
    </MudTooltip>

    <MudTabs Elevation="4" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
        <!-- Frontend Options Tab -->
        <MudTabPanel Text="Frontend">
            @if (IsFrontendDirty)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Filled" Class="mb-2">You have unsaved changes</MudAlert>
            }
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudCard Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6">Frontend Options</MudText>
                            <MudDivider Class="my-2" />
                            <MudItem xs="12">
                                <MudTextField @bind-Value="_frontendOptions.SiteName" Label="Site Name" Variant="Variant.Filled" Immediate="true" />
                            </MudItem>
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" Disabled="@(!IsFrontendDirty)" OnClick="SaveFrontendAsync">Save Frontend</MudButton>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- Feature Flags Tab -->
        <MudTabPanel Text="Features">
            @if (IsFeaturesDirty)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Filled" Class="mb-2">You have unsaved changes</MudAlert>
            }
            <MudGrid>
                <MudItem xs="12" md="8">
                    <MudCard Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6">Feature Toggles</MudText>
                            <MudDivider Class="my-2" />
                            <MudItem xs="12">
                                <MudSwitch @bind-Value="_featureFlags.EnableMassDocumentProduction" Color="Color.Primary" Label="Enable Mass Document Production" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudSwitch @bind-Value="_featureFlags.EnableReviews" Color="Color.Primary" Label="Enable Reviews" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudSwitch @bind-Value="_featureFlags.EnableReferenceFrontend" Color="Color.Primary" Label="Enable Source Reference Frontend for generation" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudSwitch @bind-Value="_featureFlags.EnableContentReferences" Color="Color.Primary" Label="Enable Content Reference System (internal links)" />
                            </MudItem>
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" Disabled="@(!IsFeaturesDirty)" OnClick="SaveFeaturesAsync">Save Features</MudButton>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- Scalability Options Tab -->
        <MudTabPanel Text="Scalability">
            @if (IsScalabilityDirty)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Filled" Class="mb-2">You have unsaved changes</MudAlert>
            }
            <MudGrid>
                <MudItem xs="12" md="10">
                    <MudCard Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6">Scalability Options</MudText>
                            <MudDivider Class="my-2" />
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudSlider T="int" @bind-Value="_scalabilityOptions.NumberOfValidationWorkers" Min="1" Max="10" TickMarks="true" ValueLabel="true" Immediate="true">Number of Validation Workers</MudSlider>
                                <MudNumericField T="int" @bind-Value="_scalabilityOptions.NumberOfValidationWorkers" Min="1" Max="10" Immediate="true" Style="width:80px;" />
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudSlider T="int" @bind-Value="_scalabilityOptions.NumberOfGenerationWorkers" Min="1" Max="10" TickMarks="true" ValueLabel="true" Immediate="true">Number of Document Generation Workers</MudSlider>
                                <MudNumericField T="int" @bind-Value="_scalabilityOptions.NumberOfGenerationWorkers" Min="1" Max="10" Immediate="true" Style="width:80px;" />
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudSlider T="int" @bind-Value="_scalabilityOptions.NumberOfIngestionWorkers" Min="1" Max="10" TickMarks="true" ValueLabel="true" Immediate="true">Number of Document Ingestion Workers</MudSlider>
                                <MudNumericField T="int" @bind-Value="_scalabilityOptions.NumberOfIngestionWorkers" Min="1" Max="10" Immediate="true" Style="width:80px;" />
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudSlider T="int" @bind-Value="_scalabilityOptions.NumberOfReviewWorkers" Min="1" Max="10" TickMarks="true" ValueLabel="true" Immediate="true">Number of Document Review Workers</MudSlider>
                                <MudNumericField T="int" @bind-Value="_scalabilityOptions.NumberOfReviewWorkers" Min="1" Max="10" Immediate="true" Style="width:80px;" />
                            </MudStack>
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" Disabled="@(!IsScalabilityDirty)" OnClick="SaveScalabilityAsync">Save Scalability</MudButton>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- Vector Store Options Tab -->
        <MudTabPanel Text="Vector Store">
            @if (IsVectorStoreDirty)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Filled" Class="mb-2">You have unsaved changes</MudAlert>
            }
            <MudGrid>
                <MudItem xs="12">
                    <MudCard Class="mb-4">
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h6">Vector Store Options</MudText>
                                <MudChip Color="Color.Info" Size="Size.Small">
                                    <MudText Typo="Typo.body2">
                                        <strong>Store Type:</strong> @_vectorStoreOptions.StoreType.ToString()
                                    </MudText>
                                </MudChip>
                            </MudStack>
                            <MudDivider Class="my-2" />
                            <MudGrid>
                                <MudItem xs="12" md="3"><MudNumericField T="int" @bind-Value="_vectorStoreOptions.ChunkSize" Label="Chunk Size" Min="100" Max="8000" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudNumericField T="int" @bind-Value="_vectorStoreOptions.ChunkOverlap" Label="Chunk Overlap" Min="0" Max="4000" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudNumericField T="int" @bind-Value="_vectorStoreOptions.MaxSearchResults" Label="Max Search Results" Min="1" Max="100" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudNumericField T="double" @bind-Value="_vectorStoreOptions.MinRelevanceScore" Label="Min Relevance Score" Min="0" Max="1" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudNumericField T="int" @bind-Value="_vectorStoreOptions.DocumentChunkCacheTtlMinutes" Label="Chunk Cache TTL (min)" Min="1" Max="1440" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudSwitch @bind-Value="_vectorStoreOptions.EnableFileNameDocIdCacheIndex" Color="Color.Primary" Label="FileName->DocId Cache Index" /></MudItem>
                                <MudItem xs="12" md="3"><MudNumericField T="double" @bind-Value="ScoreCutoffValue" Label="Score Cutoff" Min="0" Max="1" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudNumericField T="int" @bind-Value="_vectorStoreOptions.MinResultsBeforeCutoff" Label="Min Results Before Cutoff" Min="0" Max="100" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudSwitch @bind-Value="_vectorStoreOptions.EnableHybridScoring" Color="Color.Primary" Label="Enable Hybrid Scoring" /></MudItem>
                                <MudItem xs="12" md="3"><MudNumericField T="double" @bind-Value="_vectorStoreOptions.HybridVectorWeight" Label="Hybrid Vector Weight" Min="0" Max="1" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudNumericField T="int" @bind-Value="_vectorStoreOptions.MaxChunkTextLength" Label="Max Chunk Text Length" Min="100" Max="20000" Immediate="true" /></MudItem>
                                <MudItem xs="12" md="3"><MudSwitch @bind-Value="_vectorStoreOptions.EnableWarmup" Color="Color.Primary" Label="Enable Warmup" /></MudItem>
                                <MudItem xs="12" md="3"><MudSwitch @bind-Value="_vectorStoreOptions.EnableEmbeddingDimensionVerification" Color="Color.Primary" Label="Verify Embedding Dimensions" /></MudItem>
                            </MudGrid>
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mt-3">
                                <strong>Note:</strong> Store Type is automatically determined by the UsePostgresMemory global setting and cannot be directly modified here.
                            </MudAlert>
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" Disabled="@(!IsVectorStoreDirty)" OnClick="SaveVectorStoreAsync">Save Vector Store</MudButton>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- OCR Options Tab -->
        <MudTabPanel Text="OCR">
            @if (IsOcrDirty)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Filled" Class="mb-2">You have unsaved changes</MudAlert>
            }
            <MudGrid>
                <MudItem xs="12" md="10">
                    <MudCard Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6">OCR Options</MudText>
                            <MudDivider Class="my-2" />
                            <MudItem xs="12">
                                <MudSwitch @bind-Value="_ocrOptions.AllowExternalDownloads" Color="Color.Primary" Label="Allow External Downloads" />
                            </MudItem>
                            <MudItem xs="12" md="8">
                                <MudTextField @bind-Value="_ocrOptions.ExternalRepoBaseUrl" Label="External Repo Base Url" Variant="Variant.Filled" Immediate="true" />
                            </MudItem>

                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.subtitle1">Default Languages</MudText>
                            <MudText Typo="Typo.body2" Class="mb-2">Choose which OCR language data files to prefer. These are codes like 'eng', 'spa', 'chi_sim'.</MudText>

                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudTextField @bind-Value="_languageFilter" Label="Filter languages" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Immediate="true" />
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="RefreshCachedLanguagesAsync" StartIcon="@Icons.Material.Filled.Refresh">Refresh</MudButton>
                            </MudStack>
                            <MudSelect T="string" Label="Select Default Languages" Variant="Variant.Outlined" MultiSelection="true" SelectedValues="@_selectedDefaultLanguages" SelectedValuesChanged="@( (IEnumerable<string> values) => OnSelectedDefaultLanguagesChanged(values) )" Dense="true" Class="mt-2">
                                @foreach (var lang in AllSelectableLanguages)
                                {
                                    if (IsLanguageVisible(lang))
                                    {
                                        <MudSelectItem Value="@lang.Code">@lang.Label</MudSelectItem>
                                    }
                                }
                            </MudSelect>

                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.subtitle1">Download New Language</MudText>
                            <MudText Typo="Typo.body2" Class="mb-2">Provide a Tesseract language code (e.g., 'eng', 'spa', 'chi_sim') to download from the configured repo and cache to blob.</MudText>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudTextField @bind-Value="_languageCodeToDownload" Label="Language code" Variant="Variant.Outlined" Immediate="true" />
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="DownloadLanguageAsync" Disabled="string.IsNullOrWhiteSpace(_languageCodeToDownload)" StartIcon="@Icons.Material.Filled.Download">Download</MudButton>
                            </MudStack>

                            <MudDivider Class="my-4" />
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveOcrOptionsAsync" StartIcon="@Icons.Material.Filled.Save" Disabled="@(!IsOcrDirty)">Save OCR Settings</MudButton>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <!-- AI Models Tab -->
        <MudTabPanel Text="AI Models">
            <MudCard>
                <MudCardContent>
                    <AiModelEditorComponent />
                </MudCardContent>
            </MudCard>
        </MudTabPanel>
    </MudTabs>
</MudPaper>

@code {
    private ServiceConfigurationOptions.GreenlightServicesOptions.FeatureFlagsOptions _featureFlags = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.FrontendOptions _frontendOptions = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.ScalabilityOptions _scalabilityOptions = new();
    private VectorStoreOptions _vectorStoreOptions = new();

    // Snapshots for dirty-checking
    private ServiceConfigurationOptions.GreenlightServicesOptions.FeatureFlagsOptions _initialFeatureFlags = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.FrontendOptions _initialFrontendOptions = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.ScalabilityOptions _initialScalabilityOptions = new();
    private VectorStoreOptions _initialVectorStoreOptions = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.DocumentIngestionOptions.OcrOptions _initialOcrOptions = new();
    private HashSet<string> _initialDefaultLanguages = new(StringComparer.OrdinalIgnoreCase);

    // Prevent repeated snapshotting during Save All
    private bool _suppressSnapshot = false;

    // OCR state
    private ServiceConfigurationOptions.GreenlightServicesOptions.DocumentIngestionOptions.OcrOptions _ocrOptions = new();
    private List<LanguageDisplayInfo> _cachedLanguages = new();
    private HashSet<string> _selectedDefaultLanguages = new(StringComparer.OrdinalIgnoreCase);
    private string _languageFilter = string.Empty;
    private string _languageCodeToDownload = string.Empty;

    // Wrapper to handle nullable ScoreCutoff
    private double ScoreCutoffValue
    {
        get => _vectorStoreOptions.ScoreCutoff ?? 0d;
        set => _vectorStoreOptions.ScoreCutoff = value == 0d ? null : value;
    }

    private bool IsFrontendDirty => _frontendOptions.SiteName != _initialFrontendOptions.SiteName;
    private bool IsFeaturesDirty =>
        _featureFlags.EnableMassDocumentProduction != _initialFeatureFlags.EnableMassDocumentProduction ||
        _featureFlags.EnableReviews != _initialFeatureFlags.EnableReviews ||
        _featureFlags.EnableReferenceFrontend != _initialFeatureFlags.EnableReferenceFrontend ||
        _featureFlags.EnableContentReferences != _initialFeatureFlags.EnableContentReferences;
    private bool IsScalabilityDirty =>
        _scalabilityOptions.NumberOfValidationWorkers != _initialScalabilityOptions.NumberOfValidationWorkers ||
        _scalabilityOptions.NumberOfGenerationWorkers != _initialScalabilityOptions.NumberOfGenerationWorkers ||
        _scalabilityOptions.NumberOfIngestionWorkers != _initialScalabilityOptions.NumberOfIngestionWorkers ||
        _scalabilityOptions.NumberOfReviewWorkers != _initialScalabilityOptions.NumberOfReviewWorkers;
    private bool IsVectorStoreDirty =>
        _vectorStoreOptions.ChunkSize != _initialVectorStoreOptions.ChunkSize ||
        _vectorStoreOptions.ChunkOverlap != _initialVectorStoreOptions.ChunkOverlap ||
        _vectorStoreOptions.MaxSearchResults != _initialVectorStoreOptions.MaxSearchResults ||
        _vectorStoreOptions.MinRelevanceScore != _initialVectorStoreOptions.MinRelevanceScore ||
        _vectorStoreOptions.DocumentChunkCacheTtlMinutes != _initialVectorStoreOptions.DocumentChunkCacheTtlMinutes ||
        _vectorStoreOptions.EnableFileNameDocIdCacheIndex != _initialVectorStoreOptions.EnableFileNameDocIdCacheIndex ||
        (_vectorStoreOptions.ScoreCutoff ?? 0) != (_initialVectorStoreOptions.ScoreCutoff ?? 0) ||
        _vectorStoreOptions.MinResultsBeforeCutoff != _initialVectorStoreOptions.MinResultsBeforeCutoff ||
        _vectorStoreOptions.EnableHybridScoring != _initialVectorStoreOptions.EnableHybridScoring ||
        _vectorStoreOptions.HybridVectorWeight != _initialVectorStoreOptions.HybridVectorWeight ||
        _vectorStoreOptions.MaxChunkTextLength != _initialVectorStoreOptions.MaxChunkTextLength ||
        _vectorStoreOptions.EnableWarmup != _initialVectorStoreOptions.EnableWarmup ||
        _vectorStoreOptions.EnableEmbeddingDimensionVerification != _initialVectorStoreOptions.EnableEmbeddingDimensionVerification;
    private bool IsOcrDirty =>
        _ocrOptions.AllowExternalDownloads != _initialOcrOptions.AllowExternalDownloads ||
        string.Compare(_ocrOptions.ExternalRepoBaseUrl ?? string.Empty, _initialOcrOptions.ExternalRepoBaseUrl ?? string.Empty, StringComparison.Ordinal) != 0 ||
        !_selectedDefaultLanguages.SetEquals(_initialDefaultLanguages);

    private bool AnyDirty => IsFrontendDirty || IsFeaturesDirty || IsScalabilityDirty || IsVectorStoreDirty || IsOcrDirty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _featureFlags = await ConfigurationApiClient.GetFeatureFlagsAsync();
            _frontendOptions = await ConfigurationApiClient.GetFrontEndAsync();
            _scalabilityOptions = await ConfigurationApiClient.GetScalabilityOptionsAsync();
            _vectorStoreOptions = await ConfigurationApiClient.GetVectorStoreOptionsAsync();

            // Load OCR
            _ocrOptions = await ConfigurationApiClient.GetOcrOptionsAsync();
            var languages = await ConfigurationApiClient.GetCachedOcrLanguagesAsync();
            _cachedLanguages = languages ?? new List<LanguageDisplayInfo>();
            _selectedDefaultLanguages = new HashSet<string>(_ocrOptions.DefaultLanguages ?? new List<string>(), StringComparer.OrdinalIgnoreCase);

            // Take snapshots for dirty-checking
            SnapshotInitialState();
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("Error", $"Failed to load configuration: {ex.Message}");
        }
    }

    private void SnapshotInitialState()
    {
        _initialFeatureFlags = new ServiceConfigurationOptions.GreenlightServicesOptions.FeatureFlagsOptions
        {
            EnableMassDocumentProduction = _featureFlags.EnableMassDocumentProduction,
            EnableReviews = _featureFlags.EnableReviews,
            EnableReferenceFrontend = _featureFlags.EnableReferenceFrontend,
            EnableContentReferences = _featureFlags.EnableContentReferences
        };
        _initialFrontendOptions = new ServiceConfigurationOptions.GreenlightServicesOptions.FrontendOptions
        {
            SiteName = _frontendOptions.SiteName
        };
        _initialScalabilityOptions = new ServiceConfigurationOptions.GreenlightServicesOptions.ScalabilityOptions
        {
            NumberOfValidationWorkers = _scalabilityOptions.NumberOfValidationWorkers,
            NumberOfGenerationWorkers = _scalabilityOptions.NumberOfGenerationWorkers,
            NumberOfIngestionWorkers = _scalabilityOptions.NumberOfIngestionWorkers,
            NumberOfReviewWorkers = _scalabilityOptions.NumberOfReviewWorkers
        };
        _initialVectorStoreOptions = new VectorStoreOptions
        {
            ChunkSize = _vectorStoreOptions.ChunkSize,
            ChunkOverlap = _vectorStoreOptions.ChunkOverlap,
            MaxSearchResults = _vectorStoreOptions.MaxSearchResults,
            MinRelevanceScore = _vectorStoreOptions.MinRelevanceScore,
            DocumentChunkCacheTtlMinutes = _vectorStoreOptions.DocumentChunkCacheTtlMinutes,
            EnableFileNameDocIdCacheIndex = _vectorStoreOptions.EnableFileNameDocIdCacheIndex,
            ScoreCutoff = _vectorStoreOptions.ScoreCutoff,
            MinResultsBeforeCutoff = _vectorStoreOptions.MinResultsBeforeCutoff,
            EnableHybridScoring = _vectorStoreOptions.EnableHybridScoring,
            HybridVectorWeight = _vectorStoreOptions.HybridVectorWeight,
            MaxChunkTextLength = _vectorStoreOptions.MaxChunkTextLength,
            EnableWarmup = _vectorStoreOptions.EnableWarmup,
            EnableEmbeddingDimensionVerification = _vectorStoreOptions.EnableEmbeddingDimensionVerification
        };
        _initialOcrOptions = new ServiceConfigurationOptions.GreenlightServicesOptions.DocumentIngestionOptions.OcrOptions
        {
            AllowExternalDownloads = _ocrOptions.AllowExternalDownloads,
            ExternalRepoBaseUrl = _ocrOptions.ExternalRepoBaseUrl,
            TessdataBlobContainer = _ocrOptions.TessdataBlobContainer,
            DefaultLanguages = new List<string>(_ocrOptions.DefaultLanguages ?? new List<string>())
        };
        _initialDefaultLanguages = new HashSet<string>(_initialOcrOptions.DefaultLanguages ?? new List<string>(), StringComparer.OrdinalIgnoreCase);
    }

    private IEnumerable<LanguageDisplayInfo> AllSelectableLanguages
    {
        get
        {
            var byCode = new Dictionary<string, LanguageDisplayInfo>(StringComparer.OrdinalIgnoreCase);
            foreach (var l in _cachedLanguages)
            {
                if (!byCode.ContainsKey(l.Code))
                {
                    byCode[l.Code] = l;
                }
            }
            foreach (var code in _selectedDefaultLanguages)
            {
                if (!byCode.ContainsKey(code))
                {
                    byCode[code] = new LanguageDisplayInfo { Code = code, Label = code, EnglishName = string.Empty };
                }
            }
            return byCode.Values.OrderBy(v => v.Label);
        }
    }

    private bool IsLanguageVisible(LanguageDisplayInfo lang)
    {
        if (string.IsNullOrWhiteSpace(_languageFilter))
        {
            return true;
        }
        var f = _languageFilter.Trim();
        return lang.Code.Contains(f, StringComparison.OrdinalIgnoreCase)
               || (!string.IsNullOrWhiteSpace(lang.EnglishName) && lang.EnglishName.Contains(f, StringComparison.OrdinalIgnoreCase))
               || (!string.IsNullOrWhiteSpace(lang.Label) && lang.Label.Contains(f, StringComparison.OrdinalIgnoreCase));
    }

    private async Task RefreshCachedLanguagesAsync()
    {
        try
        {
            var languages = await ConfigurationApiClient.GetCachedOcrLanguagesAsync();
            _cachedLanguages = languages ?? new List<LanguageDisplayInfo>();
            Snackbar.Add("Refreshed cached OCR languages.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to refresh OCR languages: {ex.Message}", Severity.Error);
        }
    }

    private async Task DownloadLanguageAsync()
    {
        try
        {
            var code = _languageCodeToDownload?.Trim();
            if (string.IsNullOrWhiteSpace(code))
            {
                return;
            }

            var resp = await ConfigurationApiClient.DownloadOcrLanguageAsync(code);
            Snackbar.Add($"Downloaded '{resp.Language}'.", Severity.Success);
            _languageCodeToDownload = string.Empty;
            await RefreshCachedLanguagesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to download language: {ex.Message}", Severity.Error);
        }
    }

    private Task OnSelectedDefaultLanguagesChanged(IEnumerable<string> values)
    {
        _selectedDefaultLanguages = values != null
            ? new HashSet<string>(values, StringComparer.OrdinalIgnoreCase)
            : new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        return Task.CompletedTask;
    }

    private async Task SaveFrontendAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:FrontEnd:SiteName", _frontendOptions.SiteName ?? string.Empty }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        if (!_suppressSnapshot) { SnapshotInitialState(); }
        Snackbar.Add("Frontend options saved.", Severity.Success);
    }

    private async Task SaveFeaturesAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableMassDocumentProduction", _featureFlags.EnableMassDocumentProduction.ToString() },
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableReviews", _featureFlags.EnableReviews.ToString() },
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableReferenceFrontend", _featureFlags.EnableReferenceFrontend.ToString() },
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableContentReferences", _featureFlags.EnableContentReferences.ToString() }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        if (!_suppressSnapshot) { SnapshotInitialState(); }
        Snackbar.Add("Feature flags saved.", Severity.Success);
    }

    private async Task SaveScalabilityAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:Scalability:NumberOfValidationWorkers", _scalabilityOptions.NumberOfValidationWorkers.ToString() },
                { "ServiceConfiguration:GreenlightServices:Scalability:NumberOfGenerationWorkers", _scalabilityOptions.NumberOfGenerationWorkers.ToString() },
                { "ServiceConfiguration:GreenlightServices:Scalability:NumberOfIngestionWorkers", _scalabilityOptions.NumberOfIngestionWorkers.ToString() },
                { "ServiceConfiguration:GreenlightServices:Scalability:NumberOfReviewWorkers", _scalabilityOptions.NumberOfReviewWorkers.ToString() }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        if (!_suppressSnapshot) { SnapshotInitialState(); }
        Snackbar.Add("Scalability options saved.", Severity.Success);
    }

    private async Task SaveVectorStoreAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:VectorStore:ChunkSize", _vectorStoreOptions.ChunkSize.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ChunkOverlap", _vectorStoreOptions.ChunkOverlap.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:MaxSearchResults", _vectorStoreOptions.MaxSearchResults.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:MinRelevanceScore", _vectorStoreOptions.MinRelevanceScore.ToString(System.Globalization.CultureInfo.InvariantCulture) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:DocumentChunkCacheTtlMinutes", _vectorStoreOptions.DocumentChunkCacheTtlMinutes.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:EnableFileNameDocIdCacheIndex", _vectorStoreOptions.EnableFileNameDocIdCacheIndex.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ScoreCutoff", (_vectorStoreOptions.ScoreCutoff ?? 0).ToString(System.Globalization.CultureInfo.InvariantCulture) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:MinResultsBeforeCutoff", _vectorStoreOptions.MinResultsBeforeCutoff.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:EnableHybridScoring", _vectorStoreOptions.EnableHybridScoring.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:HybridVectorWeight", _vectorStoreOptions.HybridVectorWeight.ToString(System.Globalization.CultureInfo.InvariantCulture) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:MaxChunkTextLength", _vectorStoreOptions.MaxChunkTextLength.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:EnableWarmup", _vectorStoreOptions.EnableWarmup.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:EnableEmbeddingDimensionVerification", _vectorStoreOptions.EnableEmbeddingDimensionVerification.ToString() }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        if (!_suppressSnapshot) { SnapshotInitialState(); }
        Snackbar.Add("Vector store options saved.", Severity.Success);
    }

    private async Task SaveOcrOptionsAsync()
    {
        try
        {
            var request = new ConfigurationUpdateRequest
            {
                ConfigurationItems = new Dictionary<string, string>
                {
                    { "ServiceConfiguration:GreenlightServices:DocumentIngestion:Ocr:AllowExternalDownloads", _ocrOptions.AllowExternalDownloads.ToString() },
                    { "ServiceConfiguration:GreenlightServices:DocumentIngestion:Ocr:ExternalRepoBaseUrl", _ocrOptions.ExternalRepoBaseUrl ?? string.Empty }
                }
            };

            await ConfigurationApiClient.UpdateConfigurationAsync(request);
            await ConfigurationApiClient.SetDefaultOcrLanguagesAsync(_selectedDefaultLanguages.ToList());

            if (!_suppressSnapshot) { SnapshotInitialState(); }
            Snackbar.Add("OCR settings saved.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save OCR settings: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveAllAsync()
    {
        try
        {
            _suppressSnapshot = true;
            if (IsFrontendDirty) { await SaveFrontendAsync(); }
            if (IsFeaturesDirty) { await SaveFeaturesAsync(); }
            if (IsScalabilityDirty) { await SaveScalabilityAsync(); }
            if (IsVectorStoreDirty) { await SaveVectorStoreAsync(); }
            if (IsOcrDirty) { await SaveOcrOptionsAsync(); }
            _suppressSnapshot = false;

            SnapshotInitialState();
            await DialogService.ShowMessageBox("Success", "All changes saved successfully.");
        }
        catch (Exception ex)
        {
            _suppressSnapshot = false;
            await DialogService.ShowMessageBox("Error", $"Failed to save configuration: {ex.Message}");
        }
    }
}
