@* Copyright (c) Microsoft Corporation. All rights reserved. *@
@page "/admin/configuration"
@using Microsoft.Greenlight.Shared.Configuration
@using Microsoft.Greenlight.Shared.Contracts.DTO.Configuration
@using Microsoft.Greenlight.Web.DocGen.Client.Components.Configuration
@inject IConfigurationApiClient ConfigurationApiClient
@inject IContentReferenceReindexApiClient ContentReferenceReindexApiClient
@inject IDialogService DialogService
@inject ISnackbar SnackBar
@inject INavMenuStateService NavMenuStateService
@inject NavigationManager Nav
@implements IDisposable

<PageTitle>Configuration</PageTitle>

@if (_isCardView)
{
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" Class="mb-2">Configuration Management</MudText>
        <MudText Typo="Typo.body1" Class="mb-4 mud-text-secondary">Select a configuration section to manage</MudText>
        
        <ConfigurationCardGrid OnCardSelected="HandleCardSelection" IsAnimating="_isAnimating" />
    </MudPaper>
}
else
{
    <ConfigurationMenuBar SelectedSection="_section" 
                         OnSectionChange="HandleSectionChange" 
                         OnExpand="HandleMenuExpand" />
    
    <MudPaper Class="pa-4">
        <MudTooltip Text="Save all unsaved changes">
            <MudFab StartIcon="@Icons.Material.Filled.Save" Color="Color.Primary" OnClick="SaveAllAsync" Disabled="@(!AnyDirty)"
                    Class="d-none d-md-flex" Style="position: fixed; right: 24px; bottom: 24px; z-index: 1300;"
                    Label="Save All Changes" />
        </MudTooltip>

        @if (_activeCrReindexCount > 0)
        {
            <PermissionView Permission="@Microsoft.Greenlight.Shared.Contracts.Authorization.PermissionKeys.AlterDocumentProcessesAndLibraries" Mode="PermissionMode.DisableControls">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                    <MudChip T="string" Color="Color.Info" Variant="Variant.Filled" OnClick="OpenContentReferenceReindexDialog">
                        Content Reference Reindexing: @_activeCrReindexCount
                    </MudChip>
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="RefreshActiveCrReindexCountAsync" AriaLabel="Refresh reindex status" />
                </MudStack>
            </PermissionView>
            <MudDivider Class="mt-1 mb-3" />
        }

        <div class="configuration-content">
            @if (_section == ConfigSection.Frontend)
            {
                <CascadingValue Value="_coordinator">
                    <FrontendConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.Features)
            {
                <CascadingValue Value="_coordinator">
                    <FeatureFlagsConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.Scalability)
            {
                <CascadingValue Value="_coordinator">
                    <ScalabilityConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.VectorStore)
            {
                <CascadingValue Value="_coordinator">
                    <VectorStoreConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.Ocr)
            {
                <CascadingValue Value="_coordinator">
                    <OcrConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.Secrets)
            {
                <CascadingValue Value="_coordinator">
                    <SecretsConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.FileStorage)
            {
                <CascadingValue Value="_coordinator">
                    <FileStorageConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.HostNames)
            {
                <CascadingValue Value="_coordinator">
                    <HostNameConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.Mcp)
            {
                <CascadingValue Value="_coordinator">
                    <McpConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.AiModels)
            {
                <CascadingValue Value="_coordinator">
                    <AiModelConfiguration />
                </CascadingValue>
            }
            @if (_section == ConfigSection.Flow)
            {
                <CascadingValue Value="_coordinator">
                    <FlowConfiguration />
                </CascadingValue>
            }
        </div>
    </MudPaper>
}

@code {
    private ServiceConfigurationOptions.GreenlightServicesOptions.FeatureFlagsOptions _featureFlags = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.FrontendOptions _frontendOptions = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.ScalabilityOptions _scalabilityOptions = new();
    private VectorStoreOptions _vectorStoreOptions = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.DocumentIngestionOptions.OcrOptions _ocrOptions = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.DocumentIngestionOptions.OcrOptions _initialOcrOptions = new();

    private SecretOverrideInfo? _azureMapsKeyInfo;
    private string _azureMapsKeyOverride = string.Empty;

    private string _languageFilter = string.Empty;
    private HashSet<string> _selectedDefaultLanguages = new(StringComparer.OrdinalIgnoreCase);
    private HashSet<string> _initialDefaultLanguages = new(StringComparer.OrdinalIgnoreCase);
    private List<LanguageDisplayInfo> _cachedLanguages = new();
    private string _languageCodeToDownload = string.Empty;

    private VectorStoreOptions _initialVectorStoreOptions = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.FeatureFlagsOptions _initialFeatureFlags = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.FrontendOptions _initialFrontendOptions = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.ScalabilityOptions _initialScalabilityOptions = new();

    private readonly Microsoft.Greenlight.Web.DocGen.Client.Components.Configuration.Infrastructure.ConfigurationSectionCoordinator _coordinator = new();
    private bool AnyDirty => _coordinator.HasAnyDirty;
    private bool IsVectorStoreDirty => !VectorStoreEquals(_vectorStoreOptions, _initialVectorStoreOptions);
    private bool IsOcrDirty =>
        _ocrOptions.AllowExternalDownloads != _initialOcrOptions.AllowExternalDownloads ||
        !string.Equals(_ocrOptions.ExternalRepoBaseUrl, _initialOcrOptions.ExternalRepoBaseUrl, StringComparison.Ordinal) ||
        !_selectedDefaultLanguages.SetEquals(_initialDefaultLanguages);

    private ConfigSection _section = ConfigSection.Features;
    private bool _isCardView = true;
    private bool _isAnimating = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _coordinator.DirtyChanged += OnCoordinatorDirtyChanged;
            _featureFlags = await ConfigurationApiClient.GetFeatureFlagsAsync();
            _frontendOptions = await ConfigurationApiClient.GetFrontEndAsync();
            _scalabilityOptions = await ConfigurationApiClient.GetScalabilityOptionsAsync();
            await LoadSecretsInfoAsync();
            await RefreshActiveCrReindexCountAsync();
            SnapshotInitialState();
            ApplySectionFromQuery();
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("Error", $"Failed to load configuration: {ex.Message}");
        }
    }

    protected override void OnParametersSet()
    {
        ApplySectionFromQuery();
    }

    private void ApplySectionFromQuery()
    {
        try
        {
            var uri = Nav.ToAbsoluteUri(Nav.Uri);
            var query = uri.Query; // includes leading '?'
            if (string.IsNullOrWhiteSpace(query) || query.Length <= 1) { return; }
            // split manually without pulling extra package
            var pairs = query.Substring(1).Split('&', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            foreach (var pair in pairs)
            {
                var kvp = pair.Split('=', 2);
                if (kvp.Length == 2)
                {
                    var key = Uri.UnescapeDataString(kvp[0]);
                    if (!key.Equals("section", StringComparison.OrdinalIgnoreCase)) { continue; }
                    var raw = Uri.UnescapeDataString(kvp[1]);
                    if (TryResolveSection(raw, out var target))
                    {
                        _section = target;
                        _isCardView = false;
                    }
                    break;
                }
            }
        }
        catch { }
    }

    private static bool TryResolveSection(string value, out ConfigSection section)
    {
        section = ConfigSection.Features;
        if (string.IsNullOrWhiteSpace(value)) return false;
        value = value.Trim();
        if (Enum.TryParse<ConfigSection>(value, true, out var parsed)) { section = parsed; return true; }
        switch (value.ToLowerInvariant())
        {
            case "ai":
            case "models": section = ConfigSection.AiModels; return true;
            case "openai":
            case "secrets": section = ConfigSection.Secrets; return true;
            case "vector":
            case "vectors": section = ConfigSection.VectorStore; return true;
            case "ocr": section = ConfigSection.Ocr; return true;
            case "flow": section = ConfigSection.Flow; return true;
            case "mcp": section = ConfigSection.Mcp; return true;
            case "frontend":
            case "front": section = ConfigSection.Frontend; return true;
            case "scalability":
            case "scale": section = ConfigSection.Scalability; return true;
            case "files":
            case "storage": section = ConfigSection.FileStorage; return true;
            case "hosts":
            case "hostnames": section = ConfigSection.HostNames; return true;
        }
        return false;
    }

    private void OnCoordinatorDirtyChanged() => _ = InvokeAsync(StateHasChanged);

    public void Dispose() => _coordinator.DirtyChanged -= OnCoordinatorDirtyChanged;

    private void SnapshotInitialState()
    {
        _initialOcrOptions = new ServiceConfigurationOptions.GreenlightServicesOptions.DocumentIngestionOptions.OcrOptions
        {
            AllowExternalDownloads = _ocrOptions.AllowExternalDownloads,
            ExternalRepoBaseUrl = _ocrOptions.ExternalRepoBaseUrl,
            TessdataBlobContainer = _ocrOptions.TessdataBlobContainer,
            DefaultLanguages = new List<string>(_ocrOptions.DefaultLanguages ?? new List<string>())
        };
        _initialDefaultLanguages = new HashSet<string>(_initialOcrOptions.DefaultLanguages ?? new List<string>(), StringComparer.OrdinalIgnoreCase);
        _initialVectorStoreOptions = CloneVectorStore(_vectorStoreOptions);
        _initialFeatureFlags = new ServiceConfigurationOptions.GreenlightServicesOptions.FeatureFlagsOptions
        {
            EnableMassDocumentProduction = _featureFlags.EnableMassDocumentProduction,
            EnableReviews = _featureFlags.EnableReviews,
            EnableReferenceFrontend = _featureFlags.EnableReferenceFrontend,
            EnableContentReferences = _featureFlags.EnableContentReferences,
            EnableExternalDataView = _featureFlags.EnableExternalDataView
        };
        _initialFrontendOptions = new ServiceConfigurationOptions.GreenlightServicesOptions.FrontendOptions { SiteName = _frontendOptions.SiteName };
        _initialScalabilityOptions = new ServiceConfigurationOptions.GreenlightServicesOptions.ScalabilityOptions
        {
            NumberOfValidationWorkers = _scalabilityOptions.NumberOfValidationWorkers,
            NumberOfGenerationWorkers = _scalabilityOptions.NumberOfGenerationWorkers,
            NumberOfIngestionWorkers = _scalabilityOptions.NumberOfIngestionWorkers,
            NumberOfReviewWorkers = _scalabilityOptions.NumberOfReviewWorkers
        };
    }

    private static VectorStoreOptions CloneVectorStore(VectorStoreOptions src) => new()
    {
        StoreType = src.StoreType,
        ChunkSize = src.ChunkSize,
        ChunkOverlap = src.ChunkOverlap,
        MaxSearchResults = src.MaxSearchResults,
        MinRelevanceScore = src.MinRelevanceScore,
        DocumentChunkCacheTtlMinutes = src.DocumentChunkCacheTtlMinutes,
        VectorSize = src.VectorSize,
        EnableFileNameDocIdCacheIndex = src.EnableFileNameDocIdCacheIndex,
        ScoreCutoff = src.ScoreCutoff,
        MinResultsBeforeCutoff = src.MinResultsBeforeCutoff,
        EnableHybridScoring = src.EnableHybridScoring,
        HybridVectorWeight = src.HybridVectorWeight,
        MaxChunkTextLength = src.MaxChunkTextLength,
        EnableWarmup = src.EnableWarmup,
        EnableEmbeddingDimensionVerification = src.EnableEmbeddingDimensionVerification,
        ContentReferences = new ContentReferenceVectorOptions
        {
            GeneratedDocument = new ContentReferenceTypeOptions
            {
                EmbeddingModelDeploymentName = src.ContentReferences.GeneratedDocument.EmbeddingModelDeploymentName,
                EmbeddingDimensionsOverride = src.ContentReferences.GeneratedDocument.EmbeddingDimensionsOverride
            },
            GeneratedSection = new ContentReferenceTypeOptions
            {
                EmbeddingModelDeploymentName = src.ContentReferences.GeneratedSection.EmbeddingModelDeploymentName,
                EmbeddingDimensionsOverride = src.ContentReferences.GeneratedSection.EmbeddingDimensionsOverride
            },
            ReviewItem = new ContentReferenceTypeOptions
            {
                EmbeddingModelDeploymentName = src.ContentReferences.ReviewItem.EmbeddingModelDeploymentName,
                EmbeddingDimensionsOverride = src.ContentReferences.ReviewItem.EmbeddingDimensionsOverride
            },
            ExternalFile = new ContentReferenceTypeOptions
            {
                EmbeddingModelDeploymentName = src.ContentReferences.ExternalFile.EmbeddingModelDeploymentName,
                EmbeddingDimensionsOverride = src.ContentReferences.ExternalFile.EmbeddingDimensionsOverride
            },
            ExternalLinkAsset = new ContentReferenceTypeOptions
            {
                EmbeddingModelDeploymentName = src.ContentReferences.ExternalLinkAsset.EmbeddingModelDeploymentName,
                EmbeddingDimensionsOverride = src.ContentReferences.ExternalLinkAsset.EmbeddingDimensionsOverride
            }
        }
    };

    private static bool VectorStoreEquals(VectorStoreOptions a, VectorStoreOptions b)
    {
        if (a.StoreType != b.StoreType || a.ChunkSize != b.ChunkSize || a.ChunkOverlap != b.ChunkOverlap || a.MaxSearchResults != b.MaxSearchResults ||
            a.MinRelevanceScore != b.MinRelevanceScore || a.DocumentChunkCacheTtlMinutes != b.DocumentChunkCacheTtlMinutes ||
            a.VectorSize != b.VectorSize || a.EnableFileNameDocIdCacheIndex != b.EnableFileNameDocIdCacheIndex ||
            a.ScoreCutoff != b.ScoreCutoff || a.MinResultsBeforeCutoff != b.MinResultsBeforeCutoff || a.EnableHybridScoring != b.EnableHybridScoring ||
            Math.Abs(a.HybridVectorWeight - b.HybridVectorWeight) > 0.0001 || a.MaxChunkTextLength != b.MaxChunkTextLength ||
            a.EnableWarmup != b.EnableWarmup || a.EnableEmbeddingDimensionVerification != b.EnableEmbeddingDimensionVerification)
        {
            return false;
        }
        return a.ContentReferences.GeneratedDocument.EmbeddingModelDeploymentName == b.ContentReferences.GeneratedDocument.EmbeddingModelDeploymentName &&
               a.ContentReferences.GeneratedDocument.EmbeddingDimensionsOverride == b.ContentReferences.GeneratedDocument.EmbeddingDimensionsOverride &&
               a.ContentReferences.GeneratedSection.EmbeddingModelDeploymentName == b.ContentReferences.GeneratedSection.EmbeddingModelDeploymentName &&
               a.ContentReferences.GeneratedSection.EmbeddingDimensionsOverride == b.ContentReferences.GeneratedSection.EmbeddingDimensionsOverride &&
               a.ContentReferences.ReviewItem.EmbeddingModelDeploymentName == b.ContentReferences.ReviewItem.EmbeddingModelDeploymentName &&
               a.ContentReferences.ReviewItem.EmbeddingDimensionsOverride == b.ContentReferences.ReviewItem.EmbeddingDimensionsOverride &&
               a.ContentReferences.ExternalFile.EmbeddingModelDeploymentName == b.ContentReferences.ExternalFile.EmbeddingModelDeploymentName &&
               a.ContentReferences.ExternalFile.EmbeddingDimensionsOverride == b.ContentReferences.ExternalFile.EmbeddingDimensionsOverride &&
               a.ContentReferences.ExternalLinkAsset.EmbeddingModelDeploymentName == b.ContentReferences.ExternalLinkAsset.EmbeddingModelDeploymentName &&
               a.ContentReferences.ExternalLinkAsset.EmbeddingDimensionsOverride == b.ContentReferences.ExternalLinkAsset.EmbeddingDimensionsOverride;
    }

    private async Task SaveFrontendAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:FrontEnd:SiteName", _frontendOptions.SiteName ?? string.Empty }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        SnapshotInitialState();
        SnackBar.Add("Frontend options saved.", Severity.Success);
    }

    private async Task SaveFeaturesAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableMassDocumentProduction", _featureFlags.EnableMassDocumentProduction.ToString() },
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableReviews", _featureFlags.EnableReviews.ToString() },
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableReferenceFrontend", _featureFlags.EnableReferenceFrontend.ToString() },
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableContentReferences", _featureFlags.EnableContentReferences.ToString() },
                { "ServiceConfiguration:GreenlightServices:FeatureFlags:EnableExternalDataView", _featureFlags.EnableExternalDataView.ToString() }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        try { await NavMenuStateService.RefreshAllAsync(); } catch { }
        SnapshotInitialState();
        SnackBar.Add("Feature flags saved.", Severity.Success);
    }

    private async Task SaveScalabilityAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:Scalability:NumberOfValidationWorkers", _scalabilityOptions.NumberOfValidationWorkers.ToString() },
                { "ServiceConfiguration:GreenlightServices:Scalability:NumberOfGenerationWorkers", _scalabilityOptions.NumberOfGenerationWorkers.ToString() },
                { "ServiceConfiguration:GreenlightServices:Scalability:NumberOfIngestionWorkers", _scalabilityOptions.NumberOfIngestionWorkers.ToString() },
                { "ServiceConfiguration:GreenlightServices:Scalability:NumberOfReviewWorkers", _scalabilityOptions.NumberOfReviewWorkers.ToString() }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        SnapshotInitialState();
        SnackBar.Add("Scalability options saved.", Severity.Success);
    }

    private async Task SaveVectorStoreAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:VectorStore:ChunkSize", _vectorStoreOptions.ChunkSize.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ChunkOverlap", _vectorStoreOptions.ChunkOverlap.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:MaxSearchResults", _vectorStoreOptions.MaxSearchResults.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:MinRelevanceScore", _vectorStoreOptions.MinRelevanceScore.ToString(System.Globalization.CultureInfo.InvariantCulture) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:DocumentChunkCacheTtlMinutes", _vectorStoreOptions.DocumentChunkCacheTtlMinutes.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:VectorSize", _vectorStoreOptions.VectorSize.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:EnableFileNameDocIdCacheIndex", _vectorStoreOptions.EnableFileNameDocIdCacheIndex.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ScoreCutoff", _vectorStoreOptions.ScoreCutoff?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? string.Empty },
                { "ServiceConfiguration:GreenlightServices:VectorStore:MinResultsBeforeCutoff", _vectorStoreOptions.MinResultsBeforeCutoff.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:EnableHybridScoring", _vectorStoreOptions.EnableHybridScoring.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:HybridVectorWeight", _vectorStoreOptions.HybridVectorWeight.ToString(System.Globalization.CultureInfo.InvariantCulture) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:MaxChunkTextLength", _vectorStoreOptions.MaxChunkTextLength.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:EnableWarmup", _vectorStoreOptions.EnableWarmup.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:EnableEmbeddingDimensionVerification", _vectorStoreOptions.EnableEmbeddingDimensionVerification.ToString() },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:GeneratedDocument:EmbeddingModelDeploymentName", _vectorStoreOptions.ContentReferences.GeneratedDocument.EmbeddingModelDeploymentName ?? string.Empty },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:GeneratedDocument:EmbeddingDimensionsOverride", (_vectorStoreOptions.ContentReferences.GeneratedDocument.EmbeddingDimensionsOverride?.ToString() ?? string.Empty) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:GeneratedSection:EmbeddingModelDeploymentName", _vectorStoreOptions.ContentReferences.GeneratedSection.EmbeddingModelDeploymentName ?? string.Empty },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:GeneratedSection:EmbeddingDimensionsOverride", (_vectorStoreOptions.ContentReferences.GeneratedSection.EmbeddingDimensionsOverride?.ToString() ?? string.Empty) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:ReviewItem:EmbeddingModelDeploymentName", _vectorStoreOptions.ContentReferences.ReviewItem.EmbeddingModelDeploymentName ?? string.Empty },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:ReviewItem:EmbeddingDimensionsOverride", (_vectorStoreOptions.ContentReferences.ReviewItem.EmbeddingDimensionsOverride?.ToString() ?? string.Empty) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:ExternalFile:EmbeddingModelDeploymentName", _vectorStoreOptions.ContentReferences.ExternalFile.EmbeddingModelDeploymentName ?? string.Empty },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:ExternalFile:EmbeddingDimensionsOverride", (_vectorStoreOptions.ContentReferences.ExternalFile.EmbeddingDimensionsOverride?.ToString() ?? string.Empty) },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:ExternalLinkAsset:EmbeddingModelDeploymentName", _vectorStoreOptions.ContentReferences.ExternalLinkAsset.EmbeddingModelDeploymentName ?? string.Empty },
                { "ServiceConfiguration:GreenlightServices:VectorStore:ContentReferences:ExternalLinkAsset:EmbeddingDimensionsOverride", (_vectorStoreOptions.ContentReferences.ExternalLinkAsset.EmbeddingDimensionsOverride?.ToString() ?? string.Empty) }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        SnapshotInitialState();
        SnackBar.Add("Vector store options saved.", Severity.Success);
    }

    private async Task SaveOcrOptionsAsync()
    {
        var request = new ConfigurationUpdateRequest
        {
            ConfigurationItems = new Dictionary<string, string>
            {
                { "ServiceConfiguration:GreenlightServices:DocumentIngestion:Ocr:AllowExternalDownloads", _ocrOptions.AllowExternalDownloads.ToString() },
                { "ServiceConfiguration:GreenlightServices:DocumentIngestion:Ocr:ExternalRepoBaseUrl", _ocrOptions.ExternalRepoBaseUrl ?? string.Empty },
                { "ServiceConfiguration:GreenlightServices:DocumentIngestion:Ocr:TessdataBlobContainer", _ocrOptions.TessdataBlobContainer ?? string.Empty },
                { "ServiceConfiguration:GreenlightServices:DocumentIngestion:Ocr:DefaultLanguages", string.Join(',', _selectedDefaultLanguages) }
            }
        };
        await ConfigurationApiClient.UpdateConfigurationAsync(request);
        SnapshotInitialState();
        SnackBar.Add("OCR options saved.", Severity.Success);
    }

    private IEnumerable<LanguageDisplayInfo> AllSelectableLanguages
    {
        get
        {
            var byCode = new Dictionary<string, LanguageDisplayInfo>(StringComparer.OrdinalIgnoreCase);
            foreach (var l in _cachedLanguages)
            {
                if (!byCode.ContainsKey(l.Code))
                {
                    byCode[l.Code] = l;
                }
            }
            foreach (var code in _selectedDefaultLanguages)
            {
                if (!byCode.ContainsKey(code))
                {
                    byCode[code] = new LanguageDisplayInfo { Code = code, Label = code, EnglishName = string.Empty };
                }
            }
            return byCode.Values.OrderBy(v => v.Label);
        }
    }

    private bool IsLanguageVisible(LanguageDisplayInfo lang)
    {
        if (string.IsNullOrWhiteSpace(_languageFilter)) return true;
        var f = _languageFilter.Trim();
        return lang.Code.Contains(f, StringComparison.OrdinalIgnoreCase) ||
               (!string.IsNullOrWhiteSpace(lang.EnglishName) && lang.EnglishName.Contains(f, StringComparison.OrdinalIgnoreCase)) ||
               (!string.IsNullOrWhiteSpace(lang.Label) && lang.Label.Contains(f, StringComparison.OrdinalIgnoreCase));
    }

    private async Task RefreshCachedLanguagesAsync()
    {
        try
        {
            var languages = await ConfigurationApiClient.GetCachedOcrLanguagesAsync();
            _cachedLanguages = languages ?? new List<LanguageDisplayInfo>();
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Failed to refresh OCR languages: {ex.Message}", Severity.Error);
        }
    }

    private async Task DownloadLanguageAsync()
    {
        try
        {
            var code = _languageCodeToDownload?.Trim();
            if (string.IsNullOrWhiteSpace(code)) return;
            await ConfigurationApiClient.DownloadOcrLanguageAsync(code);
            _languageCodeToDownload = string.Empty;
            await RefreshCachedLanguagesAsync();
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Failed to download language: {ex.Message}", Severity.Error);
        }
    }

    private Task OnSelectedDefaultLanguagesChanged(IEnumerable<string> values)
    {
        _selectedDefaultLanguages = values != null
            ? new HashSet<string>(values, StringComparer.OrdinalIgnoreCase)
            : new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        return Task.CompletedTask;
    }

    private bool _suppressSnapshot = false;
    private async Task SaveAllAsync()
    {
        try
        {
            _suppressSnapshot = true;
            var summaryLines = new List<string>();
            var compMessage = await _coordinator.BuildUnifiedSnackbarAsync();
            if (!string.IsNullOrWhiteSpace(compMessage) && compMessage != "No changes to save.")
            {
                summaryLines.Add(compMessage);
            }
            await _coordinator.SaveAllAsync(new[] { "MCP" });
            _suppressSnapshot = false;
            SnapshotInitialState();
            var message = summaryLines.Count == 0 ? "No changes to save." : string.Join("\n", summaryLines);
            SnackBar.Add(message, Severity.Success);
        }
        catch (OperationCanceledException)
        {
            _suppressSnapshot = false;
            SnackBar.Add("Save canceled.", Severity.Info);
        }
        catch (Exception ex)
        {
            _suppressSnapshot = false;
            await DialogService.ShowMessageBox("Error", $"Failed to save configuration: {ex.Message}");
        }
    }

    private async Task LoadSecretsInfoAsync()
    {
        try
        {
            _azureMapsKeyInfo = await ConfigurationApiClient.GetSecretOverrideInfoAsync("ServiceConfiguration:AzureMaps:Key");
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Failed to load Azure Maps key info: {ex.Message}", Severity.Warning);
        }
    }

    private async Task SetAzureMapsKeyOverrideAsync()
    {
        if (string.IsNullOrWhiteSpace(_azureMapsKeyOverride))
        {
            SnackBar.Add("Please enter an Azure Maps API key.", Severity.Warning);
            return;
        }
        try
        {
            var request = new SecretOverrideRequest
            {
                ConfigurationKey = "ServiceConfiguration:AzureMaps:Key",
                SecretValue = _azureMapsKeyOverride,
                Description = "Azure Maps API key override set via configuration UI"
            };
            await ConfigurationApiClient.SetSecretOverrideAsync(request);
            _azureMapsKeyOverride = string.Empty;
            await LoadSecretsInfoAsync();
            SnackBar.Add("Azure Maps API key override set successfully.", Severity.Success);
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Failed to set Azure Maps API key override: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemoveAzureMapsKeyOverrideAsync()
    {
        try
        {
            await ConfigurationApiClient.RemoveSecretOverrideAsync("ServiceConfiguration:AzureMaps:Key");
            await LoadSecretsInfoAsync();
            SnackBar.Add("Azure Maps API key override removed. Using default configuration.", Severity.Success);
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Failed to remove Azure Maps API key override: {ex.Message}", Severity.Error);
        }
    }

    private int _activeCrReindexCount = 0;
    private async Task RefreshActiveCrReindexCountAsync()
    {
        try
        {
            var types = new[]
            {
                ContentReferenceType.GeneratedDocument,
                ContentReferenceType.GeneratedSection,
                ContentReferenceType.ReviewItem,
                ContentReferenceType.ExternalFile,
                ContentReferenceType.ExternalLinkAsset
            };
            var tasks = types.Select(t => ContentReferenceReindexApiClient.GetStateAsync(t));
            var states = await Task.WhenAll(tasks);
            _activeCrReindexCount = states.Count(s => s != null && s.Running);
        }
        catch
        {
            _activeCrReindexCount = 0;
        }
    }

    private void OpenContentReferenceReindexDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true };
        DialogService.Show<Microsoft.Greenlight.Web.DocGen.Client.Components.ContentReferenceReindexDialog>("Content Reference Reindex", options: options);
    }

    private async Task HandleCardSelection(ConfigSection section)
    {
        _isAnimating = true;
        StateHasChanged();
        await Task.Delay(400);
        _section = section;
        _isCardView = false;
        _isAnimating = false;
        StateHasChanged();
    }

    private void HandleSectionChange(ConfigSection section)
    {
        _section = section;
        StateHasChanged();
    }

    private void HandleMenuExpand()
    {
        _isCardView = true;
        StateHasChanged();
    }
}
