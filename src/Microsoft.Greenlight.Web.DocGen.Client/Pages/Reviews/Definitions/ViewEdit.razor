@page "/reviews/{ReviewIdString}/view"
@page "/reviews/{ReviewIdString}/edit"
@page "/reviews/{ReviewIdString}"
@page "/reviews/add"

@using System.Text.Json
@inject IReviewApiClient ReviewApiClient
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudPaper class="pa-4">
    <MudCardHeader>
        <CardHeaderContent>
            @if (EditMode)
            {
                <MudTextField Margin="Margin.Normal" Label="Title" @bind-Value="@CurrentReviewDefinitionInfo.Title" />
                <MudTextField Margin="Margin.Normal" Label="Description" Lines="2" @bind-Value="@CurrentReviewDefinitionInfo.Description" />
            }
            else
            {
                <MudText Typo="Typo.h4">@CurrentReviewDefinitionInfo?.Title</MudText>
                <MudText Typo="Typo.body1">@CurrentReviewDefinitionInfo?.Description</MudText>
            }
        </CardHeaderContent>
        <CardHeaderActions>
            @if (!EditMode)
            {
                <MudTooltip Text="Edit">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   OnClick="EnableEditing" />
                </MudTooltip>
            }
        </CardHeaderActions>
    </MudCardHeader>

    <MudDivider Class="mb-4" />

    @if (CurrentReviewDefinitionInfo?.ReviewQuestions.Count > 0)
    {
        <MudText Typo="Typo.h6" Class="mb-3">@(EditMode ? "Edit Review Items" : "Review Items")</MudText>

        <MudList Dense="true" Clickable="@EditMode">
            @for (int i = 0; i < CurrentReviewDefinitionInfo?.ReviewQuestions.Count(); i++)
            {
                var questionIndex = i;
                var reviewQuestionInfo = CurrentReviewDefinitionInfo?.ReviewQuestions[i];
                var itemNumber = questionIndex + 1;

                <MudPaper Class="pa-3 mb-3" Outlined="true">
                    <div class="d-flex align-center mb-1">
                        <MudIcon Icon="@(reviewQuestionInfo.QuestionType == ReviewQuestionType.Question ? Icons.Material.Filled.QuestionAnswer : Icons.Material.Filled.Assignment)"
                                 Color="Color.Primary"
                                 Size="Size.Small"
                                 Class="mr-2" />
                        <MudText Typo="Typo.h6">Item @itemNumber: @(reviewQuestionInfo.QuestionType == ReviewQuestionType.Question ? "Question" : "Requirement")</MudText>

                        @if (EditMode)
                        {
                            <MudSpacer />
                            <MudTooltip Text="Delete Review Item">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="() => DeleteReviewItem(reviewQuestionInfo)" />
                            </MudTooltip>
                        }
                    </div>

                    @if (EditMode)
                    {
                        <MudRadioGroup @bind-Value="reviewQuestionInfo.QuestionType" T="ReviewQuestionType" Class="mb-2">
                            <MudRadio Value="@ReviewQuestionType.Requirement" Color="Color.Primary" UnCheckedColor="Color.Default">Requirement</MudRadio>
                            <MudRadio Value="@ReviewQuestionType.Question" Color="Color.Primary" UnCheckedColor="Color.Default">Question</MudRadio>
                        </MudRadioGroup>

                        <MudTextField @bind-Value="@reviewQuestionInfo.Question"
                                      Lines="2"
                                      MaxLines="10"
                                      AutoGrow="true"
                                      Label="@reviewQuestionInfo.QuestionType.ToString()"
                                      Variant="Variant.Outlined"
                                      Class="mb-2" />

                        <MudTextField @bind-Value="@reviewQuestionInfo.Rationale"
                                      Label="Rationale"
                                      Lines="2"
                                      MaxLines="10"
                                      AutoGrow="true"
                                      Variant="Variant.Outlined" />
                    }
                    else
                    {
                        <MudCard Elevation="0" Class="pa-0">
                            <MudText Class="mb-1"><strong>@reviewQuestionInfo.Question</strong></MudText>
                            @if (!string.IsNullOrEmpty(reviewQuestionInfo.Rationale))
                            {
                                <MudText Typo="Typo.body2" Class="mud-text-secondary">Rationale: @reviewQuestionInfo.Rationale</MudText>
                            }
                        </MudCard>
                    }
                </MudPaper>
            }
        </MudList>
    }
    else if (EditMode)
    {
        <MudAlert Severity="Severity.Info" Class="mb-3">No review items added yet. Use the button below to add a question or requirement.</MudAlert>
    }

    @if (EditMode)
    {
        <MudButton StartIcon="@Icons.Material.Filled.Add"
                   Variant="Variant.Outlined"
                   Color="Color.Primary"
                   OnClick="() => AddNewReviewItem()"
                   Class="mb-4">Add New Review Item</MudButton>

        <MudDivider Class="my-4" />

        <MudCardActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveReviewDefinition">Save</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
        </MudCardActions>
    }
</MudPaper>

@code {
    [Parameter] public string? ReviewIdString { get; set; }
    [Parameter] public bool EditMode { get; set; } = false;
    private ReviewDefinitionInfo? OriginalReviewDefinitionInfo { get; set; }
    private ReviewDefinitionInfo? CurrentReviewDefinitionInfo { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(ReviewIdString) && Guid.TryParse(ReviewIdString, out var reviewId) && reviewId != Guid.Empty)
        {
            OriginalReviewDefinitionInfo = await ReviewApiClient.GetReviewById(reviewId);
            CurrentReviewDefinitionInfo = CloneReviewDefinition(OriginalReviewDefinitionInfo);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Add new review definition set up
        if (Navigation.Uri.Contains("/reviews/add"))
        {
            Guid reviewId = Guid.NewGuid();
            CurrentReviewDefinitionInfo = new ReviewDefinitionInfo
            {
                Id = reviewId,
                Title = "",
                ReviewQuestions = new List<ReviewQuestionInfo>()
            };
            AddNewReviewItem();
            EditMode = true;
            await InvokeAsync(StateHasChanged);
            return;
        }

        // Existing review definition set up
        if (!string.IsNullOrEmpty(ReviewIdString))
        {
            // If we are in edit mode for an existing review definition
            if (Navigation.Uri.Contains("/edit"))
            {
                EditMode = true;
            }
            await InvokeAsync(StateHasChanged);
            return;
        }
    }

    private ReviewDefinitionInfo? CloneReviewDefinition(ReviewDefinitionInfo? reviewDefinition)
    {
        return reviewDefinition != null ? JsonSerializer.Deserialize<ReviewDefinitionInfo>(JsonSerializer.Serialize(reviewDefinition)) : null;
    }

    private void EnableEditing()
    {
        Navigation.NavigateTo($"/reviews/{ReviewIdString}/edit");
        EditMode = true;
        StateHasChanged();
    }

    private void AddNewReviewItem()
    {
        CurrentReviewDefinitionInfo!.ReviewQuestions.Add(new ReviewQuestionInfo()
        {
            Id = Guid.NewGuid(),
            Question = "",
            ReviewId = CurrentReviewDefinitionInfo.Id,
            QuestionType = ReviewQuestionType.Requirement
        });
    }

    private void DeleteReviewItem(ReviewQuestionInfo item)
    {
        CurrentReviewDefinitionInfo!.ReviewQuestions.Remove(item);
    }

    private async Task SaveReviewDefinition()
    {
        if (CurrentReviewDefinitionInfo != null)
        {
            if (Navigation.Uri.Contains("/add"))
            {
                ReviewDefinitionInfo? savedReviewDefinitionInfo = await ReviewApiClient.CreateReview(CurrentReviewDefinitionInfo);
                if (savedReviewDefinitionInfo is not null)
                {
                    Navigation.NavigateTo($"/reviews/{savedReviewDefinitionInfo.Id}/edit");
                    EditMode = true;
                    await InvokeAsync(StateHasChanged);
                }
                else
                {
                    await DialogService.ShowMessageBox("Error", "Failed to create review definition.");
                }
            }
            else if ((Navigation.Uri.Contains("/edit") || Navigation.Uri.Contains("/view")) && ReviewIdString is not null)
            {
                var changeRequest = CreateChangeRequest(OriginalReviewDefinitionInfo, CurrentReviewDefinitionInfo);

                OriginalReviewDefinitionInfo = await ReviewApiClient.UpdateReview(Guid.Parse(ReviewIdString), changeRequest);
                CurrentReviewDefinitionInfo = CloneReviewDefinition(OriginalReviewDefinitionInfo);

                Navigation.NavigateTo($"/reviews/{ReviewIdString}/edit");
                EditMode = true;

                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private ReviewChangeRequest CreateChangeRequest(ReviewDefinitionInfo? originalReviewDefinitionInfo, ReviewDefinitionInfo? currentReviewDefinitionInfo)
    {
        var changeRequest = new ReviewChangeRequest
        {
            ReviewDefinition = currentReviewDefinitionInfo!
        };

        if (originalReviewDefinitionInfo == null || currentReviewDefinitionInfo == null)
        {
            changeRequest.ReviewDefinition = currentReviewDefinitionInfo!;
            return changeRequest;
        }

        if (!originalReviewDefinitionInfo.Equals(currentReviewDefinitionInfo))
        {
            changeRequest.ReviewDefinition = currentReviewDefinitionInfo;
        }

        var changedItems = new List<ReviewQuestionInfo>();
        var deletedItems = new List<ReviewQuestionInfo>();

        CompareItems(originalReviewDefinitionInfo.ReviewQuestions, currentReviewDefinitionInfo.ReviewQuestions, changedItems, deletedItems);

        changeRequest.ChangedOrAddedQuestions = changedItems;
        changeRequest.DeletedQuestions = deletedItems;

        return changeRequest;
    }

    private void CompareItems(List<ReviewQuestionInfo> originalItems, List<ReviewQuestionInfo> currentItems, List<ReviewQuestionInfo> changedItems, List<ReviewQuestionInfo> deletedItems)
    {
        var originalItemIds = originalItems.Select(o => o.Id).ToHashSet();
        var currentItemIds = currentItems.Select(c => c.Id).ToHashSet();

        foreach (var currentItem in currentItems)
        {
            var originalItem = originalItems.FirstOrDefault(o => o.Id == currentItem.Id);
            if (originalItem == null || !currentItem.Equals(originalItem))
            {
                changedItems.Add(currentItem);
            }
        }

        foreach (var originalItem in originalItems)
        {
            if (!currentItemIds.Contains(originalItem.Id))
            {
                deletedItems.Add(originalItem);
            }
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/reviews");
        StateHasChanged();
    }
}
