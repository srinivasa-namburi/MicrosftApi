@inherits LayoutComponentBase
@using Microsoft.AspNetCore.SignalR.Client
@inject ILogger<MainLayout> Logger
@inject IAuthorizationApiClient AuthorizationApiClient
@inject IConfigurationApiClient ConfigurationApiClient
@inject SignalRConnectionService SignalRConnectionService

<MyMudThemeProvider @bind-IsDarkMode="@IsDarkMode" />
<MyMudProviders />

<MudLayout Class="@(IsDarkMode ? "dark-mode" : "light-mode")">
    <MudAppBar Elevation="3">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudSpacer />
        <MudSwitch @bind-Value="IsDarkMode" Color="Color.Primary" Class="ma-1" T="bool" ThumbIcon="@Icons.Material.Filled.WbSunny" />
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" Elevation="3">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">@_siteName</MudText>
        </MudDrawerHeader>
        <NavMenu />
    </MudDrawer>
    <CascadingValue TValue="HubConnection" Value="@HubConnection">
        <CascadingValue Name="IsDarkMode" Value="IsDarkMode">
            <MudMainContent>
                <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-6 pt-6">
                    @Body
                </MudContainer>
            </MudMainContent>
        </CascadingValue>
    </CascadingValue>
</MudLayout>

@code {
    bool _drawerOpen = true;

    private string _siteName = "Generative AI for Industry Permitting";

    public bool IsDarkMode { get; set; } = true;
    public HubConnection? HubConnection { get; set; }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }



    protected override async Task OnInitializedAsync()
    {
        // Try setting the site name from the configuration API
        try
        {
            var frontendOptions = await ConfigurationApiClient.GetFrontEndAsync();
            _siteName = frontendOptions.SiteName;
        }
        catch (Exception e)
        {
            Logger.LogError(e, "Failed to get site name from configuration API, keeping default name");
        }

        // Only start the SignalR connection if the user is authenticated
        try
        {
            await StartHubConnections();
        }
        catch (InvalidOperationException e)
        {
            // User isn't authenticated yet - ignore.
        }
    }

    private async Task StartHubConnections()
    {
        // Use the shared connection service to ensure a single shared HubConnection instance
        HubConnection = await SignalRConnectionService.GetOrCreateAsync();
    }
}
