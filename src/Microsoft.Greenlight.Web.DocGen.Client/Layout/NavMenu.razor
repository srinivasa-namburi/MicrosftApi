@* Copyright (c) Microsoft Corporation. All rights reserved. *@
@using Microsoft.Greenlight.Shared.Configuration
@using Microsoft.Greenlight.Shared.Contracts.Authorization

@inject ILogger<NavMenu> Logger
@inject INavMenuStateService NavMenuStateService
@implements IDisposable

<MudNavMenu Class="pt-2">
    @* Home *@
    <MudNavLink Href="" 
                Icon="fas fa-home" 
                IconColor="Color.Primary"
                Match="NavLinkMatch.All">Home</MudNavLink>

    @* Documents Section *@
    <PermissionView Permission="@PermissionKeys.GenerateDocument">
        <MudNavLink Href="/docs" 
                    Icon="fas fa-file-alt" 
                    IconColor="Color.Primary">All Documents</MudNavLink>

        @if (_documentProcesses.Any())
        {
            <MudNavGroup Title="Create Document" 
                         Icon="fas fa-plus-circle" 
                         IconColor="Color.Primary">
                @foreach (var dp in _documentProcesses)
                {
                    var url = $"/{dp.ShortName}/generate";
                    var description = !string.IsNullOrEmpty(dp.Description) ? dp.Description : dp.ShortName;
                    <MudNavLink Href="@url" 
                                Icon="fas fa-file-plus" 
                                IconColor="Color.Primary">@description</MudNavLink>
                }
            </MudNavGroup>
        }
    </PermissionView>

    @* CoPilot Section *@
    @if (_documentProcesses.Any())
    {
        <PermissionView Permission="@PermissionKeys.Chat">
            <MudNavGroup Title="AI Assistant" 
                         Icon="fas fa-brain" 
                         IconColor="Color.Success">
                @foreach (var dp in _documentProcesses)
                {
                    var url = $"/ai-assistant/{dp.ShortName}";
                    var description = !string.IsNullOrEmpty(dp.Description) ? dp.Description : dp.ShortName;
                    <MudNavLink Href="@url" 
                                Icon="@Icons.Material.Filled.Chat" 
                                IconColor="Color.Success">@description</MudNavLink>
                }
            </MudNavGroup>
        </PermissionView>
    }

    @* Reviews *@
    @if (_featureFlags.EnableReviews)
    {
        <PermissionView AnyPermissions="@(new[] { PermissionKeys.DefineReviews, PermissionKeys.ExecuteReviews })">
            <MudNavLink Href="/reviews" 
                        Icon="fas fa-clipboard-check" 
                        IconColor="Color.Primary">Reviews</MudNavLink>
        </PermissionView>
    }

    @* Mass Document Production *@
    @if (_featureFlags.EnableMassDocumentProduction)
    {
        <PermissionView Permission="@PermissionKeys.GenerateDocument">
            <MudNavLink Href="/mass-document-creation" 
                        Icon="fas fa-layer-group" 
                        IconColor="Color.Primary">Mass Document Creation</MudNavLink>
        </PermissionView>
    }

    @* Administration Section *@
    <PermissionView AnyPermissions="@(new[] { PermissionKeys.AlterDocumentProcessesAndLibraries, PermissionKeys.AlterSystemConfiguration, PermissionKeys.ManageUsersAndRoles })">
        <MudDivider Class="my-2" />
        <MudNavGroup Title="Administration" 
                     Icon="fas fa-cog" 
                     IconColor="Color.Secondary"
                     data-testid="admin-nav-group">
            <PermissionView Permission="@PermissionKeys.AlterDocumentProcessesAndLibraries">
                <MudNavLink Href="/document-processes" 
                            Icon="fas fa-cogs" 
                            IconColor="Color.Secondary">Document Processes</MudNavLink>
            </PermissionView>
            <PermissionView Permission="@PermissionKeys.AlterDocumentProcessesAndLibraries">
                <MudNavLink Href="/document-libraries" 
                            Icon="fas fa-book" 
                            IconColor="Color.Secondary">Document Libraries</MudNavLink>
            </PermissionView>
            <PermissionView Permission="@PermissionKeys.AlterSystemConfiguration">
                <MudNavLink Href="/plugins" 
                            Icon="fas fa-plug" 
                            IconColor="Color.Secondary">MCP Servers</MudNavLink>
            </PermissionView>
            @if (_featureFlags.EnableExternalDataView)
            {
                <PermissionView Permission="@PermissionKeys.AlterSystemConfiguration">
                    <MudNavLink Href="/admin/external-data" 
                                Icon="fas fa-database" 
                                IconColor="Color.Secondary">External Data</MudNavLink>
                </PermissionView>
            }
            <PermissionView Permission="@PermissionKeys.AlterSystemConfiguration">
                <MudNavLink Href="/admin/configuration" 
                            Icon="fas fa-sliders-h" 
                            IconColor="Color.Secondary"
                            data-testid="configuration-nav-link">Configuration</MudNavLink>
            </PermissionView>
           
            <PermissionView Permission="@PermissionKeys.ManageUsersAndRoles">
                <MudNavLink Href="/admin/authorization" 
                            Icon="fas fa-shield-alt" 
                            IconColor="Color.Secondary">Authorization</MudNavLink>
            </PermissionView>
        </MudNavGroup>
    </PermissionView>
</MudNavMenu>

@code
{
    private List<DocumentProcessInfo> _documentProcesses = new();
    private ServiceConfigurationOptions.GreenlightServicesOptions.FeatureFlagsOptions _featureFlags = new();

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("NavMenu OnInitializedAsync starting");
        try
        {
            NavMenuStateService.NavMenuChanged += OnNavMenuStateChanged;
            Logger.LogInformation("Loading NavMenu data through state service");
            await LoadNavMenuDataAsync();
            Logger.LogInformation("NavMenu initialization completed. Document processes: {ProcessCount}", _documentProcesses.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during NavMenu initialization");
        }
    }

    private async Task LoadNavMenuDataAsync()
    {
        try
        {
            var processesTask = NavMenuStateService.GetDocumentProcessesAsync();
            var featureFlagsTask = NavMenuStateService.GetFeatureFlagsAsync();
            await Task.WhenAll(processesTask, featureFlagsTask);
            _documentProcesses = await processesTask;
            _featureFlags = await featureFlagsTask; // Always non-null now
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading NavMenu data");
        }
    }

    private async void OnNavMenuStateChanged()
    {
        Logger.LogInformation("NavMenu state changed, refreshing...");
        await LoadNavMenuDataAsync();
    }

    public void Dispose()
    {
        NavMenuStateService.NavMenuChanged -= OnNavMenuStateChanged;
    }
}
