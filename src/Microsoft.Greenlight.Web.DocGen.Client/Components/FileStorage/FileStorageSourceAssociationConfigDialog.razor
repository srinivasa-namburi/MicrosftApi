@* Copyright (c) Microsoft Corporation. All rights reserved. *@

@using Microsoft.Greenlight.Shared.Contracts.DTO.FileStorage
@using Microsoft.Greenlight.Shared.Contracts.Requests.FileStorage
@using Microsoft.Greenlight.Web.Shared.ServiceClients
@inject IFileStorageSourceApiClient FileStorageSourceApiClient
@inject ISnackbar Snackbar

@namespace Microsoft.Greenlight.Web.DocGen.Client.Components.FileStorage

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form">
            <MudStack Spacing="3">
                <MudAlert Severity="Severity.Info" Dense="true">
                    <strong>Configuring:</strong> @_associationName
                </MudAlert>

                <MudNumericField T="int" @bind-Value="_priority" 
                               Label="Priority" 
                               Min="0" Max="100"
                               HelperText="Lower numbers are processed first (0 = highest priority)" 
                               Immediate="true" />

                <MudSwitch @bind-Value="_isActive" 
                         Label="Active" 
                         Color="Color.Primary" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">Whether this storage source is active for this process/library</MudText>

                <MudDivider />

                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle1">Upload Configuration</MudText>
                    
                    <MudSwitch @bind-Value="_acceptsUploads" 
                             Label="Accepts Uploads" 
                             Color="Color.Success" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Allow file uploads to this storage source from the user interface</MudText>

                    @if (_acceptsUploads)
                    {
                        <MudAlert Severity="Severity.Warning" Dense="true">
                            <strong>Note:</strong> Only one storage source per @(_isDocumentProcess ? "document process" : "document library") can accept uploads. 
                            Enabling this will disable uploads for any other source.
                        </MudAlert>
                    }
                </MudStack>
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save" Disabled="_isSaving">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Update
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public DocumentProcessFileStorageSourceInfo? ProcessAssociation { get; set; }
    [Parameter] public DocumentLibraryFileStorageSourceInfo? LibraryAssociation { get; set; }

    private MudForm _form = null!;
    private bool _isSaving = false;
    private bool _isDocumentProcess;
    private string _associationName = string.Empty;
    
    // Form fields
    private int _priority;
    private bool _isActive;
    private bool _acceptsUploads;

    protected override void OnInitialized()
    {
        _isDocumentProcess = ProcessAssociation != null;
        
        if (ProcessAssociation != null)
        {
            _associationName = ProcessAssociation.FileStorageSourceName;
            _priority = ProcessAssociation.Priority;
            _isActive = ProcessAssociation.IsActive;
            _acceptsUploads = ProcessAssociation.AcceptsUploads;
        }
        else if (LibraryAssociation != null)
        {
            _associationName = LibraryAssociation.FileStorageSourceName;
            _priority = LibraryAssociation.Priority;
            _isActive = LibraryAssociation.IsActive;
            _acceptsUploads = LibraryAssociation.AcceptsUploads;
        }
    }

    private async Task Save()
    {
        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }

        _isSaving = true;
        StateHasChanged();

        try
        {
            if (ProcessAssociation != null)
            {
                // Client-side protection: ensure only one process association accepts uploads
                if (_acceptsUploads)
                {
                    var list = await FileStorageSourceApiClient.GetFileStorageSourceAssociationsByProcessIdAsync(ProcessAssociation.DocumentProcessId);
                    foreach (var assoc in list.Where(a => a.AcceptsUploads && a.FileStorageSourceId != ProcessAssociation.FileStorageSourceId))
                    {
                        var clrReq = new UpdateProcessSourceAssociationRequest { Priority = assoc.Priority, IsActive = assoc.IsActive, AcceptsUploads = false };
                        await FileStorageSourceApiClient.UpdateProcessSourceAssociationAsync(ProcessAssociation.DocumentProcessId, assoc.FileStorageSourceId, clrReq);
                    }
                }
                var request = new UpdateProcessSourceAssociationRequest
                {
                    Priority = _priority,
                    IsActive = _isActive,
                    AcceptsUploads = _acceptsUploads
                };

                var updated = await FileStorageSourceApiClient.UpdateProcessSourceAssociationAsync(
                    ProcessAssociation.DocumentProcessId, 
                    ProcessAssociation.FileStorageSourceId, 
                    request);

                Snackbar.Add("Association updated successfully.", Severity.Success);
                MudDialog.Close(DialogResult.Ok(updated));
            }
            else if (LibraryAssociation != null)
            {
                if (_acceptsUploads)
                {
                    var list = await FileStorageSourceApiClient.GetFileStorageSourceAssociationsByLibraryIdAsync(LibraryAssociation.DocumentLibraryId);
                    foreach (var assoc in list.Where(a => a.AcceptsUploads && a.FileStorageSourceId != LibraryAssociation.FileStorageSourceId))
                    {
                        var clrReq = new UpdateLibrarySourceAssociationRequest { Priority = assoc.Priority, IsActive = assoc.IsActive, AcceptsUploads = false };
                        await FileStorageSourceApiClient.UpdateLibrarySourceAssociationAsync(LibraryAssociation.DocumentLibraryId, assoc.FileStorageSourceId, clrReq);
                    }
                }
                var request = new UpdateLibrarySourceAssociationRequest
                {
                    Priority = _priority,
                    IsActive = _isActive,
                    AcceptsUploads = _acceptsUploads
                };

                var updated = await FileStorageSourceApiClient.UpdateLibrarySourceAssociationAsync(
                    LibraryAssociation.DocumentLibraryId, 
                    LibraryAssociation.FileStorageSourceId, 
                    request);

                Snackbar.Add("Association updated successfully.", Severity.Success);
                MudDialog.Close(DialogResult.Ok(updated));
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating association: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
