@* Copyright (c) Microsoft Corporation. All rights reserved. *@

@using Microsoft.Greenlight.Shared.Contracts.DTO.FileStorage
@using Microsoft.Greenlight.Web.Shared.ServiceClients
@using Microsoft.Greenlight.Shared.Contracts.Authorization
@using Microsoft.Greenlight.Shared.Enums
@using Microsoft.Greenlight.Web.Shared.ServiceClients
@inject IFileStorageSourceApiClient FileStorageSourceApiClient
@inject IFileStorageHostApiClient FileStorageHostApiClient
@inject NavigationManager Nav

@namespace Microsoft.Greenlight.Web.DocGen.Client.Components.FileStorage

@if (_source == null)
{
    <MudPaper Class="pa-2 mb-2" Elevation="0">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="80px" Animation="Animation.Pulse" />
    </MudPaper>
}
else if (ViewMode == FileStorageSourceDisplayViewMode.Full)
{
    <MudPaper Class="pa-2 mb-2" Elevation="0">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Spacing="1">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.subtitle1">@_source.Name</MudText>
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Host: @_hostName (@_hostProvider)
                        </MudText>
                        <PermissionView Permission="@PermissionKeys.AlterSystemConfiguration">
                            <MudLink Href="/configuration" Target="_self">Edit Host</MudLink>
                        </PermissionView>
                    </MudStack>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Container: @_source.ContainerOrPath</MudText>
                    <MudStack Row="true" Spacing="1">
                        @foreach (var role in GetRoles())
                        {
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined">@role</MudChip>
                        }
                        @if (_source.IsDefault)
                        {
                            <MudChip T="string" Color="Color.Tertiary" Size="Size.Small" Variant="Variant.Outlined">Default</MudChip>
                        }
                        @if (!_source.IsActive)
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small" Variant="Variant.Outlined">Inactive</MudChip>
                        }
                        @if (_source.ShouldMoveFiles)
                        {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Outlined">Move Files</MudChip>
                        }
                    </MudStack>
                </MudStack>
            </MudStack>
            @if (OnEdit.HasDelegate)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => OnEdit.InvokeAsync(_source)" />
            }
        </MudStack>
        @if (!string.IsNullOrWhiteSpace(_source.Description))
        {
            <MudText Typo="Typo.caption" Class="mt-1">@_source.Description</MudText>
        }
    </MudPaper>
}

@if (_source != null && ViewMode == FileStorageSourceDisplayViewMode.Light)
{
    <MudPaper Class="pa-1 mb-1" Elevation="0">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudIcon Icon="@GetProviderIcon()" Color="Color.Primary" />
            <MudStack Spacing="0">
                <MudText Typo="Typo.caption">@_source.Name</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">@_source.ContainerOrPath</MudText>
            </MudStack>
        </MudStack>
    </MudPaper>
}

@code {
    [Parameter] public Guid? SourceId { get; set; }
    [Parameter] public FileStorageSourceInfo? Source { get; set; }
    [Parameter] public FileStorageSourceDisplayViewMode ViewMode { get; set; } = FileStorageSourceDisplayViewMode.Full;
    [Parameter] public EventCallback<FileStorageSourceInfo> OnEdit { get; set; }

    private FileStorageSourceInfo? _source;
    private string _hostName = string.Empty;
    private string _hostProvider = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        if (Source != null)
        {
            _source = Source;
            return;
        }
        if (SourceId.HasValue)
        {
            _source = await FileStorageSourceApiClient.GetFileStorageSourceByIdAsync(SourceId.Value);
        }
        if (_source != null)
        {
            try
            {
                var host = await FileStorageHostApiClient.GetFileStorageHostByIdAsync(_source.FileStorageHostId);
                if (host != null)
                {
                    _hostName = host.Name;
                    _hostProvider = host.ProviderType.ToString();
                }
            }
            catch
            {
                // Intentionally swallow exceptions for host lookup to avoid breaking display component
            }
        }
    }

    private string GetProviderIcon() => _hostProvider switch
    {
        nameof(FileStorageProviderType.BlobStorage) => Icons.Material.Filled.Cloud,
        nameof(FileStorageProviderType.LocalFileSystem) => Icons.Material.Filled.Folder,
        nameof(FileStorageProviderType.SharePoint) => Icons.Material.Filled.ShareLocation,
        _ => Icons.Material.Filled.Storage
    };

    private IEnumerable<string> GetRoles()
    {
        var roles = new List<FileStorageSourceDataType>();
        if (_source?.StorageSourceDataTypes?.Any() == true)
        {
            roles.AddRange(_source.StorageSourceDataTypes);
        }
        else if (_source != null)
        {
            roles.Add(_source.StorageSourceDataType);
        }
        return roles.Select(r => r.ToString());
    }
}
