@using Microsoft.Greenlight.Shared.Contracts.DTO.Document

@inject IContentNodeApiClient ContentNodeApiClient

@code {
    [Parameter] public ContentNodeInfo? Node { get; set; }
    [Parameter] public bool Recursive { get; set; } = false;
    [Parameter] public bool EnableReferenceFrontend { get; set; } = false;

    private ContentNodeSystemItemInfo? SystemItem { get; set; }
    private bool ShowSystemInfo = false;
    private bool IsPanelExpanded = false;
    private bool IsLoadingSystemInfo = false;
    private bool HasVersions = false;
    
    private ContentNodeBodyTextComponent? bodyTextComponent;

    private async void ToggleSystemInfo(ContentNodeInfo node)
    {
        if (IsLoadingSystemInfo) return;

        IsLoadingSystemInfo = true;
        await ShowReferenceInformation(node);
        node.ContentNodeSystemItem = SystemItem;
        ShowSystemInfo = !ShowSystemInfo;
        if (ShowSystemInfo)
        {
            IsPanelExpanded = true;
        }

        IsLoadingSystemInfo = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ShowReferenceInformation(ContentNodeInfo node)
    {
        if (SystemItem == null && node.ContentNodeSystemItemId != null)
        {
            SystemItem = await ContentNodeApiClient.GetContentNodeSystemItemAsync((Guid)node.ContentNodeSystemItemId);
        }

        await InvokeAsync(StateHasChanged);
    }

    private string GetPanelClass(ContentNodeType nodeType)
    {
        return nodeType switch
        {
            ContentNodeType.Title => "mt-2",
            ContentNodeType.Heading => "mt-2",
            ContentNodeType.BodyText => "mt-2",
            _ => ""
        };
    }
    
    protected override async Task OnInitializedAsync()
    {
        // Check if body text node has versions
        if (Node?.Type == ContentNodeType.BodyText && Node.ContentNodeVersionTrackerId.HasValue)
        {
            try
            {
                HasVersions = await ContentNodeApiClient.HasPreviousVersionsAsync(Node.Id);
            }
            catch
            {
                HasVersions = false;
            }
        }
    }
    
    private async Task HandleNodeUpdated(ContentNodeInfo updatedNode)
    {
        // Copy the updated properties to the current node
        if (Node != null)
        {
            Node.Text = updatedNode.Text;
            Node.ContentNodeVersionTrackerId = updatedNode.ContentNodeVersionTrackerId;
            HasVersions = true;
        }
        await InvokeAsync(StateHasChanged);
    }
}

@if (Node != null)
{
    if (Node.Type == ContentNodeType.Title || Node.Type == ContentNodeType.Heading)
    {
        <MudExpansionPanels>
            <MudExpansionPanel Class="@GetPanelClass(Node.Type)"
                               @bind-IsExpanded="IsPanelExpanded">
                <TitleContent>
                    <MudGrid>
                        <MudItem xs="1">
                            @if (Node.GenerationState == ContentNodeGenerationState.OutlineOnly)
                            {
                                <MudIcon Icon="@Icons.Material.Rounded.List" Color="Color.Info" Size="Size.Medium" />
                            }
                            else if (Node.GenerationState == ContentNodeGenerationState.InProgress)
                            {
                                <MudProgressCircular Indeterminate="true" Size="Size.Small" Color="Color.Info" />
                            }
                            else if (Node.GenerationState == ContentNodeGenerationState.Completed)
                            {
                                <MudIcon Icon="@Icons.Material.Rounded.CheckCircle" Color="Color.Success" Size="Size.Medium" />
                            }
                            else if (Node.GenerationState == ContentNodeGenerationState.Failed)
                            {
                                <MudIcon Icon="@Icons.Material.Rounded.Error" Color="Color.Error" Size="Size.Medium" />
                            }
                        </MudItem>

                        @if (Node.ContentNodeSystemItemId != null && EnableReferenceFrontend)
                        {
                            <MudItem xs="9">
                                @Node.Text
                            </MudItem>
                            <MudItem xs="2">
                                <MudTooltip Text="Reference information is available for this section. Click here to show it."
                                            Placement="Placement.Bottom">
                                    <MudIconButton OnClick="()=>ToggleSystemInfo(Node)"
                                                   Icon="@Icons.Material.Rounded.Info"
                                                   Color="Color.Info"
                                                   Size="Size.Small" />
                                </MudTooltip>
                            </MudItem>
                        }
                        else
                        {
                            <MudItem xs="11">
                                @Node.Text
                            </MudItem>
                        }
                    </MudGrid>
                </TitleContent>
                <ChildContent>
                    @if (Node.Children != null && Node.Children.Any() && Recursive)
                    {
                        @if (ShowSystemInfo && SystemItem != null && EnableReferenceFrontend)
                        {
                            <ContentNodeSystemInfoDisplayComponent SystemItem="@SystemItem" />
                        }

                        <div class="section-content">
                            @foreach (var childNode in Node.Children)
                            {
                                <ContentNodeDisplay Node="childNode"
                                                    Recursive="true"
                                                    EnableReferenceFrontend="@EnableReferenceFrontend" />
                            }
                        </div>
                    }
                </ChildContent>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
    else if (Node.Type == ContentNodeType.BodyText)
    {
        <MudCard Class="@($"{GetPanelClass(Node.Type)} body-text-card mb-3")">
            <MudCardContent>
                <div class="position-relative">
                    @if (HasVersions || Node.Type == ContentNodeType.BodyText)
                    {
                        <div class="content-node-actions">
                            @if (HasVersions)
                            {
                                <MudTooltip Text="View version history">
                                    <MudIconButton Icon="@Icons.Material.Filled.History" 
                                                Size="Size.Small" 
                                                Color="Color.Info" 
                                                OnClick="@(() => bodyTextComponent?.ShowVersionHistory())" />
                                </MudTooltip>
                            }
                            @if (Node.Type == ContentNodeType.BodyText)
                            {
                                <MudTooltip Text="Edit content">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                Size="Size.Small" 
                                                Color="Color.Primary" 
                                                OnClick="@(() => bodyTextComponent?.StartEdit())" />
                                </MudTooltip>
                            }
                        </div>
                    }
                    <ContentNodeBodyTextComponent @ref="bodyTextComponent" Node="@Node" OnNodeUpdated="@HandleNodeUpdated" />
                </div>
            </MudCardContent>
        </MudCard>
    }
}
