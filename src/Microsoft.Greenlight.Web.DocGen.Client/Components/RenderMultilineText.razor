@using Markdig
@using Markdig.Extensions.AutoLinks
@using Markdig.Renderers.Html
@using Markdig.Syntax
@using Markdig.Syntax.Inlines

@code {
    [Parameter]
    public string Value { get; set; } = default!;
}

@{
    // Clean control characters we don't want to render (e.g., form-feed used as page delimiters)
    var cleaned = (Value ?? string.Empty).Replace('\f', ' ');

    //We're not encoding the value here because we want to allow HTML in the markdown
    //var encodedValue = HttpUtility.HtmlEncode(Value ?? string.Empty);
    var encodedValue = cleaned;
    var markdownPipeline = new MarkdownPipelineBuilder()
                                    .UseAdvancedExtensions()
                                    .UseEmojiAndSmiley()
                                    .UseSmartyPants()
                                    .UseAutoLinks(options: new AutoLinkOptions()
                                            {
                                                OpenInNewWindow = true,
                                                UseHttpsForWWWLinks = true

                                            })
                                    .Build();

    MarkdownDocument document = Markdown.Parse(encodedValue, markdownPipeline);

    foreach (LinkInline link in document.Descendants<LinkInline>())
    {
        link.GetAttributes().AddPropertyIfNotExist("target", "_blank");
    }

    foreach (AutolinkInline link in document.Descendants<AutolinkInline>())
    {
        link.GetAttributes().AddPropertyIfNotExist("target", "_blank");
    }

    // Turn single line breaks (\n) into <br>. Don't do this if there's another \n immediately following it


    string html = document.ToHtml(markdownPipeline);
    
    var markupValue = new MarkupString(html);
    
    if (!string.IsNullOrEmpty(markupValue.Value))
    {
        @markupValue
    }
}
