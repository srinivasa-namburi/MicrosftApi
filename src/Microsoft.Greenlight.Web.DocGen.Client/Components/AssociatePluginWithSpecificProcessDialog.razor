// Copyright (c) Microsoft Corporation. All rights reserved.
@inject IPluginApiClient PluginApiClient
@inject ISnackbar Snackbar

<MudDialog Options="new DialogOptions { MaxWidth = MaxWidth.Small }">
    <TitleContent>
        <MudText Typo="Typo.h6">Associate Plugin with Document Process</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form">
            <MudSelect T="McpPluginInfo" @bind-Value="SelectedPlugin" Label="Select Plugin" Required="true">
                @foreach (var plugin in AvailablePlugins)
                {
                    <MudSelectItem Value="@plugin">@plugin.Name</MudSelectItem>
                }
            </MudSelect>

            @if (SelectedPlugin != null)
            {
                <MudSelect T="string" @bind-Value="SelectedVersion" Label="Select Version" Required="true" Disabled="KeepOnLatestVersion">
                    @foreach (var version in SelectedPlugin.Versions.OrderByDescending(v => v.Major).ThenByDescending(v => v.Minor).ThenByDescending(v => v.Patch))
                    {
                        var versionString = $"{version.Major}.{version.Minor}.{version.Patch}";
                        <MudSelectItem Value="@versionString">@versionString</MudSelectItem>
                    }
                </MudSelect>
                <MudCheckBox T="bool" @bind-Value="KeepOnLatestVersion" Label="Keep on latest version" Class="mt-2" />
            }

            <MudButton Class="mt-4" OnClick="@AssociatePlugin" Variant="Variant.Filled" Color="Color.Primary">Associate</MudButton>
        </MudForm>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public List<McpPluginInfo> AvailablePlugins { get; set; }
    [Parameter] public Guid ProcessId { get; set; }

    private MudForm form;
    private McpPluginInfo? SelectedPlugin;
    private string? SelectedVersion;
    private bool KeepOnLatestVersion = false;

    private async Task AssociatePlugin()
    {
        if (SelectedPlugin == null || (!KeepOnLatestVersion && string.IsNullOrWhiteSpace(SelectedVersion)))
        {
            Snackbar.Add("Please select a plugin and version.", Severity.Error);
            return;
        }

        try
        {
            McpPluginVersionInfo? versionInfo = null;
            int major = 0, minor = 0, patch = 0;
            if (KeepOnLatestVersion)
            {
                versionInfo = SelectedPlugin.LatestVersion;
                if (versionInfo == null)
                {
                    Snackbar.Add("No latest version available for this plugin.", Severity.Error);
                    return;
                }
            }
            else
            {
                var versionParts = SelectedVersion!.Split('.');
                if (versionParts.Length != 3 ||
                    !int.TryParse(versionParts[0], out major) ||
                    !int.TryParse(versionParts[1], out minor) ||
                    !int.TryParse(versionParts[2], out patch))
                {
                    Snackbar.Add("Invalid version format. Expected format: Major.Minor.Patch", Severity.Error);
                    return;
                }
                versionInfo = SelectedPlugin.Versions.FirstOrDefault(v =>
                    v.Major == major && v.Minor == minor && v.Patch == patch);
                if (versionInfo == null)
                {
                    Snackbar.Add("Invalid plugin version selected.", Severity.Error);
                    return;
                }
            }
            await PluginApiClient.AssociateMcpPluginWithDocumentProcessAsync(SelectedPlugin.Id, ProcessId, versionInfo, KeepOnLatestVersion);
            Snackbar.Add($"Plugin '{SelectedPlugin.Name}' associated successfully.", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error associating plugin: {ex.Message}", Severity.Error);
        }
    }
}
