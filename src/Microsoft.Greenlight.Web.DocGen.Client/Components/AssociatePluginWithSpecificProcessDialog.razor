@inject IPluginApiClient PluginApiClient
@inject ISnackbar Snackbar

<MudDialog MaxWidth="MaxWidth.Small">
    <TitleContent>
        <MudText Typo="Typo.h6">Associate Plugin with Document Process</MudText>
    </TitleContent>
    <DialogContent>
        <MudSelect T="McpPluginInfo" @bind-Value="SelectedPlugin" Label="Select Plugin" Required="true">
            @foreach (var plugin in AvailablePlugins)
            {
                <MudSelectItem Value="plugin">@plugin.Name</MudSelectItem>
            }
        </MudSelect>

        @if (SelectedPlugin != null)
        {
            <MudSelect T="string" @bind-Value="SelectedVersion" Label="Select Version" Required="true">
                @foreach (var version in SelectedPlugin.Versions.OrderByDescending(v => $"{v.Major}.{v.Minor}.{v.Patch}"))
                {
                    <MudSelectItem Value="@($"{version.Major}.{version.Minor}.{version.Patch}")">@($"{version.Major}.{version.Minor}.{version.Patch}")</MudSelectItem>
                }
            </MudSelect>
        }

        <MudButton OnClick="@AssociatePlugin" Variant="Variant.Filled" Color="Color.Primary">Associate</MudButton>

    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public List<McpPluginInfo> AvailablePlugins { get; set; }
    [Parameter] public Guid ProcessId { get; set; }

    private MudForm form;
    private McpPluginInfo? SelectedPlugin;
    private string? SelectedVersion;

    private async Task AssociatePlugin()
    {
        if (SelectedPlugin == null || SelectedVersion == null)
        {
            Snackbar.Add("Please select a plugin and version.", Severity.Error);
            return;
        }

        try
        {
            var versionParts = SelectedVersion.Split('.');
            if (versionParts.Length != 3 || 
                !int.TryParse(versionParts[0], out int major) ||
                !int.TryParse(versionParts[1], out int minor) ||
                !int.TryParse(versionParts[2], out int patch))
            {
                Snackbar.Add("Invalid version format. Expected format: Major.Minor.Patch", Severity.Error);
                return;
            }
            
            var versionInfo = SelectedPlugin.Versions.FirstOrDefault(v => 
                v.Major == major && v.Minor == minor && v.Patch == patch);
                
            if (versionInfo == null)
            {
                Snackbar.Add("Invalid plugin version selected.", Severity.Error);
                return;
            }
            
            await PluginApiClient.AssociateMcpPluginWithDocumentProcessAsync(SelectedPlugin.Id, ProcessId, versionInfo);
            Snackbar.Add($"Plugin '{SelectedPlugin.Name}' version '{SelectedVersion}' associated successfully.", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error associating plugin: {ex.Message}", Severity.Error);
        }
    }
}
