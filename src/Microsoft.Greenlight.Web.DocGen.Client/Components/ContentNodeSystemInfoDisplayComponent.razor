@using Microsoft.Greenlight.Shared.Contracts.DTO.Document
@inject Microsoft.Greenlight.Web.Shared.ServiceClients.IContentNodeApiClient ContentNodeApi

@code {
    [Parameter] public ContentNodeSystemItemInfo? SystemItem { get; set; }

    private readonly HashSet<Guid> _expandedPluginInputs = new();
    private readonly HashSet<Guid> _expandedPluginOutputs = new();

    private static string Truncate(string? value, int max = 400)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return string.Empty;
        }
        if (value.Length <= max)
        {
            return value;
        }
        return value.Substring(0, max) + "…";
    }

    private static bool IsTruncated(string? value, int max = 400) => !string.IsNullOrEmpty(value) && value.Length > max;

    private void TogglePluginInput(Guid id)
    {
        if (_expandedPluginInputs.Contains(id))
        {
            _expandedPluginInputs.Remove(id);
        }
        else
        {
            _expandedPluginInputs.Add(id);
        }
    }

    private void TogglePluginOutput(Guid id)
    {
        if (_expandedPluginOutputs.Contains(id))
        {
            _expandedPluginOutputs.Remove(id);
        }
        else
        {
            _expandedPluginOutputs.Add(id);
        }
    }

    private static List<VectorStoreSourceReferenceItemInfo> AsVectorItems(ContentNodeSystemItemInfo item)
    {
        return item.SourceReferences.OfType<VectorStoreSourceReferenceItemInfo>().ToList();
    }
}

@if (SystemItem != null)
{
    <MudPaper Class="pa-3 mb-3" Outlined="true">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h4">Reference Information</MudText>
            <MudDivider />

            @if (!string.IsNullOrWhiteSpace(SystemItem.ComputedUsedMainGenerationPrompt) || !string.IsNullOrWhiteSpace(SystemItem.ComputedSectionPromptInstructions))
            {
                <MudExpansionPanels Elevation="0">
                    @if (!string.IsNullOrWhiteSpace(SystemItem.ComputedUsedMainGenerationPrompt))
                    {
                        <MudExpansionPanel Text="Computed Used Main Generation Prompt">
                            <MudText Typo="Typo.body1">@SystemItem.ComputedUsedMainGenerationPrompt</MudText>
                        </MudExpansionPanel>
                    }
                    @if (!string.IsNullOrWhiteSpace(SystemItem.ComputedSectionPromptInstructions))
                    {
                        <MudExpansionPanel Text="Computed Section Prompt Instructions">
                            <MudText Typo="Typo.body1">@SystemItem.ComputedSectionPromptInstructions</MudText>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
            }

            @if (SystemItem.SourceReferences.Count > 0)
            {
                <MudText Typo="Typo.h5" Class="mt-2"><strong>Source References</strong></MudText>

                @* Kernel Memory Citations *@
                @if (SystemItem.SourceReferences.OfType<KernelMemoryDocumentSourceReferenceItemInfo>().Any())
                {
                    <MudPaper Class="pa-2 mb-2" Outlined="true">
                        <MudText Typo="Typo.subtitle1">Document References (Citations)</MudText>
                        <MudList T="object" Dense="true">
                            @foreach (var kernelMemoryItem in SystemItem.SourceReferences.OfType<KernelMemoryDocumentSourceReferenceItemInfo>())
                            {
                                <MudListItem T="object">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body2">
                                            <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined">@kernelMemoryItem.SourceReferenceType</MudChip>
                                            @if (!string.IsNullOrWhiteSpace(kernelMemoryItem.Description))
                                            {
                                                <span class="ms-2">@kernelMemoryItem.Description</span>
                                            }
                                        </MudText>

                                        @foreach (var citation in kernelMemoryItem.Citations)
                                        {
                                            <MudText Typo="Typo.caption"><strong>Kernel Memory Citation:</strong> @citation.SourceName</MudText>
                                        }
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                    </MudPaper>
                }

                @* Vector Store References (reused component) *@
                @if (SystemItem.SourceReferences.OfType<VectorStoreSourceReferenceItemInfo>().Any())
                {
                    var vectorItems = AsVectorItems(SystemItem);
                    <VectorStoreReferencesList Items="@vectorItems" Title="Vector Store Document References"/>
                }

                @* Plugin Execution References *@
                @if (SystemItem.SourceReferences.OfType<PluginSourceReferenceItemInfo>().Any())
                {
                    <MudPaper Class="pa-2 mb-2" Outlined="true">
                        <MudText Typo="Typo.subtitle1">Plugin Execution References</MudText>
                        <MudList T="object" Dense="true">
                            @foreach (var pluginItem in SystemItem.SourceReferences.OfType<PluginSourceReferenceItemInfo>())
                            {
                                <MudListItem T="object">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body2">
                                            <MudChip T="string" Color="Color.Secondary" Size="Size.Small" Variant="Variant.Outlined">@pluginItem.SourceReferenceType</MudChip>
                                            @if (!string.IsNullOrWhiteSpace(pluginItem.Description))
                                            {
                                                <span class="ms-2">@pluginItem.Description</span>
                                            }
                                        </MudText>
                                        @if (!string.IsNullOrWhiteSpace(pluginItem.PluginIdentifier))
                                        {
                                            <MudText Typo="Typo.caption"><strong>Plugin Identifier:</strong> @pluginItem.PluginIdentifier</MudText>
                                        }

                                        @if (!string.IsNullOrWhiteSpace(pluginItem.SourceInputJson))
                                        {
                                            var showInputButton = IsTruncated(pluginItem.SourceInputJson) || _expandedPluginInputs.Contains(pluginItem.Id);
                                            <MudText Typo="Typo.caption"><strong>Plugin inputs (@( _expandedPluginInputs.Contains(pluginItem.Id) ? "full" : "preview" )):</strong></MudText>
                                            @if (_expandedPluginInputs.Contains(pluginItem.Id))
                                            {
                                                <RenderMultilineText Value="@pluginItem.SourceInputJson" />
                                            }
                                            else
                                            {
                                                <RenderMultilineText Value="@Truncate(pluginItem.SourceInputJson, 400)" />
                                            }
                                            @if (showInputButton)
                                            {
                                                <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="() => TogglePluginInput(pluginItem.Id)">
                                                    @(_expandedPluginInputs.Contains(pluginItem.Id) ? "Show less" : "Show more")
                                                </MudButton>
                                            }
                                        }

                                        @if (!string.IsNullOrWhiteSpace(pluginItem.SourceOutput))
                                        {
                                            var showOutputButton = IsTruncated(pluginItem.SourceOutput) || _expandedPluginOutputs.Contains(pluginItem.Id);
                                            <MudText Typo="Typo.caption"><strong>Plugin output (@( _expandedPluginOutputs.Contains(pluginItem.Id) ? "full" : "preview" )):</strong></MudText>
                                            @if (_expandedPluginOutputs.Contains(pluginItem.Id))
                                            {
                                                <RenderMultilineText Value="@pluginItem.SourceOutput" />
                                            }
                                            else
                                            {
                                                <RenderMultilineText Value="@Truncate(pluginItem.SourceOutput, 400)" />
                                            }
                                            @if (showOutputButton)
                                            {
                                                <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="() => TogglePluginOutput(pluginItem.Id)">
                                                    @(_expandedPluginOutputs.Contains(pluginItem.Id) ? "Show less" : "Show more")
                                                </MudButton>
                                            }
                                        }
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                    </MudPaper>
                }
            }
            else
            {
                <MudAlert Severity="Severity.Info">No source references available.</MudAlert>
            }
        </MudStack>
    </MudPaper>
}

@code {
    private async Task LoadVectorChunksAsync(VectorStoreSourceReferenceItemInfo vsItem)
    {
        if (string.IsNullOrWhiteSpace(vsItem.StoredPartitionNumbers))
        {
            return;
        }
        var list = await ContentNodeApi.GetVectorChunksAsync(vsItem.IndexName, vsItem.DocumentId, vsItem.StoredPartitionNumbers!);
        if (list != null && list.Count > 0)
        {
            var existing = vsItem.Chunks?.Select(c => c.PartitionNumber).ToHashSet() ?? new HashSet<int>();
            foreach (var c in list)
            {
                if (!existing.Contains(c.PartitionNumber))
                {
                    vsItem.Chunks.Add(c);
                }
            }
            StateHasChanged();
        }
    }
}