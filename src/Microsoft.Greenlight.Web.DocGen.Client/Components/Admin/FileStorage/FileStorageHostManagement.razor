@* File Storage Host Management Component *@
@using Microsoft.Greenlight.Shared.Contracts.DTO.FileStorage
@using Microsoft.Greenlight.Shared.Contracts.Authorization
@using Microsoft.Greenlight.Shared.Enums
@using Microsoft.Greenlight.Web.Shared.ServiceClients
@inject IFileStorageSourceApiClient FileStorageService
@inject IFileStorageHostApiClient FileStorageHostService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudStack Spacing="4">
    <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h6">File Storage Hosts</MudText>
        <PermissionView Permission="@PermissionKeys.AlterSystemConfiguration">
            <MudButton StartIcon="@Icons.Material.Filled.Add" 
                      Variant="Variant.Filled" 
                      Color="Color.Primary"
                      OnClick="@(() => OpenCreateHostDialog())">
                Create Host
            </MudButton>
        </PermissionView>
    </MudStack>

    <MudDataGrid @ref="hostsGrid"
                 T="FileStorageHostInfo" 
                 Items="@hosts" 
                 Filterable="true"
                 SortMode="SortMode.Multiple"
                 Loading="@loading">
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="Name">
                <CellTemplate>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        @if (context.Item.IsDefault)
                        {
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small" Icon="@Icons.Material.Filled.Star">Default</MudChip>
                        }
                        <MudText>@context.Item.Name</MudText>
                        @if (!context.Item.IsActive)
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small">Inactive</MudChip>
                        }
                    </MudStack>
                </CellTemplate>
            </PropertyColumn>
            
            <PropertyColumn Property="x => x.ProviderType" Title="Provider">
                <CellTemplate>
                    <MudChip T="string" Color="GetProviderColor(context.Item.ProviderType)" Size="Size.Small">
                        @context.Item.ProviderType
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>
            
            <PropertyColumn Property="x => x.ConnectionString" Title="Connection" Sortable="false">
                <CellTemplate>
                    <MudText Style="font-family: monospace; font-size: 0.8em;" Class="text-truncate">
                        @(GetConnectionDisplayText(context.Item.ConnectionString))
                    </MudText>
                </CellTemplate>
            </PropertyColumn>
            
            <PropertyColumn Property="x => x.CreatedDate" Title="Created" Format="yyyy-MM-dd" />
            
            <TemplateColumn Title="Actions" Sortable="false" Filterable="false">
                <CellTemplate>
                    <MudStack Row="true" Spacing="1">
                        <PermissionView Permission="@PermissionKeys.AlterSystemConfiguration">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                          Size="Size.Small"
                                          Color="Color.Primary"
                                          OnClick="@(() => EditHost(context.Item))" />
                            
                            @if (!context.Item.IsDefault)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                              Size="Size.Small"
                                              Color="Color.Error"
                                              OnClick="@(() => DeleteHost(context.Item))" />
                            }
                            else
                            {
                                <MudTooltip Text="Cannot delete default host">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                  Size="Size.Small"
                                                  Color="Color.Default"
                                                  Disabled="true" />
                                </MudTooltip>
                            }
                        </PermissionView>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>

    @if (loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
</MudStack>

@code {
    private MudDataGrid<FileStorageHostInfo> hostsGrid = null!;
    private List<FileStorageHostInfo> hosts = new();
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadHosts();
    }

    private async Task LoadHosts()
    {
        loading = true;
        try
        {
            hosts = (await FileStorageHostService.GetAllFileStorageHostsAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load hosts: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task OpenCreateHostDialog()
    {
        var parameters = new DialogParameters<FileStorageHostEditDialog>
        {
            { x => x.Host, new FileStorageHostInfo { IsActive = true } },
            { x => x.IsCreate, true }
        };

        var dialog = await DialogService.ShowAsync<FileStorageHostEditDialog>("Create Storage Host", parameters);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadHosts();
        }
    }

    private async Task EditHost(FileStorageHostInfo host)
    {
        var parameters = new DialogParameters<FileStorageHostEditDialog>
        {
            { x => x.Host, host },
            { x => x.IsCreate, false }
        };

        var dialog = await DialogService.ShowAsync<FileStorageHostEditDialog>("Edit Storage Host", parameters);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadHosts();
        }
    }

    private async Task DeleteHost(FileStorageHostInfo host)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Storage Host",
            $"Are you sure you want to delete '{host.Name}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel"
        );

        if (result == true)
        {
            try
            {
                await FileStorageHostService.DeleteFileStorageHostAsync(host.Id);
                await LoadHosts();
                Snackbar.Add("Storage host deleted successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete host: {ex.Message}", Severity.Error);
            }
        }
    }

    private static Color GetProviderColor(FileStorageProviderType providerType) => providerType switch
    {
        FileStorageProviderType.BlobStorage => Color.Primary,
        FileStorageProviderType.LocalFileSystem => Color.Success,
        _ => Color.Default
    };

    private static string GetConnectionDisplayText(string connectionString)
    {
        if (string.IsNullOrEmpty(connectionString)) return "Not configured";
        if (connectionString.Length > 50) return connectionString[..47] + "...";
        return connectionString;
    }
}