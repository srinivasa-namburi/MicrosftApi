@inject IDocumentGenerationApiClient DocumentGenerationApiClient
@inject ISnackbar SnackBar

<MudDialog Class="content-ai-dialog">
    <TitleContent>
        <MudText Typo="Typo.h6">AI Content Assistant - @NodeDisplayName</MudText>
    </TitleContent>
    <DialogContent>
        
        @if (_isChunkUpdating)
        {
            <MudOverlay Visible="true" DarkBackground="false" Absolute="true">
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Medium" />
                    <MudText>Applying updates...</MudText>
                </MudStack>
            </MudOverlay>
        }

        @if (_isLoading)
        {
            <MudContainer Class="d-flex justify-center align-center pa-4" Style="height: 300px;">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
            </MudContainer>
        }
        else if (_documentNotFound)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                <MudText>Unable to initialize AI assistant. Could not find document information.</MudText>
            </MudAlert>
        }
        else
        {
            <MudGrid Class="ai-assistant-dialog-content ma-0">
                <!-- Content Panel (Left Side) -->
                <MudItem xs="12" md="6" Class="editor-panel-container pa-2">
                    <MudCard Class="editor-panel">
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Primary"/>
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Content</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                @if (_isUpdating)
                                {
                                    <MudChip T="string" Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.Update">Updating...</MudChip>
                                }
                                else if (_workingContent != NodeContent)
                                {
                                    <MudChip T="string" Color="Color.Info" Size="Size.Small" Icon="@Icons.Material.Filled.Edit">Modified</MudChip>
                                }
                            </CardHeaderActions>
                        </MudCardHeader>

                        <MudCardContent Class="editor-content">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Current Content:</MudText>
                            <MudPaper Elevation="0" Class="content-preview">
                                <RenderMultilineText Value="@_workingContent" />
                            </MudPaper>
                        </MudCardContent>

                        <MudCardActions Class="editor-actions">
                            <MudSpacer/>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                       OnClick="ResetContent" Size="Size.Small"
                                       Disabled="@(_workingContent == NodeContent)" Class="mr-2">
                                Reset
                            </MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       OnClick="ApplyChanges" Size="Size.Small"
                                       Disabled="@(_workingContent == NodeContent)">
                                Apply Changes
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>

                <!-- AI Assistant Panel (Right Side) -->
                <MudItem xs="12" md="6" Class="assistant-panel-container pa-2">
                    <MudCard Class="assistant-panel">
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudIcon Icon="@Icons.Material.Filled.SmartToy" Color="Color.Secondary"/>
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">AI Assistant</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>

                        <MudCardContent Class="assistant-content pa-0">
                            <AiAssistantComponent @ref="_aiAssistantComponent"
                                              ConversationId="_conversationId"
                                              DocumentProcessName="@_documentProcessName"
                                              InternalConversationIdCreate="true"
                                              IsContextEditMode="true"
                                              EditContextContent="@_workingContent"
                                              EditContextNodeId="@ContentNodeId"
                                              EditContextDisplayName="@NodeDisplayName"
                                              OnContentSuggestionReceived="HandleContentChunkUpdates"
                                              IsDarkMode="IsDarkMode"
                                              HideInitialContentDisplay="true"
                                              FillContainer="true" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">Close</MudButton>
    </DialogActions>
</MudDialog>



@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public Guid ContentNodeId { get; set; }
    [Parameter] public string NodeContent { get; set; } = string.Empty;
    [Parameter] public string NodeDisplayName { get; set; } = "Content Section";
    [Parameter] public EventCallback<string> OnSuggestedContentReceived { get; set; }
    [Parameter] public Guid? AssociatedGeneratedDocumentId { get; set; }
    [Parameter] public bool IsDarkMode { get; set; }

    private AiAssistantComponent? _aiAssistantComponent;
    private readonly Guid _conversationId = Guid.NewGuid();
    private bool _isLoading = true;
    private bool _isUpdating = false;
    private bool _documentNotFound = false;
    private string _documentProcessName = "Default"; // Fallback document process name
    private string _workingContent = string.Empty; // Current working content (can be changed by suggestions)
    private bool _isChunkUpdating = false;

    protected override void OnParametersSet()
    {
        if (_workingContent == string.Empty)
        {
            _workingContent = NodeContent; // Initialize working content with original content
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Set working content to initial content
        _workingContent = NodeContent;

        try
        {
            if (AssociatedGeneratedDocumentId.HasValue)
            {
                // Get the document header which contains the DocumentProcessName
                var documentInfo = await DocumentGenerationApiClient.GetDocumentHeaderAsync(AssociatedGeneratedDocumentId.Value.ToString());
                if (documentInfo != null && !string.IsNullOrEmpty(documentInfo.DocumentProcessName))
                {
                    _documentProcessName = documentInfo.DocumentProcessName;
                }
                else
                {
                    // Document found but no process name
                    SnackBar.Add("Document found but no document process name specified", Severity.Warning);
                }
            }
            else
            {
                // No associated document ID provided
                _documentNotFound = true;
                SnackBar.Add("No associated document ID provided", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _documentNotFound = true;
            SnackBar.Add($"Error retrieving document information: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleContentChunkUpdates(string suggestedContent)
    {
        if (string.IsNullOrEmpty(suggestedContent))
            return;

        try
        {
            _isChunkUpdating = true;
            await InvokeAsync(StateHasChanged);

            // Short delay to show the updating indicator
            await Task.Delay(100);

            // Update the working content with the suggestion
            _workingContent = suggestedContent;

            // When we get new content, update the context in the AI Assistant component
            if (_aiAssistantComponent != null)
            {
                await _aiAssistantComponent.UpdateContextContent(_workingContent);
            }
        }
        finally
        {
            _isChunkUpdating = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ResetContent()
    {
        try
        {
            // Reset the working content to original
            _workingContent = NodeContent;
        
            // When resetting content, we need to let the AI Assistant component know
            // to reset its internal state as well
            if (_aiAssistantComponent != null)
            {
                _ = _aiAssistantComponent.UpdateContextContent(_workingContent);
            }
        
            SnackBar.Add("Content has been reset to original", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error resetting content: {ex.Message}");
            SnackBar.Add("Failed to reset content", Severity.Error);
        }
    }

    private async Task ApplyChanges()
    {
        if (_workingContent != NodeContent)
        {
            await OnSuggestedContentReceived.InvokeAsync(_workingContent);
            MudDialog.Close();
        }
    }
    
    private void Cancel() => MudDialog.Cancel();
}
