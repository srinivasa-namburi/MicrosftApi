@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.Greenlight.Web.DocGen.Client.Services
@inject IPermissionService PermissionService
@if (_hasPermission)
{
    <MudNavLink Href="@Href" Match="@Match" Icon="@Icon" @attributes="AdditionalAttributes">
        @ChildContent
    </MudNavLink>
}

@code {
    [Parameter] public string? Permission { get; set; }
    [Parameter] public string[]? AnyPermissions { get; set; }

    [Parameter] public string Href { get; set; } = string.Empty;
    [Parameter] public NavLinkMatch Match { get; set; } = NavLinkMatch.Prefix;
    [Parameter] public string? Icon { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private bool _isLoading = true;
    private bool _hasPermission = false;

    protected override async Task OnInitializedAsync()
    {
        await CheckPermissionsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await CheckPermissionsAsync();
    }

    private async Task CheckPermissionsAsync()
    {
        _isLoading = true;

        try
        {
            if (!string.IsNullOrEmpty(Permission))
            {
                _hasPermission = await PermissionService.HasPermissionAsync(Permission);
            }
            else if (AnyPermissions != null && AnyPermissions.Length > 0)
            {
                _hasPermission = await PermissionService.HasAnyPermissionAsync(AnyPermissions);
            }
            else
            {
                // No permissions specified, assume authorized
                _hasPermission = true;
            }
        }
        catch
        {
            _hasPermission = false;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}