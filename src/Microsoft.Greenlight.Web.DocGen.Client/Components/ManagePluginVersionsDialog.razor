@using Microsoft.Extensions.Logging
@using Microsoft.Greenlight.Web.Shared.ServiceClients
@using Microsoft.Greenlight.Shared.Contracts.DTO.Plugins

@inject IPluginApiClient PluginApiClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILogger<ManagePluginVersionsDialog> Logger

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Manage Plugin Versions</MudText>
    </TitleContent>
    <DialogContent>
        <MudTable T="McpPluginVersionInfo" Items="Plugin.Versions" Hover="true" Striped="true">
            <HeaderContent>
                <MudTh>Version</MudTh>
                <MudTh>Command</MudTh>
                <MudTh>Arguments</MudTh>
                <MudTh>Env Variables</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.ToString()</MudTd>
                <MudTd>@context.Command</MudTd>
                <MudTd>@(context.Arguments != null ? string.Join(", ", context.Arguments) : "")</MudTd>
                <MudTd>@(context.EnvironmentVariables?.Count ?? 0)</MudTd>
                <MudTd>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" 
                                  OnClick="() => EditVersion(context)" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No versions available for this plugin.</MudText>
            </NoRecordsContent>
        </MudTable>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="AddNewVersion">
            Add New Version
        </MudButton>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public McpPluginInfo Plugin { get; set; } = null!;

    private void EditVersion(McpPluginVersionInfo version)
    {
        var parameters = new DialogParameters 
        { 
            { "Version", version },
            { "PluginInfo", Plugin },
            { "IsNewVersion", false }
        };
        
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<EditMcpPluginVersionDialog>($"Edit Version - {version}", parameters, options);
        dialog.Result.ContinueWith(async (t) =>
        {
            if (!t.IsCanceled)
            {
                Snackbar.Add("Version updated successfully.", Severity.Success);
                await InvokeAsync(StateHasChanged);
            }
        });
    }
    
    private void AddNewVersion()
    {
        var parameters = new DialogParameters 
        { 
            { "PluginInfo", Plugin },
            { "IsNewVersion", true }
        };
        
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<EditMcpPluginVersionDialog>("Add New Version", parameters, options);
        dialog.Result.ContinueWith(async (t) =>
        {
            if (!t.IsCanceled)
            {
                Snackbar.Add("Version added successfully.", Severity.Success);
                await InvokeAsync(StateHasChanged);
            }
        });
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
