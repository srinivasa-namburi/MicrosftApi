@* // Copyright (c) Microsoft Corporation. All rights reserved. *@
@inject IDocumentLibraryApiClient DocumentLibraryApiClient
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Microsoft.Greenlight.Shared.Enums

<MudPaper Class="pa-4">
    @if (DocumentLibraries == null)
    {
        <MudProgressCircular Indeterminate="true" Class="my-4" />
    }
    else
    {
        <MudDataGrid Items="DocumentLibraries"
                     T="DocumentLibraryInfo"
                     Hover="true"
                     Filterable="false"
                     SortMode="SortMode.Single"
                     Groupable="false"
                     RowClick="@RowClicked"
                     Dense="true">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Document Libraries</MudText>
                <MudSpacer />
                <MudButton OnClick="@CreateNew" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">
                    Create New Document Library
                </MudButton>
            </ToolBarContent>
            <Columns>
                <PropertyColumn Property="x => x.ShortName" Title="Short Name" />
                <PropertyColumn Property="x => x.DescriptionOfContents" Title="Description" />
                <PropertyColumn Property="x => x.LogicType" Title="Logic Type" />
                <PropertyColumn Property="x => x.IndexName" Title="Index Name" />
                <TemplateColumn Title="Actions" CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudIconButton Color="Color.Default" Icon="@Icons.Material.Filled.StickyNote2" Size="Size.Small" OnClick="@(()=>EditLibrary(context.Item.Id))"></MudIconButton>
                        <MudIconButton Color="Color.Error" Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="@(() => ConfirmDeleteLibrary(context.Item.Id))"/>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudPaper>

@code {
    private List<DocumentLibraryInfo>? DocumentLibraries;

    protected override async Task OnInitializedAsync()
    {
        await LoadLibraries();
    }

    private async Task LoadLibraries()
    {
        DocumentLibraries = await DocumentLibraryApiClient.GetAllDocumentLibrariesAsync();
    }

    private void CreateNew()
    {
        NavigationManager.NavigateTo("/document-library/");
    }

    private void EditLibrary(Guid id)
    {
        NavigationManager.NavigateTo($"/document-library/{id}");
    }

    private async Task ConfirmDeleteLibrary(Guid id)
    {
        var lib = DocumentLibraries?.FirstOrDefault(l => l.Id == id);
        var name = lib?.ShortName ?? "this library";

        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to delete the document library '{name}'? This deletes the vector index/collection (if SK), its blob container and all ingested document records." },
            { "ButtonText", "Delete" },
            { "DialogColor", Color.Error }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<ConfirmationDialog>("Delete Document Library", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await DocumentLibraryApiClient.DeleteDocumentLibraryAsync(id);
                Snackbar.Add("Document library deleted.", Severity.Success);
                await LoadLibraries();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete library: {ex.Message}", Severity.Error);
            }
        }
    }

    private void RowClicked(DataGridRowClickEventArgs<DocumentLibraryInfo> obj)
    {
        EditLibrary(obj.Item.Id);
    }

}
