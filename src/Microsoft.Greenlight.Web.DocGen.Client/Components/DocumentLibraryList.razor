@* // Copyright (c) Microsoft Corporation. All rights reserved. *@
@inject IDocumentLibraryApiClient DocumentLibraryApiClient
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Microsoft.Greenlight.Shared.Enums

<MudPaper Class="pa-6">
    <MudText Typo="Typo.h5">Document Libraries</MudText>
    <MudDivider Class="mt-2 mb-5" />
    
    @if (DocumentLibraries == null)
    {
        <MudProgressCircular Indeterminate="true" Class="my-4" />
    }
    else
    {
        <MudDataGrid Items="DocumentLibraries"
                     T="DocumentLibraryInfo"
                     Hover="true"
                     Filterable="false"
                     SortMode="SortMode.Single"
                     Groupable="false"
                     RowClick="@RowClicked"
                     Size="Size.Small">
            <ToolBarContent>
                <MudSpacer />
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="OpenImportDialog">Import</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@CreateNew">Add New Library</MudButton>
            </ToolBarContent>
            <Columns>
                <PropertyColumn Property="x => x.ShortName" Title="Short Name" />
                <PropertyColumn Property="x => x.DescriptionOfContents" Title="Description" />
                <PropertyColumn Property="x => x.LogicType" Title="Logic Type" />
                <PropertyColumn Property="x => x.IndexName" Title="Index Name" />
                <TemplateColumn Title="Actions" CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="3">
                            <MudTooltip Delay="400" Text="Edit Document Library">
                                <MudIconButton OnClick="@(() => EditLibrary(context.Item.Id))" Size="@Size.Small" Icon="@Icons.Material.Filled.StickyNote2"></MudIconButton>
                            </MudTooltip>
                            
                            <MudTooltip Delay="400" Text="Delete Document Library (you will be asked to confirm)">
                                <MudIconButton OnClick="@(() => ConfirmDeleteLibrary(context.Item.Id))" Size="@Size.Small" Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                            </MudTooltip>
                            
                            <MudTooltip Delay="400" Text="Export Document Library as Json (you will be asked to confirm)">
                                <MudIconButton OnClick="@(() => ExportLibraryAsync(context.Item.Id))" Size="@Size.Small" Icon="@Icons.Material.Filled.ArrowDownward"></MudIconButton>
                            </MudTooltip>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudPaper>

@code {
    private List<DocumentLibraryInfo>? DocumentLibraries;

    protected override async Task OnInitializedAsync()
    {
        await LoadLibraries();
    }

    private async Task LoadLibraries()
    {
        DocumentLibraries = await DocumentLibraryApiClient.GetAllDocumentLibrariesAsync();
    }

    private async Task OpenImportDialog()
    {
        var parameters = new DialogParameters
        {
            ["IsProcessMode"] = false
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<Microsoft.Greenlight.Web.DocGen.Client.Components.Definitions.ImportDefinitionDialog>("Import Document Library", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadLibraries();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CreateNew()
    {
        NavigationManager.NavigateTo("/document-library/");
    }

    private void EditLibrary(Guid id)
    {
        NavigationManager.NavigateTo($"/document-library/{id}");
    }

    private async Task ConfirmDeleteLibrary(Guid id)
    {
        var lib = DocumentLibraries?.FirstOrDefault(l => l.Id == id);
        var name = lib?.ShortName ?? "this library";

        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to delete the document library '{name}'? This deletes the vector index/collection (if SK), its blob container and all ingested document records." },
            { "ButtonText", "Delete" },
            { "DialogColor", Color.Error }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<ConfirmationDialog>("Delete Document Library", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await DocumentLibraryApiClient.DeleteDocumentLibraryAsync(id);
                Snackbar.Add("Document library deleted.", Severity.Success);
                await LoadLibraries();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete library: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ExportLibraryAsync(Guid libraryId)
    {
        try
        {
            // TODO: Implement export functionality when available
            // var documentLibrary = await DocumentLibraryApiClient.ExportDocumentLibraryByIdAsync(libraryId);
            // var json = JsonSerializer.Serialize(documentLibrary, new JsonSerializerOptions { WriteIndented = true });
            // await JSRuntime.InvokeVoidAsync("downloadFile", fileName, json);
            Snackbar.Add("Export functionality not yet implemented", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting library: {ex.Message}", Severity.Error);
        }
    }

    private void RowClicked(DataGridRowClickEventArgs<DocumentLibraryInfo> obj)
    {
        EditLibrary(obj.Item.Id);
    }

}
