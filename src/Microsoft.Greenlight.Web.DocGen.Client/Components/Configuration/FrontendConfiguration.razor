@* Copyright (c) Microsoft Corporation. All rights reserved. *@
@using MudBlazor
@using Microsoft.Greenlight.Shared.Configuration
@using Microsoft.Greenlight.Web.DocGen.Client.ServiceClients
@inject IConfigurationApiClient ConfigApi
@inherits Microsoft.Greenlight.Web.DocGen.Client.Components.Configuration.Infrastructure.ConfigurationSectionBase

<MudPaper Class="pa-4">
  <MudText Typo="Typo.h6">Frontend Options</MudText>
  <MudDivider Class="mt-2 mb-3" />

  <MudTextField T="string" Label="Site Name" @bind-Value="SiteName" Variant="Variant.Filled" Immediate="true" />

  <MudStack Class="mt-2" Direction="Row" Spacing="2">
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!IsDirty)" OnClick="@(()=>SaveAsync())">Save</MudButton>
  </MudStack>
</MudPaper>

@code {
  private ServiceConfigurationOptions.GreenlightServicesOptions.FrontendOptions _options = new();
  private string _initial = string.Empty;

  public override string Title => "Frontend";

  protected override async Task OnInitializedAsync()
  {
    await LoadAsync();
  }

  public override async Task LoadAsync(CancellationToken cancellationToken = default)
  {
    _options = await ConfigApi.GetFrontEndAsync();
    _initial = System.Text.Json.JsonSerializer.Serialize(_options);
    SetDirty(false);
  }

  private void MarkDirty()
  {
    var cur = System.Text.Json.JsonSerializer.Serialize(_options);
    SetDirty(!string.Equals(cur, _initial, StringComparison.Ordinal));
  }

  private string? SiteName { get => _options.SiteName; set { _options.SiteName = value; MarkDirty(); } }

  public override async Task SaveAsync(CancellationToken cancellationToken = default)
  {
    var items = new Dictionary<string, string>
    {
        ["ServiceConfiguration:GreenlightServices:Frontend:SiteName"] = _options.SiteName ?? string.Empty
    };
    await ConfigApi.UpdateConfigurationAsync(new Microsoft.Greenlight.Shared.Contracts.DTO.ConfigurationUpdateRequest
    {
      ConfigurationItems = items
    });
    _initial = System.Text.Json.JsonSerializer.Serialize(_options);
    SetDirty(false);
  }

  public override IEnumerable<string> DescribePendingChanges()
  {
    var before = System.Text.Json.JsonSerializer.Deserialize<ServiceConfigurationOptions.GreenlightServicesOptions.FrontendOptions>(_initial) ?? new();
    if (!string.Equals(before.SiteName, _options.SiteName, StringComparison.Ordinal))
    {
      yield return $"SiteName: '{before.SiteName}' â†’ '{_options.SiteName}'";
    }
  }
}
