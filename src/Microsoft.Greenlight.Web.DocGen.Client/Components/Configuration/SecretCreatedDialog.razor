@* Copyright (c) Microsoft Corporation. All rights reserved. *@
@inject IJSRuntime JSRuntime

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Key" Class="me-2" />
            API Secret Created Successfully
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Warning" Class="mb-3">
            <strong>Important:</strong> This is the only time you will be able to see this secret value. Make sure to copy it now and store it securely.
        </MudAlert>
        
        <MudText Typo="Typo.subtitle2" Class="mb-2">Secret Name:</MudText>
        <MudText Typo="Typo.body1" Class="mb-3"><strong>@SecretName</strong></MudText>
        
        <MudText Typo="Typo.subtitle2" Class="mb-2">Secret Value:</MudText>
        <MudStack Direction="Row" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
            <MudTextField 
                T="string" 
                Value="@(_showFullSecret ? SecretValue : TruncatedSecret)" 
                Variant="Variant.Outlined" 
                ReadOnly="true"
                FullWidth="true"
                InputType="@(_showFullSecret ? InputType.Text : InputType.Password)"
                Class="font-monospace" />
            <MudTooltip Text="@(_showFullSecret ? "Hide secret" : "Show full secret")">
                <MudIconButton 
                    Icon="@(_showFullSecret ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" 
                    Color="Color.Primary" 
                    OnClick="ToggleSecretVisibility" />
            </MudTooltip>
            <MudTooltip Text="Copy secret to clipboard">
                <MudIconButton 
                    Icon="@Icons.Material.Filled.ContentCopy" 
                    Color="Color.Success" 
                    OnClick="CopyToClipboard" />
            </MudTooltip>
        </MudStack>
        
        @if (_copySuccess)
        {
            <MudAlert Severity="Severity.Success" Class="mb-2">
                Secret copied to clipboard!
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Close" Variant="Variant.Filled">
            I've Copied the Secret
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public string SecretName { get; set; } = string.Empty;
    [Parameter] public string SecretValue { get; set; } = string.Empty;
    [Parameter] public string TruncatedSecret { get; set; } = string.Empty;
    
    private bool _showFullSecret = false;
    private bool _copySuccess = false;
    
    private void ToggleSecretVisibility()
    {
        _showFullSecret = !_showFullSecret;
    }
    
    private async Task CopyToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", SecretValue);
            _copySuccess = true;
            StateHasChanged();
            
            // Hide success message after 3 seconds
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                _copySuccess = false;
                await InvokeAsync(StateHasChanged);
            });
        }
        catch
        {
            // Fallback for older browsers or when clipboard API is not available
            try
            {
                await JSRuntime.InvokeVoidAsync("copyToClipboardFallback", SecretValue);
                _copySuccess = true;
                StateHasChanged();
            }
            catch
            {
                // If all methods fail, we could show an error or just ignore
            }
        }
    }
    
    private void Close() => MudDialog.Close(DialogResult.Ok(true));
}

<script>
    window.copyToClipboardFallback = (text) => {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
        } finally {
            document.body.removeChild(textArea);
        }
    };
</script>