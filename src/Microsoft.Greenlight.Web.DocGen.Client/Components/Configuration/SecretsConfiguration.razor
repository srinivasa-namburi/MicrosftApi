@* Copyright (c) Microsoft Corporation. All rights reserved. *@
@using Microsoft.Greenlight.Shared.Contracts.DTO.Configuration
@inject IConfigurationApiClient ConfigApi
@inherits Microsoft.Greenlight.Web.DocGen.Client.Components.Configuration.Infrastructure.ConfigurationSectionBase

<MudPaper Class="pa-4">
  <MudText Typo="Typo.h6">Secret Configuration Overrides</MudText>
  <MudDivider Class="mt-2 mb-3" />

  <MudExpansionPanels>
    <MudExpansionPanel Text="Azure Maps API Key">
      <MudStack Spacing="3">
        @if (_mapsInfo != null)
        {
          <MudAlert Severity="@(_mapsInfo.HasValue ? Severity.Success : Severity.Warning)" Dense="true">
            <strong>Status:</strong> @(_mapsInfo.IsOverridden ? "Using custom override" : "Using default configuration")
            @if (_mapsInfo.LastUpdated.HasValue)
            {
              <br /><small>Last updated: @_mapsInfo.LastUpdated.Value.ToString("yyyy-MM-dd HH:mm:ss") UTC</small>
            }
          </MudAlert>
        }

        <MudTextField T="string" @bind-Value="_pendingAzureMapsKey" Label="Azure Maps API Key" InputType="InputType.Password" Variant="Variant.Filled" Immediate="true" HelperText="Enter a new key to set an override. Leave empty to keep current." Clearable="true" />

        <MudStack Row="true" Spacing="2">
          <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" Disabled="string.IsNullOrWhiteSpace(_pendingAzureMapsKey)" OnClick="@(()=>MarkSetPending())">
            Queue Set Override
          </MudButton>
          @if (_mapsInfo?.IsOverridden == true)
          {
            <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.RestoreFromTrash" OnClick="@(()=>MarkRemovePending())">
              Queue Remove Override
            </MudButton>
          }
        </MudStack>
      </MudStack>
    </MudExpansionPanel>

    <MudExpansionPanel Text="Azure OpenAi Service Connection String">
      <MudStack Spacing="3">
        @if (_openAiConnInfo != null)
        {
          <MudAlert Severity="@(_openAiConnInfo.HasValue ? Severity.Success : Severity.Warning)" Dense="true">
            <strong>Status:</strong> @(_openAiConnInfo.IsOverridden ? "Using custom override" : "Using default configuration")
            @if (_openAiConnInfo.LastUpdated.HasValue)
            {
              <br /><small>Last updated: @_openAiConnInfo.LastUpdated.Value.ToString("yyyy-MM-dd HH:mm:ss") UTC</small>
            }
          </MudAlert>
        }

        <MudAlert Severity="Severity.Info" Dense="true">
          Provide either a full connection string (e.g. <code>Endpoint=https://your-resource.openai.azure.com/;Key=abc123</code>) or use the helper fields below.<br />
          Formats supported: <br />
          1. <code>Endpoint=https://.../;Key=YOUR_KEY</code><br />
          2. <code>Endpoint=https://.../;Key=</code> (empty key => use Entra ID / Managed Identity)<br />
          3. <code>Endpoint=https://.../</code><br />
          4. <code>https://.../</code>
        </MudAlert>

        <MudExpansionPanels Elevation="0">
          <MudExpansionPanel Text="Advanced: Paste Raw Connection String" Dense="true">
            <MudTextField T="string" @bind-Value="_rawOpenAiConnectionString" Label="Raw Connection String" Variant="Variant.Filled" Lines="3" Clearable="true" />
            <MudText Typo="Typo.caption" Class="mt-1">If provided, this value overrides the Endpoint/Key helper inputs below.</MudText>
          </MudExpansionPanel>
        </MudExpansionPanels>

        <MudGrid Class="mt-2">
          <MudItem xs="12" md="7">
            <MudTextField T="string" @bind-Value="_openAiEndpoint" Label="Endpoint URL" Variant="Variant.Filled" Immediate="true" Placeholder="https://your-resource.openai.azure.com/" HelperText="Required. Must be a valid https URL." Clearable="true" />
          </MudItem>
          <MudItem xs="12" md="5">
            <MudTextField T="string" @bind-Value="_openAiKey" Label="Access Key (optional)" InputType="InputType.Password" Variant="Variant.Filled" Immediate="true" HelperText="Leave empty to use Entra ID / Managed Identity." Clearable="true" />
          </MudItem>
        </MudGrid>

        <MudStack Row="true" Spacing="2">
          <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" Disabled="!CanQueueOpenAiSet" OnClick="QueueOpenAiSet">
            Queue Set Override
          </MudButton>
          @if (_openAiConnInfo?.IsOverridden == true)
          {
            <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.RestoreFromTrash" OnClick="QueueOpenAiRemove">
              Queue Remove Override
            </MudButton>
          }
        </MudStack>

        @if (!string.IsNullOrWhiteSpace(_openAiValidationError))
        {
          <MudAlert Severity="Severity.Error" Dense="true">@_openAiValidationError</MudAlert>
        }
      </MudStack>
    </MudExpansionPanel>
  </MudExpansionPanels>

  <MudStack Class="mt-3" Direction="Row" Spacing="2">
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!IsDirty)" OnClick="(()=>SaveAsync())">Save</MudButton>
  </MudStack>
</MudPaper>

@code {
  private SecretOverrideInfo? _mapsInfo;
  private SecretOverrideInfo? _openAiConnInfo;
  private string _pendingAzureMapsKey = string.Empty;
  private bool _pendingRemoveMapsKey = false;

  // OpenAI connection string helper state
  private string _openAiEndpoint = string.Empty;
  private string _openAiKey = string.Empty;
  private string _rawOpenAiConnectionString = string.Empty;
  private bool _pendingSetOpenAi = false;
  private bool _pendingRemoveOpenAi = false;
  private string _openAiValidationError = string.Empty;

  public override string Title => "Secrets";

  protected override async Task OnInitializedAsync()
  {
    await LoadAsync();
  }

  public override async Task LoadAsync(CancellationToken cancellationToken = default)
  {
    _mapsInfo = await ConfigApi.GetSecretOverrideInfoAsync("ServiceConfiguration:AzureMaps:Key");
    _openAiConnInfo = await ConfigApi.GetSecretOverrideInfoAsync("ConnectionStrings:openai-planner");

    // Reset all pending state to ensure clean slate
    _pendingAzureMapsKey = string.Empty;
    _pendingRemoveMapsKey = false;
    _rawOpenAiConnectionString = string.Empty;
    _openAiEndpoint = string.Empty;
    _openAiKey = string.Empty;
    _pendingSetOpenAi = false;
    _pendingRemoveOpenAi = false;
    _openAiValidationError = string.Empty;

    SetDirty(false);
  }

  private void MarkSetPending()
  {
    if (!string.IsNullOrWhiteSpace(_pendingAzureMapsKey))
    {
      SetDirty(true);
    }
  }

  private void MarkRemovePending()
  {
    _pendingRemoveMapsKey = true;
    SetDirty(true);
  }

  private bool CanQueueOpenAiSet =>
      !string.IsNullOrWhiteSpace(_rawOpenAiConnectionString) ||
      !string.IsNullOrWhiteSpace(_openAiEndpoint);

  private void QueueOpenAiSet()
  {
    _openAiValidationError = string.Empty;
    if (!CanQueueOpenAiSet)
    {
      return;
    }

    // Basic endpoint validation when using helper fields
    if (string.IsNullOrWhiteSpace(_rawOpenAiConnectionString))
    {
      if (!Uri.TryCreate(_openAiEndpoint, UriKind.Absolute, out var uri) || uri.Scheme != Uri.UriSchemeHttps)
      {
        _openAiValidationError = "Endpoint must be a valid https URL.";
        return;
      }
    }

    // Validate that we actually have a non-empty connection string to save
    var assembled = !string.IsNullOrWhiteSpace(_rawOpenAiConnectionString)
      ? _rawOpenAiConnectionString.Trim()
      : BuildOpenAiConnectionString();

    if (string.IsNullOrWhiteSpace(assembled))
    {
      _openAiValidationError = "Cannot save empty connection string. Provide either raw connection string or valid endpoint.";
      return;
    }

    _pendingSetOpenAi = true;
    SetDirty(true);
  }

  private void QueueOpenAiRemove()
  {
    _pendingRemoveOpenAi = true;
    SetDirty(true);
  }

  public override async Task SaveAsync(CancellationToken cancellationToken = default)
  {
    // Azure Maps
    if (!string.IsNullOrWhiteSpace(_pendingAzureMapsKey))
    {
      await ConfigApi.SetSecretOverrideAsync(new SecretOverrideRequest
      {
        ConfigurationKey = "ServiceConfiguration:AzureMaps:Key",
        SecretValue = _pendingAzureMapsKey,
        Description = "Azure Maps API key override set via configuration UI"
      });
      _pendingAzureMapsKey = string.Empty;
    }
    if (_pendingRemoveMapsKey)
    {
      await ConfigApi.RemoveSecretOverrideAsync("ServiceConfiguration:AzureMaps:Key");
      _pendingRemoveMapsKey = false;
    }
    _mapsInfo = await ConfigApi.GetSecretOverrideInfoAsync("ServiceConfiguration:AzureMaps:Key");

    // OpenAI planner connection string
    if (_pendingSetOpenAi)
    {
      var assembled = !string.IsNullOrWhiteSpace(_rawOpenAiConnectionString)
        ? _rawOpenAiConnectionString.Trim()
        : BuildOpenAiConnectionString();

      // Double-check: never save an empty connection string
      if (string.IsNullOrWhiteSpace(assembled))
      {
        _openAiValidationError = "Cannot save empty connection string.";
        _pendingSetOpenAi = false; // Clear the flag to prevent retry loops
        return;
      }

      try
      {
        await ConfigApi.SetSecretOverrideAsync(new SecretOverrideRequest
        {
          ConfigurationKey = "ConnectionStrings:openai-planner",
          SecretValue = assembled,
          Description = "Azure OpenAI planner connection string override set via configuration UI"
        });
        _pendingSetOpenAi = false;
        _rawOpenAiConnectionString = string.Empty;
        _openAiEndpoint = string.Empty;
        _openAiKey = string.Empty;
      }
      catch (Exception ex)
      {
        _openAiValidationError = ex.Message;
      }
    }
    if (_pendingRemoveOpenAi)
    {
      await ConfigApi.RemoveSecretOverrideAsync("ConnectionStrings:openai-planner");
      _pendingRemoveOpenAi = false;
    }
    _openAiConnInfo = await ConfigApi.GetSecretOverrideInfoAsync("ConnectionStrings:openai-planner");

    SetDirty(false);
  }

  private string BuildOpenAiConnectionString()
  {
    if (string.IsNullOrWhiteSpace(_openAiEndpoint))
    {
      return string.Empty;
    }
    var endpoint = _openAiEndpoint.Trim();
    if (!endpoint.EndsWith("/"))
    {
      endpoint += "/";
    }
    if (string.IsNullOrWhiteSpace(_openAiKey))
    {
      return endpoint; // no key => MSI/Entra auth
    }
    return $"Endpoint={endpoint};Key={_openAiKey.Trim()}";
  }

  public override IEnumerable<string> DescribePendingChanges()
  {
    if (!string.IsNullOrWhiteSpace(_pendingAzureMapsKey)) yield return "Azure Maps: set new key";
    if (_pendingRemoveMapsKey) yield return "Azure Maps: remove override";
    if (_pendingSetOpenAi) yield return "OpenAI Planner: set/override connection string";
    if (_pendingRemoveOpenAi) yield return "OpenAI Planner: remove override";
  }
}

