@inject IAuthorizationApiClient AuthorizationApiClient
@inject AuthenticationStateProvider AuthenticationStateProvider

<CascadingValue Value=false Name="UsePopoverProvider">
    <MudThemeProvider @ref="_mudThemeProvider" @bind-IsDarkMode="@IsDarkMode" Theme="MyTheme"></MudThemeProvider>
</CascadingValue>

@code {
    public static MudTheme MyTheme => new()
        {
            PaletteLight = new PaletteLight()
            {
                Primary = "#5B7FA6",
                Secondary = "#6B7B80",
                Tertiary = "#737373",
                Background = "#FAFAFA",
                Surface = "#F3F3F3",
                DrawerBackground = "#F3F3F3",
                DrawerText = "#333333",
                AppbarBackground = "#5B7FA6",
                AppbarText = "#FFFFFF",
                TextPrimary = "#333333",
                TextSecondary = "#555555",
                ActionDefault = "#333333",
                ActionDisabled = "rgba(0,0,0,0.26)",
                ActionDisabledBackground = "rgba(0,0,0,0.12)",
                Error = "#B85450",
                Success = "#6B8E23",
                Warning = "#B8860B",
                Info = "#5B7FA6"
            },
            PaletteDark = new PaletteDark()
            {
                Primary = "#7A9BC4",
                Secondary = "#8A9B9F",
                Tertiary = "#737373",
                Background = "#2C2C2C",
                Surface = "#373737",
                DrawerBackground = "#333333",
                DrawerText = "#DDDDDD",
                AppbarBackground = "#2F2F2F",
                AppbarText = "#E2E2E2",
                TextPrimary = "#E2E2E2",
                TextSecondary = "rgba(255,255,255,0.75)",
                ActionDefault = "#E2E2E2",
                ActionDisabled = "rgba(255,255,255,0.26)",
                ActionDisabledBackground = "rgba(255,255,255,0.12)",
                Error = "#C97875",
                Success = "#8FAA5A",
                Warning = "#D4A832",
                Info = "#7A9BC4"
            },
            LayoutProperties = new LayoutProperties()
            {
                DefaultBorderRadius = "6px"
            },
            Typography = new Typography()
            {
                H1 = new H1Typography
                {
                    FontSize = "2.5rem",
                    FontWeight = "700",
                    LetterSpacing = "-0.02em"
                },
                H2 = new H2Typography
                {
                    FontSize = "2rem",
                    FontWeight = "600"
                },
                H3 = new H3Typography
                {
                    FontSize = "1.75rem",
                    FontWeight = "600"
                },
                H4 = new H4Typography
                {
                    FontSize = "1.5rem",
                    FontWeight = "600"
                },
                H5 = new H5Typography
                {
                    FontSize = "1.25rem",
                    FontWeight = "600"
                },
                H6 = new H6Typography
                {
                    FontSize = "1.125rem",
                    FontWeight = "600"
                },
                Subtitle1 = new Subtitle1Typography
                {
                    FontSize = "1rem",
                    FontWeight = "500"
                },
                Subtitle2 = new Subtitle2Typography
                {
                    FontSize = "0.875rem",
                    FontWeight = "500"
                },
                Body1 = new Body1Typography
                {
                    FontSize = "1rem",
                    FontWeight = "400"
                },
                Body2 = new Body2Typography
                {
                    FontSize = "0.875rem",
                    FontWeight = "400"
                },
                Button = new ButtonTypography
                {
                    FontSize = "0.875rem",
                    FontWeight = "600",
                    TextTransform = "none"
                },
                Overline = new OverlineTypography
                {
                    FontSize = "0.75rem",
                    FontWeight = "500",
                    LetterSpacing = "0.1em",
                    TextTransform = "uppercase"
                },
                Caption = new CaptionTypography
                {
                    FontSize = "0.75rem",
                    FontWeight = "400"
                }
            }
        };

    private bool _drawerOpen = true;
    private bool _isDarkMode;
    private UserInfoDTO? _currentUser;
    private bool _isInitialized;

    [Parameter]
    public bool IsDarkMode
    {
        get => _isDarkMode;
        set
        {
            if (_isDarkMode != value)
            {
                _isDarkMode = value;
                IsDarkModeChanged.InvokeAsync(value);
                SetThemePreference();
            }
        }
    }

    [Parameter]
    public EventCallback<bool> IsDarkModeChanged { get; set; }

    private MudThemeProvider _mudThemeProvider = new();

    private async Task<bool> GetDarkMode()
    {
        try
        {
            if (_mudThemeProvider != null)
            {
                return await _mudThemeProvider.GetSystemDarkModeAsync();
            }
        }
        catch (Exception)
        {
            // Fallback to default if system preference cannot be determined
        }
        return false; // Default to light mode
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var providerSubjectId = user.FindFirst(claim => claim.Type == "sub")?.Value;
            if (providerSubjectId != null)
            {
                _currentUser = await AuthorizationApiClient.GetUserInfoAsync(providerSubjectId);

                if (_currentUser != null)
                {
                    var themePreference = await AuthorizationApiClient.GetThemePreferenceAsync(providerSubjectId);
                    IsDarkMode = themePreference == ThemePreference.Dark;
                    _isInitialized = true;
                }
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            try
            {
                IsDarkMode = await GetDarkMode();
            }
            catch (Exception)
            {
                // If system preference detection fails, keep default
                IsDarkMode = false;
            }
            finally
            {
                _isInitialized = true;
                StateHasChanged();
            }
        }
    }

    private async Task SetThemePreference()
    {
        if (_currentUser != null)
        {
            var themePreferenceDto = new ThemePreferenceDTO
                {
                    ProviderSubjectId = _currentUser.ProviderSubjectId,
                    ThemePreference = _isDarkMode ? ThemePreference.Dark : ThemePreference.Light
                };

            await AuthorizationApiClient.SetThemePreferenceAsync(themePreferenceDto);
        }
    }
}
