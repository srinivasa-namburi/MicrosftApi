@using Microsoft.Greenlight.Shared.Contracts.Chat
@using System.Timers
@using System.Text.RegularExpressions

@code {
    [Parameter] public ChatMessageDTO ChatMessage { get; set; }
    [Parameter] public UserInfoDTO CurrentUser { get; set; }
    [Parameter] public List<ContentReferenceItemInfo> ConversationReferences { get; set; } = new();
    [CascadingParameter] public bool IsDarkMode { get; set; }

    private Timer? _timer;
    private bool _showTypingIndicator = true;
    private readonly Regex _referenceRegex = new Regex(@"#\(Reference:([^:]+):([^)]+)\)", RegexOptions.Compiled);
    private List<MessageReference> _messageReferences = new();

    protected override void OnInitialized()
    {
        InitializeOrRestartTimer();
        ExtractReferences();
    }

    protected override void OnParametersSet()
    {
        InitializeOrRestartTimer();
        ExtractReferences();
    }

    private void ExtractReferences()
    {
        _messageReferences.Clear();
        var content = GetOriginalMessageContent();

        int referenceNumber = 1;
        foreach (Match match in _referenceRegex.Matches(content))
        {
            if (match.Success && Enum.TryParse<ContentReferenceType>(match.Groups[1].Value, out var referenceType)
                              && Guid.TryParse(match.Groups[2].Value, out var referenceId))
            {
                // Try to find the reference in the conversation references
                var referenceInfo = ConversationReferences.FirstOrDefault(r => r.Id == referenceId);

                var reference = new MessageReference
                {
                    Number = referenceNumber++,
                    ReferenceType = referenceType,
                    ReferenceId = referenceId,
                    FullMatch = match.Value,
                    DisplayName = referenceInfo?.DisplayName ?? $"Reference {referenceId.ToString().Substring(0, 8)}"
                };

                _messageReferences.Add(reference);
            }
        }

        // Handle file reference display names
        foreach (var reference in _messageReferences.Where(r => r.ReferenceType == ContentReferenceType.ExternalFile))
        {
            var fileReference = ConversationReferences.FirstOrDefault(r => r.Id == reference.ReferenceId);
            if (fileReference != null)
            {
                reference.DisplayName = fileReference.DisplayName;
            }
        }
    }

    private string GetFormattedMessageContent()
    {
        var content = GetOriginalMessageContent();

        // Replace references with numbered references
        foreach (var reference in _messageReferences)
        {
            content = content.Replace(reference.FullMatch, $"[{reference.Number}]");
        }

        return content;
    }

    private string GetOriginalMessageContent()
    {
        return !string.IsNullOrEmpty(ChatMessage.ContentText)
            ? ChatMessage.ContentText
            : ChatMessage.Message ?? string.Empty;
    }

    private void InitializeOrRestartTimer()
    {
        if (ChatMessage.Source == ChatMessageSource.Assistant &&
            ChatMessage.State == ChatMessageCreationState.InProgress)
        {
            _timer?.Dispose();
            _timer = new Timer(10000); // 10 seconds
            _timer.Elapsed += HideTypingIndicator;
            _timer.AutoReset = false;
            _timer.Start();
        }
        else
        {
            _showTypingIndicator = false;
        }
    }

    private void HideTypingIndicator(object? sender, ElapsedEventArgs e)
    {
        _showTypingIndicator = false;
        InvokeAsync(StateHasChanged);
        _timer?.Dispose();
    }

    private bool IsCurrentUser =>
        ChatMessage.Source == ChatMessageSource.User &&
        ChatMessage.UserId == CurrentUser?.ProviderSubjectId;

    private string GetMessageClass()
        => IsCurrentUser
            ? "message-wrapper message-wrapper-user"
            : "message-wrapper message-wrapper-other";

    private string GetBubbleClass()
    {
        if (IsCurrentUser)
            return "message-bubble message-bubble-user";
        if (ChatMessage.Source == ChatMessageSource.Assistant)
            return "message-bubble message-bubble-assistant";
        if (ChatMessage.Source == ChatMessageSource.System)
            return "message-bubble message-bubble-system";
        return "message-bubble message-bubble-other";
    }

    private string GetAvatarClass()
    {
        if (IsCurrentUser)
            return "avatar avatar-user";
        if (ChatMessage.Source == ChatMessageSource.Assistant)
            return "avatar avatar-assistant";
        if (ChatMessage.Source == ChatMessageSource.System)
            return "avatar avatar-system";
        return "avatar avatar-other";
    }

    private string GetMetaClass()
        => IsCurrentUser
            ? "message-meta message-meta-user"
            : "message-meta";

    private string GetInitials()
    {
        if (string.IsNullOrEmpty(ChatMessage.UserFullName))
            return "?";

        if (ChatMessage.Source == ChatMessageSource.Assistant)
            return "AI";

        if (ChatMessage.Source == ChatMessageSource.System)
            return "SYS";

        var parts = ChatMessage.UserFullName.Split(' ');
        if (parts.Length == 1)
            return parts[0].Substring(0, 1).ToUpper();

        return $"{parts[0].Substring(0, 1)}{parts[^1].Substring(0, 1)}".ToUpper();
    }

    private string FormatDateTime(DateTime dateTime)
    {
        if (dateTime.Date == DateTime.Today)
            return $"Today at {dateTime:HH:mm}";
        if (dateTime.Date == DateTime.Today.AddDays(-1))
            return $"Yesterday at {dateTime:HH:mm}";
        return $"{dateTime:MMM d, yyyy HH:mm}";
    }

    private string GetReferenceIcon(ContentReferenceType referenceType)
    {
        return referenceType switch
        {
            ContentReferenceType.GeneratedDocument => Icons.Material.Filled.Description,
            ContentReferenceType.GeneratedSection => Icons.Material.Filled.Subject,
            ContentReferenceType.ExternalFile => Icons.Material.Filled.AttachFile,
            ContentReferenceType.ReviewItem => Icons.Material.Filled.RateReview,
            _ => Icons.Material.Filled.Link,
        };
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

    private class MessageReference
    {
        public int Number { get; set; }
        public ContentReferenceType ReferenceType { get; set; }
        public Guid ReferenceId { get; set; }
        public string? FullMatch { get; set; }
        public string? DisplayName { get; set; }
    }
}

@{
    var wrapperClass = GetMessageClass() + (IsDarkMode ? " dark-mode" : "");
}

@if (IsCurrentUser)
{
    <!-- User Message (Right-aligned) -->
    <div class="@wrapperClass">
        <div class="avatar-space-left">
            <div class="@GetAvatarClass()" title="@ChatMessage.UserFullName">
                @GetInitials()
            </div>
        </div>
        <div class="flex-grow-1">
            <div class="@GetBubbleClass()">
                <div class="message-content">
                    <RenderMultilineText Value="@GetFormattedMessageContent()"/>

                    @if (_messageReferences.Any())
                    {
                        <div class="chat-message-attachments">
                            @foreach (var reference in _messageReferences)
                            {
                                <div class="chat-message-attachment-item">
                                    <span class="chat-message-attachment-number">[@reference.Number]</span>
                                    <MudIcon Icon="@GetReferenceIcon(reference.ReferenceType)" Size="Size.Small" Class="mx-1"/>
                                    <span class="chat-message-attachment-name text-truncate">@reference.DisplayName</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="@GetMetaClass()">
                <MudText Typo="Typo.caption">
                    @FormatDateTime(ChatMessage.CreatedUtc)
                    @if (ChatMessage.State != ChatMessageCreationState.Complete)
                    {
                        <span class="state-indicator">
                            @if (ChatMessage.State == ChatMessageCreationState.InProgress)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Size="Size.Small"/>
                                <span>In progress</span>
                            }
                            else if (ChatMessage.State == ChatMessageCreationState.Failed)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small"/>
                                <span>Failed</span>
                            }
                        </span>
                    }
                </MudText>
            </div>
        </div>

    </div>
}
else
{
    <!-- Assistant/Other Message (Left-aligned) -->
    <div class="@wrapperClass">
        <div class="avatar-space-right">
            <div class="@GetAvatarClass()" title="@ChatMessage.UserFullName">
                @GetInitials()
            </div>
        </div>
        <div class="flex-grow-1">
            <div class="@GetBubbleClass()">
                <div class="message-content">
                    <RenderMultilineText Value="@GetFormattedMessageContent()" />

                    @if (_messageReferences.Any())
                    {
                        <div class="chat-message-attachments">
                            @foreach (var reference in _messageReferences)
                            {
                                <div class="chat-message-attachment-item">
                                    <span class="chat-message-attachment-number">[@reference.Number]</span>
                                    <MudIcon Icon="@GetReferenceIcon(reference.ReferenceType)" Size="Size.Small" Class="mx-1" />
                                    <span class="chat-message-attachment-name text-truncate">@reference.DisplayName</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="@GetMetaClass()">
                @if (ChatMessage is { Source: ChatMessageSource.Assistant, State: ChatMessageCreationState.InProgress } && _showTypingIndicator)
                {
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                }
                else
                {
                    <MudText Typo="Typo.caption">
                        @FormatDateTime(ChatMessage.CreatedUtc)
                        @if (ChatMessage.State != ChatMessageCreationState.Complete)
                        {
                            <span class="state-indicator">
                                @if (ChatMessage.State == ChatMessageCreationState.InProgress)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Size="Size.Small" />
                                    <span>In progress</span>
                                }
                                else if (ChatMessage.State == ChatMessageCreationState.Failed)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" />
                                    <span>Failed</span>
                                }
                            </span>
                        }
                    </MudText>
                }
            </div>
        </div>
    </div>

}