trigger: none

variables:
- group: greenlight-modern-integrationtest

stages:
- stage: publish
  displayName: Aspire Publish
  jobs:
  - job: publish
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '9.0.x'
    - script: |
        dotnet --info
        dotnet build src/Microsoft.Greenlight.slnx -v minimal
      displayName: Build
    - script: |
        curl -sSL https://aka.ms/install-aspire-cli | bash
      displayName: Install Aspire CLI
    - script: |
        build/scripts/build-modern-aspire-publish.sh out/publish
        # build/scripts/build-modern-patch-azure-names.sh out/publish  # DISABLED: Use consistent Aspire naming
      displayName: Aspire publish (legacy patching disabled)
    - publish: out/publish
      artifact: publish

- stage: deploy
  displayName: Deploy to IntegrationTest
  dependsOn: publish
  jobs:
  - deployment: deploy
    displayName: Azure + Helm Deploy
    environment: $(ENVIRONMENT_NAME)
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: publish
          - script: |
              az account set --subscription $(AZURE_SUBSCRIPTION_ID)
              build/scripts/build-modern-deploy-azure.sh $(Pipeline.Workspace)/publish $(AZURE_RESOURCE_GROUP) $(AZURE_LOCATION)
            displayName: Deploy Azure
          - script: |
              echo "Setting Kube context (assumes preconfigured service connection)"
              build/scripts/build-modern-helm-deploy.sh $(Pipeline.Workspace)/publish $(HELM_RELEASE) $(AKS_NAMESPACE)
            displayName: Deploy Helm