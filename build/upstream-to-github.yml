trigger:
  branches:
    include:
      - upstream # Specify the branch to trigger on

pool:
  #vmImage: "ubuntu-latest"
  name: "ipsenergy-v6ds-pool" # Use our internal pool for more consistent performance

variables:
  BRANCH_NAME: "adosync"
  NoChangesDetected: "false"

resources:
  repositories:
    - repository: github
      type: github
      name: Azure/AI-for-SMRs 
      endpoint: GitHubServiceConnection # We use a service connection to authenticate to GitHub. This doesn't work for GH cli unfortunately.

jobs:
  - job: SyncToGithub
    variables:
      - group: GitHubSecrets # Contains GIT_REPO_NAME (format: owner/repo) and other GitHub-related variables

    steps:
      # Step 1: Check out the current ADO repository
      - checkout: self
        persistCredentials: true
        displayName: "Checkout ADO Source"
        path: ado

      # Step 2: Check out the GitHub repository using the service connection
      - checkout: github
        persistCredentials: true
        displayName: "Checkout GitHub Repository"
        path: github

      # Step 3: Configure Git user
      - script: |
          echo "Configuring Git"
          git config --global user.name "ADO Upstream Sync"
          git config --global user.email "ado-bot@microsoft.com"
        displayName: "Configure Git Parameters"
        workingDirectory: $(Agent.BuildDirectory)/ado

      # Step 4: Detect relevant changes between ADO and GitHub (file-based)
      - script: |
          echo "Comparing file lists between ADO and GitHub"
          cd $(Agent.BuildDirectory)/ado
          git ls-tree -r --name-only HEAD | sort > /tmp/ado_files.txt
          cd $(Agent.BuildDirectory)/github
          git ls-tree -r --name-only HEAD | sort > /tmp/github_files.txt
          cd /tmp
          comm -3 ado_files.txt github_files.txt | grep -vE '^build/.*\.yml$|^src/NuGet\.config$|^docs/tasks/|^docs/agent-memory/|^AGENTS\.md$|^CLAUDE\.md$|copilot-instructions\.md$' > relevant_changes.txt || true

          echo "Relevant changes:"
          cat relevant_changes.txt || echo "None"

          if [ ! -s relevant_changes.txt ]; then
            echo "No relevant changes detected. Exiting."
            echo "##vso[task.setvariable variable=NoChangesDetected;]true"
            exit 0
          else
            echo "##vso[task.setvariable variable=NoChangesDetected;]false"
          fi

          rm -f ado_files.txt github_files.txt relevant_changes.txt
        displayName: "Check for Relevant Changes Compared to GitHub"
        workingDirectory: /tmp

      # Step 5: All further git operations are in the GitHub repo directory
      - script: |
          set -e
          cd $(Agent.BuildDirectory)/github

          # Create or reset adosync branch based on main
          git fetch origin
          git checkout origin/main
          git checkout -B adosync

          # Remove all files except .git and exclusions
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +

          # Copy in all files from the ADO repo (except exclusions)
          rsync -a \
            --exclude='.git' \
            --exclude='src/NuGet.config' \
            --exclude='src/Nuget.ADOArtifacts.config' \
            --exclude='build/*.yml' \
            --exclude='docs/tasks' \
            --exclude='docs/agent-memory' \
            --exclude='AGENTS.md' \
            --exclude='CLAUDE.md' \
            --exclude='**/copilot-instructions.md' \
            $(Agent.BuildDirectory)/ado/ ./

          # Remove excluded files again if needed
          rm -f src/NuGet.config src/Nuget.ADOArtifacts.config
          rm -f build/*.yml 2>/dev/null || true
          rm -f AGENTS.md CLAUDE.md
          rm -rf docs/tasks
          rm -rf docs/agent-memory
          find . -name "copilot-instructions.md" -delete 2>/dev/null || true

          # Do NOT remove .github/workflows or .github at all

          # Stage all changes except .github/workflows - github has protections in place for pushing these files in this way
          git add .
          git reset .github/workflows || true

          # If there are changes outside workflows, commit and push
          if git diff --cached --quiet; then
            echo "No changes to commit. Exiting gracefully."
            echo "##vso[task.setvariable variable=NoChangesDetected;]true"
            exit 0
          else
            echo "##vso[task.setvariable variable=NoChangesDetected;]false"
            git commit -m "Sync ADO to GitHub (excluding workflows)"
          fi
        displayName: "Sync ADO files into GitHub repo and commit (excluding workflows)"
        condition: eq(variables['NoChangesDetected'], 'false')
        workingDirectory: $(Agent.BuildDirectory)/github

      - script: |
          echo "Pushing adosync branch to GitHub"
          git push origin adosync:adosync --force
        displayName: "Push adosync Branch to GitHub"
        condition: eq(variables['NoChangesDetected'], 'false')
        workingDirectory: $(Agent.BuildDirectory)/github
