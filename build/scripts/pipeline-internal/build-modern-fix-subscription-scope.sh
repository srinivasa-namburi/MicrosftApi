#!/usr/bin/env bash
set -euo pipefail

# Fix subscription-scoped Bicep files generated by Aspire publish.
# Most customers only have resource group-level permissions, not subscription-level.
# This script converts subscription-scoped templates to resource group scope.
#
# Usage: build/scripts/build-modern-fix-subscription-scope.sh <publish-output-dir>

# Enable verbose output only if DEBUG is set
if [[ "${DEBUG:-}" == "true" ]]; then
  set -x
fi

OUT_DIR=${1:-out/publish}

echo ""
echo "[modern-scope-fix] Checking for subscription-scoped Bicep files in: $OUT_DIR"

# Find all bicep files using a more portable approach
BICEP_COUNT=0
BICEP_FILES_LIST=""

if [[ -d "$OUT_DIR" ]]; then
  while IFS= read -r -d '' bicep_file; do
    BICEP_FILES_LIST="$BICEP_FILES_LIST$bicep_file"$'\n'
    BICEP_COUNT=$((BICEP_COUNT + 1))
  done < <(find "$OUT_DIR" -type f -name "*.bicep" -print0 2>/dev/null || true)
fi

if [[ $BICEP_COUNT -eq 0 ]]; then
  echo "[modern-scope-fix] No Bicep files found."
  exit 0
fi

echo "[modern-scope-fix] Found $BICEP_COUNT Bicep files to check"

fixed_count=0

# Process each bicep file
while IFS= read -r bicep; do
  [[ -z "$bicep" ]] && continue
  [[ ! -f "$bicep" ]] && continue

  name="$(basename "$bicep")"
  echo "[modern-scope-fix] Checking: $name"

  # Special handling for main.bicep
  if [[ "$name" == "main.bicep" ]]; then
    needs_fixing=false

    # Check if it needs fixing using simple grep
    if grep -q "targetScope.*subscription" "$bicep" 2>/dev/null || \
       grep -q "^resource.*rg_" "$bicep" 2>/dev/null || \
       grep -q "scope:.*resource(" "$bicep" 2>/dev/null; then
      needs_fixing=true
    fi

    if [[ "$needs_fixing" == true ]]; then
      echo "[modern-scope-fix] Converting main.bicep from subscription to resource group scope"

      # Use sed for simple, reliable text processing
      tmp_file="${bicep}.tmp"

      # First pass: remove targetScope and resource group definitions
      sed '/targetScope.*subscription/d' "$bicep" > "$tmp_file.1"

      # Second pass: remove resource group resource blocks (simple approach)
      # Match both "resource rg" and "resource rg_*" patterns
      awk '
        /^resource (rg |rg_).*Microsoft\.Resources\/resourceGroups/ { skip=1; next }
        skip && /^}/ { skip=0; next }
        !skip { print }
      ' "$tmp_file.1" > "$tmp_file.2"

      # Third pass: fix scope references - use simpler patterns to avoid shell escaping issues
      # Replace any scope: resource(...) with scope: resourceGroup()
      # Also replace "scope: rg" with "scope: resourceGroup()" since rg resource is removed
      sed 's/scope: resource([a-zA-Z0-9_]*)/scope: resourceGroup()/g' "$tmp_file.2" | \
      sed 's/scope: resourceGroup(rg_[a-zA-Z0-9_]*)/scope: resourceGroup()/g' | \
      sed 's/scope: rg\b/scope: resourceGroup()/g' > "$tmp_file"

      # Clean up intermediate files
      rm -f "$tmp_file.1" "$tmp_file.2"

      # Replace original with fixed version
      mv "$tmp_file" "$bicep"

      fixed_count=$((fixed_count + 1))
      echo "[modern-scope-fix] Fixed main.bicep"
    fi
  else
    # For other bicep files, just remove subscription scope if present
    if grep -q "targetScope.*subscription" "$bicep" 2>/dev/null; then
      echo "[modern-scope-fix] Removing subscription scope from: $name"
      sed -i '/targetScope.*subscription/d' "$bicep"
      fixed_count=$((fixed_count + 1))
    fi
  fi
done <<< "$BICEP_FILES_LIST"

if [[ $fixed_count -gt 0 ]]; then
  echo "[modern-scope-fix] Fixed $fixed_count subscription-scoped Bicep files"
else
  echo "[modern-scope-fix] No subscription-scoped files found - all files already at resource group scope"
fi

echo "[modern-scope-fix] Scope fixing complete"