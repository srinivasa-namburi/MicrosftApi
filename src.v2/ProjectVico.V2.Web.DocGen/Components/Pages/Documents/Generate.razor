@attribute [Authorize]
@page "/generate"
@using ProjectVico.V2.Shared.Contracts.DTO
@using ProjectVico.V2.Web.Shared.ServiceClients
@using MassTransit.Configuration
@using Microsoft.Extensions.Options
@using ProjectVico.V2.Shared.Configuration
@using FluentValidation
@inject NavigationManager Navigation
@inject IDocumentGenerationApiClient DocumentGenerationApiClient
@inject IContentNodeApiClient ContentNodeApiClient
@inject IConfiguration Configuration
@inject IOptions<ServiceConfigurationOptions> ServiceConfigurationOptionsSelector


@code {
    private readonly DocumentGenerationRequest documentGenerationRequest = new DocumentGenerationRequest
    {
        Location = new LocationInformation
        {
            Latitude = 47.6740,
            Longitude = -122.1215,
        },
    };
    private bool showGeneratedDocument = false;
    private ServiceConfigurationOptions ServiceConfigurationOptions => ServiceConfigurationOptionsSelector.Value;

    private MudForm documentGenerationRequestForm;
    private DocumentGenerationRequestFluentValidator documentGenerationRequestValidator = new DocumentGenerationRequestFluentValidator();
    // This value will switch back to the simple, short form -- but none of the fields in the new form are required as of yet.
    private bool useSimpleForm = false;
}

<PageTitle>Generate Environmental Report</PageTitle>

<h1>Generate Environmental Report</h1>

<p>To start the document generation process, please fill in as much detail as you can about your project in the following form:</p>

@if (useSimpleForm)
{
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h6">
            Project Details
        </MudText>
        <MudTextField Label="Project Name" @bind-Value="documentGenerationRequest.DocumentTitle"
                      FullWidth></MudTextField>
        <MudTextField Label="Reactor Model" @bind-Value="documentGenerationRequest.ReactorModel"
                      FullWidth></MudTextField>
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   OnClick="ReportSubmitClick">Generate Report</MudButton>
    </MudPaper>
}
else
{

    <MudForm Model="@documentGenerationRequest" @ref="@documentGenerationRequestForm" Validation="@(documentGenerationRequestValidator.ValidateValue)" ValidationDelay="0">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Report Information</MudText>
                <MudTextField @bind-Value="documentGenerationRequest.DocumentTitle"
                              For="@(() => documentGenerationRequest.DocumentTitle)"
                              Immediate="true"
                              Label="Document title"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Enter a working title for your document." />
            </MudCardContent>
            <MudCardContent>
                <MudText Typo="Typo.h6">Plant Details</MudText>
                <MudTextField @bind-Value="documentGenerationRequest.PlantName"
                              For="@(() => documentGenerationRequest.PlantName)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Plant name"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Enter the full name of your plant (e.g., ABC Power Plant)." />

                <MapComponent 
                    @bind-DocumentGenerationRequestLocation="documentGenerationRequest.Location" />

                <MudSelect T="string" 
                    Label="Plant design" 
                    Variant="Variant.Filled" 
                    Margin="Margin.Normal" 
                    MultiSelection="true" 
                    @bind-SelectedValues="documentGenerationRequest.PlantDesign" 
                    AnchorOrigin="Origin.BottomCenter">
                    @foreach (var plantDesign in plantDesignTypes)
                    {
                        <MudSelectItem T="string" Value="@plantDesign">@plantDesign</MudSelectItem>
                    }
                </MudSelect>

                <MudTextField @bind-Value="documentGenerationRequest.OperatingHistory"
                              For="@(() => documentGenerationRequest.OperatingHistory)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Operating history"
                              Lines="4"
                              AutoGrow="true"
                              MaxLines="8"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Provide a brief history of your plant’s operation, including operational dates, outages, and any significant performance data." />
            </MudCardContent>
            <MudCardContent>
                <MudText Typo="Typo.h6">Proposed Changes</MudText>
                <MudTextField @bind-Value="documentGenerationRequest.ReactorModel"
                              For="@(() => documentGenerationRequest.ReactorModel)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Reactor model"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"  />

                <MudStack Row="true">
                    <MudDatePicker 
                        Label="Projected project start date" 
                        Editable="true" @bind-Value="documentGenerationRequest.ProjectedProjectStartDate" 
                        Variant="Variant.Filled" 
                        Margin="Margin.Normal" />
                    <MudDatePicker 
                        Label="Projected project end date" 
                        Editable="true" @bind-Value="documentGenerationRequest.ProjectedProjectEndDate" 
                        Variant="Variant.Filled" 
                        Margin="Margin.Normal" />
                </MudStack>


                <MudTextField @bind-Value="documentGenerationRequest.ModificationDescription"
                              For="@(() => documentGenerationRequest.ModificationDescription)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Modification description"
                              Lines="4"
                              AutoGrow="true"
                              MaxLines="8"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Describe the proposed changes in detail. Include the purpose, scope, and impact on safety, security, and environmental aspects." />

            </MudCardContent>
            <MudCardContent>
                <MudText Typo="Typo.h6">Licensee Information</MudText>
                <MudTextField @bind-Value="documentGenerationRequest.Name"
                              For="@(() => documentGenerationRequest.Name)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Name"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal" />

                <MudStack Row="true">
                    <MudTextField @bind-Value="documentGenerationRequest.Email"
                                  For="@(() => documentGenerationRequest.Email)"
                                  Immediate="true"
                                  OnlyValidateIfDirty="true"
                                  Label="Email"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Normal" />

                    <MudTextField @bind-Value="documentGenerationRequest.PhoneNumber"
                                  For="@(() => documentGenerationRequest.PhoneNumber)"
                                  Immediate="true"
                                  OnlyValidateIfDirty="true"
                                  Label="Phone number"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Normal" />
                </MudStack>

                <MudTextField @bind-Value="documentGenerationRequest.OrganizationalStructure"
                              For="@(() => documentGenerationRequest.OrganizationalStructure)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Organizational structure"
                              Lines="4"
                              AutoGrow="true"
                              MaxLines="8"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Describe the organizational structure of your company or organization. Include roles and responsibilities related to nuclear operations." />

                <MudSelect T="string" 
                    Label="Financial assurance" 
                    Variant="Variant.Filled" 
                    Margin="Margin.Normal" 
                    MultiSelection="false" 
                    @bind-SelectedValues="documentGenerationRequest.FinancialAssurance"
                           AnchorOrigin="Origin.BottomCenter"
                           HelperText="Select the type of financial assurance you have in place.">
                    @foreach (var financialAssurance in financialAssuranceTypes)
                    {
                        <MudSelectItem T="string" Value="@financialAssurance">@financialAssurance</MudSelectItem>
                    }
                </MudSelect>

                <MudTextField @bind-Value="documentGenerationRequest.ExperienceAndQualifications"
                              For="@(() => documentGenerationRequest.ExperienceAndQualifications)"
                              Immediate="true"
                              OnlyValidateIfDirty="true"
                              Label="Experience and qualifications"
                              Lines="4"
                              AutoGrow="true"
                              MaxLines="8"
                              Variant="Variant.Filled"
                              Margin="Margin.Normal"
                              HelperText="Describe the relevant expertise and qualifications of key personnel involved in nuclear operations." />
                @* <MudField Label="Your Label">
            <MudRadioGroup Label="Financial assurance" @bind-Value="@documentGenerationRequest.FinancialAssurance">
            <MudRadio Color="Color.Primary" Value="@("Self-assurance")">Self-assurance</MudRadio>
            <MudRadio Color="Color.Primary" Value="@("Third-party assurance")">Third-party assurance</MudRadio>
            </MudRadioGroup>
            </MudField>
            <MudRadioGroup Label="Financial assurance" @bind-Value="@documentGenerationRequest.FinancialAssurance">
            <MudRadio Color="Color.Primary" Value="@("Self-assurance")">Self-assurance</MudRadio>
            <MudRadio Color="Color.Primary" Value="@("Third-party assurance")">Third-party assurance</MudRadio>
            </MudRadioGroup> *@
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick=ReportSubmitClick>Generate Report</MudButton>
            </MudCardActions>
        </MudCard>
    </MudForm>


}

@code {

    private string[] financialAssuranceTypes =
    {
        "Self-assurance", "Third-party assurance"
    };

    private string[] plantDesignTypes =
    {
        "Light-water reactor", "Pressurized water reactor", "Boiling water reactor"
    };

    // ---------------------- BUTTON CLICKS ------------------------------------------------------------------------

    private async Task ReportSubmitClick()
    {
        showGeneratedDocument = true;
        documentGenerationRequest.Id = Guid.NewGuid();

        // Set the projected start date from the date picker (convert DateTime to DateOnly)

        if (string.IsNullOrEmpty(documentGenerationRequest.DocumentTitle))
        {
            documentGenerationRequest.DocumentTitle = $@"Environmental Report + {documentGenerationRequest.Id.ToString()}";
        }

        if (string.IsNullOrEmpty(documentGenerationRequest.ReactorModel))
        {
            documentGenerationRequest.ReactorModel = "N/A";
        }

        await DocumentGenerationApiClient.GenerateDocumentAsync(documentGenerationRequest);
        await InvokeAsync(StateHasChanged);

        Navigation.NavigateTo($"/docs/{documentGenerationRequest.Id}");
    }



    // ---------------------- INPUT VALIDATION ------------------------------------------------------------------------

    /// <summary>
    /// A standard AbstractValidator which contains multiple rules and can be shared with the back end API
    /// </summary>
    /// <typeparam name="DocumentGenerationRequest"></typeparam>
    public class DocumentGenerationRequestFluentValidator : AbstractValidator<DocumentGenerationRequest>
    {
        public DocumentGenerationRequestFluentValidator()
        {
            // Report Information rules
            RuleFor(x => x.DocumentTitle)
                .NotEmpty()
                .Length(1, 100)
                .WithName("Document title");

            // Plant Details rules
            RuleFor(x => x.PlantName)
                .NotEmpty();

            RuleFor(x => x.Name)
                .NotEmpty()
                .Length(1, 100);

            RuleFor(x => x.Email)
                .Cascade(CascadeMode.Stop)
                .NotEmpty()
                .EmailAddress()
                .MustAsync(async (value, cancellationToken) => await IsUniqueAsync(value));

            //  RuleFor(x => x.CCNumber)
            //  .NotEmpty()
            // .Length(1, 100)
            // .CreditCard();
        }

        private async Task<bool> IsUniqueAsync(string email)
        {
            // Simulates a long running http call
            await Task.Delay(2000);
            return email.ToLower() != "test@test.com";
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<DocumentGenerationRequest>.CreateWithOptions((DocumentGenerationRequest)model, x => x.IncludeProperties(propertyName)));
            if (result.IsValid)
                return Array.Empty<string>();
            return result.Errors.Select(e => e.ErrorMessage);
        };
    }


}
